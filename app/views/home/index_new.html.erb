<% content_for :extra_stylesheets do %>
  <style>
    /* Smooth scroll behavior */
    html {
      scroll-behavior: smooth;
      scroll-padding-top: 4rem;
    }

    /* Sticky navigation */
    #home-nav {
      position: sticky;
      position: -webkit-sticky;
      top: 0;
      z-index: 9999;
      background: white;
      width: 100%;
    }

    /* Lower z-index for charts */
    .chart-container,
    .highcharts-container,
    [data-controller="entries-chart"] {
      position: relative;
      z-index: 1 !important;
    }
  </style>
<% end %>

<!-- Enhanced Dashboard Header with Design System -->
<header class="bg-white shadow-sm border-b border-gray-200">
  <div class="w-full px-4 py-8 sm:px-6 lg:px-8">
    <div class="md:flex md:items-center md:justify-between">
      
      <!-- User Greeting with Avatar -->
      <div class="flex items-center gap-4 mb-2">
        <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white text-2xl font-bold shadow-lg">
          <%= current_user.email[0].upcase %>
        </div>
        <div>
          <h1 class="page-title">
            Hola, <%= current_user.email.split('@').first.capitalize %>
          </h1>
          <p class="page-subtitle mt-1">
            <%= Time.current.strftime("%A, %d de %B de %Y") %> • <%= @topicos.count %> <%= @topicos.count == 1 ? 'tema' : 'temas' %> bajo monitoreo
          </p>
        </div>
      </div>
      
      <!-- Status Badges -->
      <div class="mt-4 flex flex-wrap gap-2 md:mt-0 md:ml-4">
        <span class="badge badge-info">
          <svg class="-ml-0.5 mr-1.5 h-2 w-2" fill="currentColor" viewBox="0 0 8 8" aria-hidden="true">
            <circle cx="4" cy="4" r="3" />
          </svg>
          <%= @topicos.count %> Temas Activos
        </span>
        <span class="badge badge-success">
          <svg class="-ml-0.5 mr-1.5 h-2 w-2" fill="currentColor" viewBox="0 0 8 8" aria-hidden="true">
            <circle cx="4" cy="4" r="3" />
          </svg>
          Últimos <%=DAYS_RANGE%> días
        </span>
      </div>
    </div>
  </div>
</header>

<!-- Sticky Page Navigation -->
<nav id="home-nav" class="bg-white border-b border-gray-200 shadow-sm">
  <div class="w-full px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-12">
      <div class="flex items-center space-x-1 overflow-x-auto scrollbar-hide">
        <a href="#resumen" data-turbo="false" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors whitespace-nowrap">
          <i class="fa-solid fa-chart-bar w-4 mr-1.5"></i>
          Resumen 24h
        </a>
        <a href="#rendimiento" data-turbo="false" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors whitespace-nowrap">
          <i class="fa-solid fa-chart-line w-4 mr-1.5"></i>
          Rendimiento
        </a>
        <a href="#tendencias" data-turbo="false" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors whitespace-nowrap">
          <i class="fa-solid fa-chart-area w-4 mr-1.5"></i>
          Tendencias
        </a>
        <a href="#sentimiento" data-turbo="false" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors whitespace-nowrap">
          <i class="fa-solid fa-face-smile w-4 mr-1.5"></i>
          Sentimiento
        </a>
        <a href="#palabras" data-turbo="false" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors whitespace-nowrap">
          <i class="fa-solid fa-cloud w-4 mr-1.5"></i>
          Palabras Clave
        </a>
      </div>
      <a id="backToTop" class="ml-4 inline-flex items-center px-3 py-2 text-sm font-medium text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg transition-colors cursor-pointer whitespace-nowrap">
        <i class="fa-solid fa-arrow-up w-4 mr-1.5"></i>
        Arriba
      </a>
    </div>
  </div>
</nav>

<main class="bg-gray-50 min-h-screen">
  <div class="w-full py-8 px-4 sm:px-6 lg:px-8">
    
    <% if @entry_quantities.all? { |topic_data| topic_data[:data].empty? } %>
      <!-- Data Missing Alert - Using Design System Alert Class -->
      <div class="alert alert-warning mb-12 animate-fade-in">
        <div class="flex">
          <div class="flex-shrink-0">
            <i class="fa-solid fa-triangle-exclamation text-amber-500 text-xl"></i>
          </div>
          <div class="ml-4 flex-1">
            <h3 class="text-sm font-semibold text-amber-900">Datos estadísticos no disponibles</h3>
            <div class="mt-2 text-sm text-amber-800">
              <p class="mb-3">
                Las estadísticas del dashboard no están generadas. Para generar los datos, ejecuta el siguiente comando en el servidor:
              </p>
              <code class="block bg-amber-100 px-4 py-3 rounded-lg font-mono text-xs border border-amber-200">
                rails topic_stat_daily
              </code>
              <p class="mt-3">
                Este proceso calculará las estadísticas de los últimos <%= DAYS_RANGE %> días para todos tus temas activos.
              </p>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    
    <!-- Resumen Section - Enhanced Metric Cards -->
    <section id="resumen" class="mb-12 scroll-mt-16 animate-fade-in">
      <h2 class="section-title">Resumen de tus Temas - Últimas 24 Horas</h2>
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
        
        <!-- Metric Card 1 -->
        <div class="card-metric group">
          <div class="flex items-center justify-between mb-3">
            <dt class="metric-label text-gray-500">Nuevas Menciones</dt>
            <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200 transition-colors">
              <i class="fa-solid fa-newspaper text-indigo-600 text-xl"></i>
            </div>
          </div>
          <dd class="metric-value text-gray-900">
            <%= number_with_delimiter(@notas_ultimo_dia_topico.values.sum, delimiter: ".") %>
          </dd>
          <div class="mt-3 flex items-center text-sm <%= @notas_ultimo_dia_topico.values.sum > 0 ? 'text-green-600' : 'text-gray-500' %>">
            <% if @notas_ultimo_dia_topico.values.sum > 0 %>
              <i class="fa-solid fa-circle-check mr-1.5"></i>
              <span class="font-medium">Actividad detectada</span>
            <% else %>
              <i class="fa-solid fa-circle-xmark mr-1.5"></i>
              <span>Sin actividad reciente</span>
            <% end %>
          </div>
        </div>

        <!-- Metric Card 2 -->
        <div class="card-metric group">
          <div class="flex items-center justify-between mb-3">
            <dt class="metric-label text-gray-500">Interacciones</dt>
            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center group-hover:bg-blue-200 transition-colors">
              <i class="fa-solid fa-thumbs-up text-blue-600 text-xl"></i>
            </div>
          </div>
          <dd class="metric-value text-blue-600">
            <%= number_with_delimiter(@interacciones_ultimo_dia_topico.values.sum, delimiter: ".") %>
          </dd>
          <p class="mt-3 text-sm text-gray-600 font-medium">
            <i class="fa-solid fa-chart-line mr-1.5"></i>Alcance total
          </p>
        </div>

        <!-- Metric Card 3 -->
        <div class="card-metric group">
          <div class="flex items-center justify-between mb-3">
            <dt class="metric-label text-gray-500">Tema Más Activo</dt>
            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center group-hover:bg-purple-200 transition-colors">
              <i class="fa-solid fa-crown text-purple-600 text-xl"></i>
            </div>
          </div>
          <dd class="metric-value text-purple-600 text-2xl truncate" title="<%= @notas_ultimo_dia_topico.keys.first %>">
            <%= @notas_ultimo_dia_topico.keys.first || "N/A" %>
          </dd>
          <p class="mt-3 text-sm text-gray-600 font-medium">
            <i class="fa-solid fa-fire mr-1.5"></i><%= @notas_ultimo_dia_topico.values.first || 0 %> menciones
          </p>
        </div>

        <!-- Metric Card 4 -->
        <div class="card-metric group">
          <div class="flex items-center justify-between mb-3">
            <dt class="metric-label text-gray-500">Engagement Promedio</dt>
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center group-hover:bg-green-200 transition-colors">
              <i class="fa-solid fa-chart-simple text-green-600 text-xl"></i>
            </div>
          </div>
          <dd class="metric-value text-green-600">
            <%= @notas_ultimo_dia_topico.values.sum > 0 ? number_with_delimiter((@interacciones_ultimo_dia_topico.values.sum.to_f / @notas_ultimo_dia_topico.values.sum).round, delimiter: ".") : "0" %>
          </dd>
          <p class="mt-3 text-sm text-gray-600 font-medium">
            <i class="fa-solid fa-bullseye mr-1.5"></i>Por mención
          </p>
        </div>
      </div>
    </section>

    <!-- Quick Actions Section -->
    <section class="mb-12">
      <h2 class="section-title">Acciones Rápidas</h2>
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
        <% @topicos.limit(3).each do |topic| %>
          <div class="card-interactive group">
            <%= link_to topic_path(topic), class: "block focus:outline-none", 'aria-label': "Ver análisis completo del tema #{topic.name}" do %>
              <div class="flex items-center justify-between">
                <div class="flex items-center flex-1 min-w-0">
                  <div class="flex-shrink-0">
                    <div class="flex items-center justify-center w-12 h-12 bg-indigo-100 rounded-xl group-hover:bg-indigo-200 transition-colors">
                      <i class="fa-solid fa-chart-line text-indigo-600 text-xl"></i>
                    </div>
                  </div>
                  <div class="ml-4 flex-1 min-w-0">
                    <p class="card-title truncate"><%= topic.name %></p>
                    <p class="card-description">Ver análisis completo</p>
                  </div>
                </div>
                <i class="fa-solid fa-arrow-right text-gray-400 group-hover:text-indigo-600 transition-colors ml-2"></i>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </section>

    <!-- Rendimiento Section -->
    <section id="rendimiento" class="mb-12 scroll-mt-16">
      <div class="flex items-center justify-between mb-8">
        <h2 class="section-title mb-0">Rendimiento de tus Temas (24h)</h2>
        <% if @topicos.count > 5 %>
          <p class="text-sm text-gray-500 badge badge-default">
            Top 5 de <%= @topicos.count %> temas
          </p>
        <% end %>
      </div>
      
      <% if @notas_ultimo_dia_topico.any? %>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full">
          
          <!-- Chart Card 1 -->
          <div class="card-large hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h3 class="card-title">Menciones por Tema</h3>
                <p class="card-description">Últimas 24 horas</p>
              </div>
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-chart-bar text-blue-600"></i>
              </div>
            </div>
            <div class='w-full overflow-hidden'>
              <%= bar_chart @notas_ultimo_dia_topico.first(5).to_h, 
                  xtitle: "Tema", 
                  ytitle: "Menciones", 
                  thousands: ".", 
                  colors: ['#3B82F6'], 
                  library: {
                    plotOptions: {
                      series: {
                        dataLabels: { enabled: true }
                      }
                    }
                  } %>
            </div>
          </div>

          <!-- Chart Card 2 -->
          <div class="card-large hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h3 class="card-title">Engagement por Tema</h3>
                <p class="card-description">Interacciones totales</p>
              </div>
              <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-heart text-green-600"></i>
              </div>
            </div>
            <div class='w-full overflow-hidden'>
              <%= bar_chart @interacciones_ultimo_dia_topico.first(5).to_h, 
                  xtitle: "Tema", 
                  ytitle: "Interacciones", 
                  thousands: ".", 
                  colors: ['#10B981'], 
                  library: {
                    plotOptions: {
                      series: {
                        dataLabels: { enabled: true }
                      }
                    }
                  } %>
            </div>
          </div>
        </div>
      <% else %>
        <!-- Empty State -->
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fa-solid fa-chart-bar text-gray-400 text-2xl"></i>
          </div>
          <h3 class="empty-state-title">Sin actividad reciente</h3>
          <p class="empty-state-description">
            No se detectaron menciones de tus temas en las últimas 24 horas. Los datos se actualizarán automáticamente cuando haya nueva actividad.
          </p>
        </div>
      <% end %>
    </section>

    <!-- Continue with remaining sections... -->
    <%= render partial: 'home/trending_section', locals: { 
      entry_quantities: @entry_quantities,
      entry_interactions: @entry_interactions 
    } if defined?(@entry_quantities) %>

    <%= render partial: 'home/sentiment_section', locals: {
      positive_quantity: @positive_quantity,
      negative_quantity: @negative_quantity,
      neutral_quantity: @neutral_quantity
    } if defined?(@positive_quantity) %>

    <%= render partial: 'home/word_cloud_section', locals: {
      word_occurrences: @word_occurrences,
      positive_words: @positive_words,
      negative_words: @negative_words
    } if defined?(@word_occurrences) %>

    <%= render partial: 'home/newspapers_section', locals: {
      newspapers: @newspapers
    } if defined?(@newspapers) %>

  </div>
</main>

<script>
  // Back to Top functionality
  document.addEventListener('DOMContentLoaded', initBackToTop);
  document.addEventListener('turbo:load', initBackToTop);

  function initBackToTop() {
    const backToTopBtn = document.getElementById('backToTop');
    if (!backToTopBtn) return;
    
    if (backToTopBtn.dataset.initialized === 'true') return;
    backToTopBtn.dataset.initialized = 'true';
    
    backToTopBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }
</script>

