<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="//cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" crossorigin="anonymous">
<script src="//cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<header class="bg-white shadow-sm">
  <div class="mx-auto px-4 py-4 sm:px-6 lg:px-8">
    <h1 class="text-lg font-semibold leading-6 text-gray-900">Tópico: <%=@topic.name%></h1>
  </div>
</header>
<main>
  <div class="mx-auto py-8 sm:px-6 lg:px-8">
    <%= render partial: "tag/tag_entry", collection: @topic.tags %>
    <hr>
    <div class="m-2">
      <p class="mt-6 text-xl leading-8">El tópico <b><%=@topic.name%></b> en los ultimos <b><%=DAYS_RANGE%> días</b> cuenta con un total de <b><%=number_with_delimiter(@total_entries, delimiter: ".")%></b> notas y genero un total de <b><%=number_with_delimiter(@total_interactions, delimiter: '.')%></b> interacciones, lo que nos da un promedio de <b><%=number_with_delimiter(@promedio, delimiter: '.')%></b> interacciones por nota.</p>
      <p>En contexto las <%=@top_entries.count%> notas con más interacciones en general, en el mismo periodo tuvieron <b><%=@top_entries.pluck(:total_count).join(', ')%></b> interacciones y las notas del topico <b><%=@most_interactions.take(5).pluck(:total_count).join(', ')%></b> interaciones </p>
      <div class="mx-auto px-4 py-8 sm:px-6 sm:py-8  lg:px-8">
        <h2 class="text-2xl font-bold tracking-tight text-gray-900">Análisis del Tópico</h2>
        <p><%=@report.report_text.gsub("\n", "<br>").html_safe if @report%></p>
        <br>
        <p>Generado: <b><%=@report&.created_at%></b></p>
        <%=link_to "Ver más", topic_history_path(@topic), class: 'rounded bg-white px-2 py-1 text-xs font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50'%>
      </div>
    </div>
    <hr>
    <div class="mx-auto px-4 py-8 sm:px-6 sm:py-8 lg:px-8">
      <h2 class="text-2xl font-bold tracking-tight text-gray-900">Impacto del Tópico</h2>
      <h3>Cantidad de Notas del Topico: <%=number_with_delimiter(@entries.size, delimiter: ".")%>, demás notas: <%=number_with_delimiter(@all_entries.size, delimiter: ".")%>, total de notas: <%=number_with_delimiter(@all_entries.size + @entries.size, delimiter: ".")%></h3>
      <h3>Cantidad de Interacciones del Topico: <%=number_with_delimiter(@entries.sum(:total_count), delimiter: ".")%>, demás notas: <%=number_with_delimiter(@all_entries.sum(:total_count), delimiter: ".")%>, total de interacciones: <%=number_with_delimiter(@all_entries.sum(:total_count) + @entries.sum(:total_count), delimiter: ".")%></h3>
      <br>
      <div class="flex">
        <div class="w-1/2">
          <h3>Cantidad de Notas</h3>
          <%= pie_chart({"Topico" => @entries.size, "Otras" => @all_entries.size}, donut: true, label: "Notas", colors: ["green", "grey"]) %>
        </div>
        <div class="w-1/2">
          <h3>Cantidad de Interacciones</h3>
          <%= pie_chart({"Topico" => @entries.sum(:total_count), "Otras" => @all_entries.sum(:total_count)}, donut: true, label: "Interacciones", colors: ["yellow", "grey"]) %>
        </div>
      </div>
    </div>
    <hr>
    <div class="mx-auto px-4 py-8 sm:px-6 sm:py-8  lg:px-8">
      <h2 class="text-2xl font-bold tracking-tight text-gray-900">Análisis de Palabras:</h2>
      <%= render partial: "tag/tag_pill_array", collection: @word_occurrences %>
      <p><small class="text-muted px-1">*Cantidad de veces que aparecen las palabras en las notas</small></p>
    </div>
    <div class="mx-auto px-4 py-8 sm:px-6 sm:py-8  lg:px-8">
      <h2  class="text-2xl font-bold tracking-tight text-gray-900">Análisis de Bigramas:</h2>
      <%= render partial: "tag/tag_pill_array", collection: @bigram_occurrences %>
      <p><small class="text-muted px-1">*Cantidad de veces que aparecen bigramas en las notas</small></p>
    </div>
    <hr>
    <%= render partial: 'entry/entries', locals: { last_entries: @most_interactions, title: 'Top Notas Interacciones del Tópico' } %>
    <hr>
    <%= render partial: 'site/sites', locals: { sites: @entries.group("sites.name").count('*').sort_by { |site, count| -count }.take(10), title: 'Los medios que mas han mencionado' } %>
    <hr>
    <div class="mx-auto px-4 py-8 sm:px-6 sm:py-8  lg:px-8">
      <h3>Análisis de los últimos <%=DAYS_RANGE%> días</h3>
      <%= column_chart @entries.group_by_day(:published_at).count('*'), xtitle: "Fecha", ytitle: "Cant. Notas", label: "Notas", colors: ['blue'] %>
      <%= column_chart @entries.group_by_day(:published_at).sum(:total_count), xtitle: "Fecha", ytitle: "Interacciones", label: "Interacciones", colors: ['green']%>
    </div>
    <hr>
    <div class="mx-auto px-4 py-8 sm:px-6 sm:py-8 lg:px-8">
      <div class="flex">
        <div class="w-1/2">
          <h3>Cantidad de Notas por medio</h3>
          <%= pie_chart @entries.group("sites.name").count('*'), donut: true %>
        </div>
        <div class="w-1/2">
          <h3>Cantidad de Interacciones por medio</h3>
          <%= pie_chart @entries.group("sites.name").sum(:total_count), donut: true %>
        </div>
      </div>
    </div>
    <hr>
    <div class="mx-auto px-4 py-8 sm:px-6 sm:py-8 lg:px-8">
      <div class="flex">
        <div class="w-1/2">
          <h3>Cantidad de Notas por Tag Relacionados</h3>
          <%= pie_chart @tags_count, donut: true %>
        </div>
        <div class="w-1/2">
          <h3>Cantidad de Interacciones por Tag Relacionados</h3>
          <%= pie_chart @tags_interactions, donut: true %>
        </div>
      </div>
    </div>
    <% if @tags.any? %>
      <hr>
      <div class="mx-auto px-4 py-8 sm:px-6 sm:py-8 lg:px-8">
        <h2 class="text-2xl font-bold tracking-tight text-gray-900">Aparicion de Etiquetas:</h2>
        <%= render partial: "tag/tag_pill", collection: @tags %>
        <p><small class="text-muted px-1">*Cantidad de veces que aparecen las etiquetas en las notas</small></p>
      </div>
      <hr>
      <div class="mx-auto px-4 py-8 sm:px-6 sm:py-8 lg:px-8">
        <h2 class="text-2xl font-bold tracking-tight text-gray-900">Interacciones de Etiquetas:</h2>
        <%= render partial: "tag/tag_pill_interactions", collection: @tags.to_a.sort_by(&:interactions).reverse %>
        <p><small class="text-muted px-1">*Interacciones en las notas</small></p>
      </div>
    <%end%>
    <hr>
    <div class="mx-auto px-4 py-8 sm:px-6 sm:py-8 lg:px-8">
      <h2 class="text-2xl font-bold tracking-tight text-gray-900">Últimas Noticias sobre <%=@topic.name%></h2>
      <table id="entradas" class="min-w-full divide-y divide-gray-300">
        <thead>
          <tr>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Fecha</th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Imagen</th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Nota</th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Etiquetas</th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Medio</th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Reactions</th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Comments</th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Shares</th>
            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Total</th>
          </tr>
        </thead>
        <tbody class="bg-white">
          <% @entries.each do |entry| %>
            <tr class="even:bg-gray-50">
              <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500"><%=entry.published_at.strftime("%d/%m/%Y")%></td>
              <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500"><%=image_tag entry.clean_image, size: 200, loading: 'lazy', onerror: 'this.onerror=null;this.src="https://via.placeholder.com/300x250";'%></td>
              <td class="px-3 py-4 text-gray-500"><%=link_to entry.title, entry.url, target: '_blank'%> <i class="fa-solid fa-link"></i></td>
              <td class="px-3 py-4 text-xs text-gray-500"><%=entry.tag_list%></td>
              <td class="whitespace-nowrap px-3 py-4 text-xs text-gray-500"><%=link_to entry.site.name, site_path(entry.site)%></td>
              <td class="whitespace-nowrap px-3 py-4 text-lg text-gray-500"><%=entry.reaction_count%></td>
              <td class="whitespace-nowrap px-3 py-4 text-lg text-gray-500"><%=entry.comment_count%></td>
              <td class="whitespace-nowrap px-3 py-4 text-lg text-gray-500"><%=entry.share_count%></td>
              <td class="whitespace-nowrap px-3 py-4 text-lg text-gray-500"><%=entry.total_count%></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</main>
<script>
  $(document).ready( function () {
    new DataTable('#entradas', {
      paging: false
    });
  });
</script>
