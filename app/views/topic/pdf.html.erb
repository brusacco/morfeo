<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Reporte: <%= @topic.name %> - Morfeo Analytics</title>
    <!-- Chartkick for Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartkick@4.2.0/dist/chartkick.min.js"></script>
    
    <%# Auto-print on page load %>
    <script>
      window.onload = function() {
        window.print();
      };
    </script>
    
    <%# Include professional PDF styles %>
    <%= render 'shared/pdf_professional_styles' %>
    
    <style>
      /* Digital-specific PDF color overrides */
      h1, .pdf-page-title {
        color: #1e3a8a; /* Dark blue for digital */
      }
      
      /* Enhanced Header Styles */
      .pdf-header-enhanced {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        color: white;
        padding: 24pt 32pt;
        margin: -20pt -20pt 24pt -20pt;
        border-radius: 0;
        box-shadow: 0 4pt 12pt rgba(30, 58, 138, 0.2);
      }
      
      .pdf-header-title {
        margin: 0 0 12pt 0;
        font-size: 26pt;
        font-weight: 800;
        color: white !important;
        letter-spacing: -0.5pt;
        line-height: 1.2;
      }
      
      .pdf-header-meta {
        margin: 0;
        font-size: 11pt;
        font-weight: 500;
        opacity: 0.95;
        display: flex;
        align-items: center;
        gap: 8pt;
      }
      
      .pdf-header-meta-item {
        display: inline-flex;
        align-items: center;
        gap: 4pt;
      }
      
      .pdf-header-meta-separator {
        opacity: 0.6;
        font-weight: 300;
      }
      
      /* Enhanced KPI Cards */
      .pdf-metric-card {
        border: 2pt solid #e5e7eb !important;
        box-shadow: 0 2pt 8pt rgba(0, 0, 0, 0.08) !important;
        padding: 20pt !important;
      }
      
      .pdf-metric-icon {
        font-size: 32pt !important;
        line-height: 1 !important;
        margin-bottom: 12pt !important;
        display: block;
      }
      
      .pdf-metric-value {
        font-size: 32pt !important;
        font-weight: 900 !important;
        letter-spacing: -1pt !important;
        line-height: 1 !important;
        margin: 8pt 0 !important;
      }
      
      .pdf-metric-label {
        font-size: 9pt !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5pt !important;
        color: #6b7280 !important;
      }
    </style>
  </head>
  <body>
    <div class="pdf-container">
      <%# Professional Cover Page %>
      <%= render 'shared/pdf_cover_page',
            title: "Reporte Medios Digitales",
            topic_name: @topic.name,
            period: pdf_date_range(days_range: @days_range),
            report_type: :digital %>
      
      <%# Initialize Digital PDF Presenter %>
      <% @presenter = DigitalPdfPresenter.new(
            data: {
              topic_data: {
                entries_count: @entries_count,
                total_entries: @total_entries,
                entries_total_sum: @entries_total_sum,
                total_interactions: @total_interactions,
                entries_polarity_counts: @entries_polarity_counts,
                entries_polarity_sums: @entries_polarity_sums,
                site_counts: @site_counts,
                site_sums: @site_sums
              },
              chart_data: {
                chart_entries_counts: @chart_entries_counts,
                chart_entries_sums: @chart_entries_sums,
                chart_entries_sentiments_counts: @chart_entries_sentiments_counts,
                chart_entries_sentiments_sums: @chart_entries_sentiments_sums
              },
              tags_and_words: {
                tags_count: @tags_count,
                tags_interactions: @tags_interactions,
                word_occurrences: @word_occurrences,
                bigram_occurrences: @bigram_occurrences
              },
              percentages: {
                positives: @positives,
                neutrals: @neutrals,
                negatives: @negatives
              }
            },
            topic: @topic,
            days_range: @days_range
          ) %>

      <!-- Enhanced Header -->
      <div class="pdf-header-enhanced">
        <h1 class="pdf-header-title">Reporte Medios Digitales: <%= @topic.name %></h1>
        <p class="pdf-header-meta">
          <span class="pdf-header-meta-item">üìÖ <%= pdf_date_range(days_range: @days_range) %></span>
          <span class="pdf-header-meta-separator">|</span>
          <span class="pdf-header-meta-item">üïê Generado: <%= Time.current.strftime("%d/%m/%Y %H:%M") %></span>
        </p>
      </div>

      <!-- KPI Section (Using Presenter) -->
      <div class="pdf-section">
        <h2>M√©tricas Principales</h2>
        <%= render 'shared/pdf_kpis_grid', metrics: @presenter.kpi_metrics %>
      </div>

      <!-- Main Charts Section (Using Presenter) -->
      <div class="pdf-section">
        <h2>Evoluci√≥n Temporal</h2>
        <%= render 'shared/pdf_charts_row', 
              charts: [
                build_pdf_chart_config_enhanced(
                  title: "Notas por D√≠a",
                  data: @presenter.chart_entries_counts,
                  type: :column_chart,
                  xtitle: "Fecha",
                  ytitle: "Notas",
                  colors: ['#1e3a8a']
                ),
                build_pdf_chart_config_enhanced(
                  title: "Interacciones por D√≠a",
                  data: @presenter.chart_entries_sums,
                  type: :column_chart,
                  xtitle: "Fecha",
                  ytitle: "Interacciones",
                  colors: ['#10b981']
                )
              ] %>
      </div>

      <!-- Summary Section (Using Presenter) -->
      <div class="pdf-section">
        <div class="pdf-summary">
          <p>
            El t√≥pico <strong><%= @topic.name %></strong> en medios digitales durante los √∫ltimos 
            <strong><%= @days_range %></strong> d√≠as cuenta con un total de 
            <strong><%= @presenter.formatted_entries_count %></strong> notas publicadas que generaron 
            <strong><%= @presenter.formatted_interactions_count %></strong> interacciones totales.
          </p>
          <p class="mt-md">
            El alcance estimado es de <strong><%= @presenter.formatted_estimated_reach %></strong> personas.
            <%= @presenter.reach_methodology %>
            El promedio de interacciones por nota es de 
            <strong><%= @presenter.formatted_average_interactions %></strong>.
          </p>
        </div>
      </div>

      <!-- Sentiment Analysis Section (Using Presenter) -->
      <% if @presenter.has_sentiment_data? %>
        <div class="pdf-section">
          <h2>An√°lisis de Sentimiento</h2>
          
          <!-- Sentiment Overview -->
          <div class="pdf-stats-grid">
            <div class="pdf-stats-card">
              <div class="pdf-stats-label">Notas Positivas</div>
              <div class="pdf-stats-value" style="color: #10b981">
                <%= pdf_sentiment_emoji(1, system: :digital) %>
                <%= pdf_format_number(@presenter.positive_sentiment[:count]) %>
              </div>
              <div class="pdf-stats-sublabel">
                <%= pdf_format_number(@presenter.positive_sentiment[:interactions]) %> interacciones
              </div>
            </div>
            <div class="pdf-stats-card">
              <div class="pdf-stats-label">Notas Neutrales</div>
              <div class="pdf-stats-value" style="color: #6b7280">
                <%= pdf_sentiment_emoji(0, system: :digital) %>
                <%= pdf_format_number(@presenter.neutral_sentiment[:count]) %>
              </div>
              <div class="pdf-stats-sublabel">
                <%= pdf_format_number(@presenter.neutral_sentiment[:interactions]) %> interacciones
              </div>
            </div>
            <div class="pdf-stats-card">
              <div class="pdf-stats-label">Notas Negativas</div>
              <div class="pdf-stats-value" style="color: #ef4444">
                <%= pdf_sentiment_emoji(2, system: :digital) %>
                <%= pdf_format_number(@presenter.negative_sentiment[:count]) %>
              </div>
              <div class="pdf-stats-sublabel">
                <%= pdf_format_number(@presenter.negative_sentiment[:interactions]) %> interacciones
              </div>
            </div>
          </div>
          
          <!-- Sentiment Charts -->
          <% if @presenter.chart_sentiment_counts.present? && @presenter.chart_sentiment_sums.present? %>
            <%= render 'shared/pdf_charts_row',
                  charts: [
                    build_pdf_chart_config_enhanced(
                      title: "Notas por Sentimiento",
                      data: @presenter.chart_sentiment_counts,
                      type: :line_chart,
                      xtitle: "Fecha",
                      ytitle: "Notas",
                      colors: sentiment_colors
                    ),
                    build_pdf_chart_config_enhanced(
                      title: "Interacciones por Sentimiento",
                      data: @presenter.chart_sentiment_sums,
                      type: :line_chart,
                      xtitle: "Fecha",
                      ytitle: "Interacciones",
                      colors: sentiment_colors
                    )
                  ] %>
          <% end %>
        </div>
      <% end %>

      <!-- Sites Analysis Section (Using Presenter) -->
      <% if @presenter.has_site_data? %>
        <div class="pdf-section">
          <h2>An√°lisis de Medios</h2>
          
          <%= render 'shared/pdf_charts_row',
                charts: [
                  build_pdf_chart_config_enhanced(
                    title: "Notas por Medio",
                    data: @presenter.site_counts,
                    type: :pie_chart,
                    donut: true,
                    colors: ['#1e3a8a', '#F97316', '#10B981', '#F59E0B', '#EC4899']
                  ),
                  build_pdf_chart_config_enhanced(
                    title: "Interacciones por Medio",
                    data: @presenter.site_sums,
                    type: :pie_chart,
                    donut: true,
                    colors: ['#0284c7', '#6366F1', '#22C55E', '#D97706', '#EF4444']
                  )
                ] %>
          
          <!-- Top Sites List -->
          <h3>Medios Destacados</h3>
          <div class="pdf-media-list">
            <% @presenter.site_counts.take(12).each do |site_name, count| %>
              <div class="pdf-media-item">
                <div class="pdf-media-name"><%= site_name %></div>
                <div class="pdf-media-count">
                  <%= count %> notas ¬∑ 
                  <%= pdf_format_number(@presenter.site_sums[site_name] || 0) %> interacciones
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Tags Analysis Section (Using Presenter) -->
      <% if @presenter.has_tag_data? %>
        <div class="pdf-section">
          <h2>An√°lisis de Etiquetas</h2>
          <%= render 'shared/pdf_charts_row',
                charts: [
                  build_pdf_chart_config_enhanced(
                    title: "Notas por Etiqueta",
                    data: @presenter.tag_counts,
                    type: :pie_chart,
                    donut: true,
                    colors: ['#1e3a8a', '#8B5CF6', '#EC4899', '#14B8A6', '#F59E0B']
                  ),
                  build_pdf_chart_config_enhanced(
                    title: "Interacciones por Etiqueta",
                    data: @presenter.tag_interactions,
                    type: :pie_chart,
                    donut: true,
                    colors: ['#0284c7', '#7C3AED', '#D97706', '#0EA5E9', '#EF4444']
                  )
                ] %>
        </div>
      <% end %>

      <!-- Words Analysis Section (Using Presenter) -->
      <% if @presenter.has_word_data? %>
        <div class="pdf-section">
          <h2>An√°lisis de Palabras</h2>
          
          <h3>Palabras M√°s Frecuentes en Titulares</h3>
          <div class="pdf-words">
            <% @presenter.word_occurrences.take(50).each do |word, count| %>
              <span class="pdf-word"><%= word %> (<%= count %>)</span>
            <% end %>
          </div>
          
          <% if @presenter.has_bigram_data? %>
            <h3>Bigramas M√°s Frecuentes</h3>
            <div class="pdf-words">
              <% @presenter.bigram_occurrences.take(30).each do |bigram, count| %>
                <span class="pdf-word"><%= bigram %> (<%= count %>)</span>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Top Articles Section (Using Presenter) -->
      <% if @entries.present? %>
        <% top_entries = @presenter.top_entries(@entries, limit: 15) %>
        <% if top_entries.any? %>
          <div class="pdf-section break-before">
            <h2>Top Notas con M√°s Interacciones</h2>
            <% top_entries.each_with_index do |entry, index| %>
              <div class="pdf-post-item">
                <div class="pdf-post-header">
                  <span class="pdf-post-rank">#<%= index + 1 %></span>
                  <span class="pdf-post-page"><%= entry.site&.name || 'Unknown' %></span>
                  <span class="pdf-post-date"><%= entry.published_at&.strftime("%d/%m/%Y") %></span>
                  <span class="pdf-post-interactions">
                    <%= pdf_format_number(entry.total_count) %> interacciones
                  </span>
                </div>
                
                <% if entry.title.present? %>
                  <h4 class="pdf-post-title"><%= entry.title %></h4>
                <% end %>
                
                <% if entry.description.present? %>
                  <p class="pdf-post-message"><%= truncate(entry.description, length: 200) %></p>
                <% end %>
                
                <div class="pdf-post-metrics">
                  <span class="pdf-metric">‚ù§Ô∏è <strong><%= pdf_format_number(entry.reaction_count) %></strong> Reacciones</span>
                  <span class="pdf-metric">üí¨ <strong><%= pdf_format_number(entry.comment_count) %></strong> Comentarios</span>
                  <span class="pdf-metric">üîó <strong><%= pdf_format_number(entry.share_count) %></strong> Compartidos</span>
                </div>
                
                <% if entry.polarity %>
                  <div class="pdf-post-metrics" style="border-top: 1pt solid #e5e7eb; margin-top: 8pt; padding-top: 8pt;">
                    <span class="pdf-metric">
                      Sentimiento: 
                      <strong style="color: <%= entry.polarity == 1 || entry.polarity == 'positive' ? '#10b981' : entry.polarity == 2 || entry.polarity == 'negative' ? '#ef4444' : '#6b7280' %>">
                        <%= pdf_sentiment_emoji(entry.polarity, system: :digital) %>
                        <%= entry.polarity == 1 || entry.polarity == 'positive' ? 'Positivo' : entry.polarity == 2 || entry.polarity == 'negative' ? 'Negativo' : 'Neutral' %>
                      </strong>
                    </span>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>

      <!-- Footer -->
      <div class="pdf-report-footer">
        <span>Generado por Morfeo Analytics</span>
        <span><%= Time.current.strftime("%d/%m/%Y %H:%M") %></span>
        <span>Confidencial</span>
      </div>
    </div>
  </body>
</html>
