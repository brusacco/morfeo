<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Reporte Digital: <%= @topic.name %> - Morfeo Analytics</title>
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartkick@4.2.0/dist/chartkick.min.js"></script>

    <%# Auto-print on page load with 500ms delay for chart rendering %>
    <script>
      window.addEventListener('load', function() {
        setTimeout(function() {
          window.print();
        }, 500);
      });
    </script>
    
    <%# Include professional PDF styles %>
    <%= render 'shared/pdf_professional_styles' %>
    
    <style>
      /* =======================================
         DIGITAL PDF - A4 FORCED LAYOUT
         ======================================= */

      /* A4 Portrait: 210mm √ó 297mm
         Margins: 2cm top/bottom, 1.5cm left/right
         Content area: 18cm √ó 25.7cm (510pt √ó 729pt) */

      @page {
        size: A4 portrait;
        margin: 2cm 1.5cm 2cm 1.5cm;
      }

      /* Digital-specific color variables */
      :root {
        --digital-primary: #1e3a8a;
        --digital-secondary: #1e40af;
        --a4-content-height: 729pt; /* 25.7cm available height */
        --a4-content-width: 510pt;  /* 18cm available width */
      }

      /* Global container - strict A4 enforcement */
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        max-width: 21cm;
        overflow-x: hidden;
        box-sizing: border-box;
      }

      * {
        box-sizing: border-box;
      }

      /* ===== SLIDE HEIGHT CONTROL ===== */
      /* Each slide must fit in exactly 729pt (25.7cm) */

      .pdf-slide {
        max-height: 729pt !important;
        height: auto;
        padding: 24pt 20pt !important;
        overflow: hidden;
      }

      .pdf-slide-header {
        margin-bottom: 16pt !important;
      }

      .pdf-slide-title {
        font-size: 20pt !important;
        margin: 6pt 0 !important;
        line-height: 1.1 !important;
      }

      .pdf-slide-subtitle {
        font-size: 10pt !important;
        margin: 4pt 0 0 calc(12pt + 6pt) !important;
      }

      .pdf-slide-number-badge {
        width: 28pt !important;
        height: 28pt !important;
        line-height: 28pt !important;
        font-size: 12pt !important;
        margin-bottom: 8pt !important;
      }

      /* ===== KPI CARDS - Compact for 1 page ===== */

      .pdf-kpi-slide-grid {
        gap: 12pt !important;
        margin: 16pt 0 !important;
      }

      .pdf-kpi-slide-card {
        padding: 16pt !important;
        border: 1.5pt solid var(--color-gray-200) !important;
      }

      .pdf-kpi-slide-icon {
        font-size: 28pt !important;
        margin-bottom: 8pt !important;
      }

      .pdf-kpi-large .pdf-kpi-slide-value {
        font-size: 32pt !important;
        margin-bottom: 6pt !important;
      }

      .pdf-kpi-large .pdf-kpi-slide-label {
        font-size: 11pt !important;
        margin-bottom: 4pt !important;
      }

      .pdf-kpi-slide-sublabel {
        font-size: 7.5pt !important;
      }

      /* ===== CHARTS - Optimized heights ===== */

      div[style*="background: white"][style*="border: 2pt"] {
        padding: 14pt !important;
        border: 1.5pt solid #e5e7eb !important;
      }

      /* Chart headers - compact */
      h3[style*="font-size: 14pt"] {
        margin: 0 0 10pt 0 !important;
        font-size: 12pt !important;
        padding-left: 10pt !important;
        border-left: 3pt solid !important;
      }

      /* ===== NEWS/ENTRY CARDS - Vertical List Layout (8-10 entries per page) ===== */
      
      .entry-card {
        padding: 8pt 12pt !important;
        border: 1pt solid !important;
        border-radius: 6pt !important;
        margin-bottom: 8pt !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        display: flex !important;
        align-items: center !important;
        gap: 12pt !important;
      }

      /* Entry card ranking badge - smaller */
      .entry-card > div:first-child {
        flex: 0 0 auto !important;
      }

      .entry-card > div:first-child > span {
        width: 24pt !important;
        height: 24pt !important;
        font-size: 11pt !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      /* Entry card content area */
      .entry-card-content {
        flex: 1 !important;
        min-width: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 4pt !important;
      }

      /* Entry card header */
      .entry-card-header {
        display: flex !important;
        align-items: center !important;
        gap: 8pt !important;
      }

      /* Entry title - single line truncated */
      .entry-card h4 {
        margin: 0 !important;
        font-size: 7.5pt !important;
        line-height: 1.4 !important;
        color: #1f2937 !important;
        font-weight: 700 !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        max-width: 100% !important;
      }

      /* Entry description - single line truncated */
      .entry-card p {
        margin: 0 !important;
        font-size: 7pt !important;
        line-height: 1.4 !important;
        color: #6b7280 !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        max-width: 100% !important;
      }

      /* Entry metrics as inline text */
      .entry-card-metrics {
        display: flex !important;
        gap: 10pt !important;
        font-size: 6.5pt !important;
        color: #6b7280 !important;
        flex-wrap: wrap !important;
      }

      .entry-card-metrics span {
        display: inline-flex !important;
        align-items: center !important;
        gap: 3pt !important;
      }

      .entry-card-metrics strong {
        color: #1f2937 !important;
        font-weight: 700 !important;
      }

      /* ===== PRINT MEDIA RULES ===== */
      @media print {
        html, body {
          overflow-x: hidden !important;
          width: 100% !important;
          max-width: 21cm !important;
        }

        .pdf-slide {
          page-break-after: always;
        }

        .pdf-section-wrapper.force-new-page {
          page-break-before: always !important;
          break-before: page !important;
        }

        .entry-card {
          page-break-inside: avoid !important;
          break-inside: avoid !important;
        }
      }
      
      /* Digital-specific PDF color overrides */
      h1, .pdf-page-title {
        color: #1e3a8a; /* Dark blue for digital */
      }
      
      /* Enhanced KPI Cards */
      .pdf-metric-card {
        border: 2pt solid #e5e7eb !important;
        box-shadow: 0 2pt 8pt rgba(0, 0, 0, 0.08) !important;
        padding: 20pt !important;
      }
      
      .pdf-metric-icon {
        font-size: 32pt !important;
        line-height: 1 !important;
        margin-bottom: 12pt !important;
        display: block;
      }
      
      .pdf-metric-value {
        font-size: 32pt !important;
        font-weight: 900 !important;
        letter-spacing: -1pt !important;
        line-height: 1 !important;
        margin: 8pt 0 !important;
      }
      
      .pdf-metric-label {
        font-size: 9pt !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5pt !important;
        color: #6b7280 !important;
      }
    </style>
  </head>
  <body>
    <div class="pdf-container">
      <%# Professional Cover Page %>
      <%= render 'shared/pdf_cover_page',
            title: "Reporte Medios Digitales",
            topic_name: @topic.name,
            period: pdf_date_range(days_range: @days_range),
            report_type: :digital %>
      
      <%# Initialize Digital PDF Presenter %>
      <% @presenter = DigitalPdfPresenter.new(
            data: {
              topic_data: {
                entries_count: @entries_count,
                total_entries: @total_entries,
                entries_total_sum: @entries_total_sum,
                total_interactions: @total_interactions,
                entries_polarity_counts: @entries_polarity_counts,
                entries_polarity_sums: @entries_polarity_sums,
                site_counts: @site_counts,
                site_sums: @site_sums
              },
              chart_data: {
                chart_entries_counts: @chart_entries_counts,
                chart_entries_sums: @chart_entries_sums,
                chart_entries_sentiments_counts: @chart_entries_sentiments_counts,
                chart_entries_sentiments_sums: @chart_entries_sentiments_sums
              },
              tags_and_words: {
                tags_count: @tags_count,
                tags_interactions: @tags_interactions,
                word_occurrences: @word_occurrences,
                bigram_occurrences: @bigram_occurrences
              },
              percentages: {
                positives: @positives,
                neutrals: @neutrals,
                negatives: @negatives
              }
            },
            topic: @topic,
            days_range: @days_range
          ) %>

      <!-- Main KPI Section (Using Presenter) -->
      <%= render 'shared/pdf_section_wrapper', section_id: 'main-kpis', force_new_page: true do %>
        <%= render 'shared/pdf_slide',
              slide_number: 1,
              title: "M√©tricas Principales",
              subtitle: "Rendimiento General del Per√≠odo",
              report_type: :digital,
              topic_name: @topic.name do %>

          <%# KPIs en grid 2x2 para mejor visibilidad %>
          <%= render 'shared/pdf_kpi_slide',
              kpis: [
                {
                  value: @presenter.formatted_entries_count,
                  label: "Notas",
                  icon: "üì∞",
                  sublabel: "art√≠culos publicados"
                },
                {
                  value: @presenter.formatted_interactions_count,
                  label: "Interacciones",
                  icon: "üìä",
                  sublabel: "reacciones, comentarios, shares"
                },
                {
                  value: @presenter.formatted_estimated_reach,
                  label: "Alcance Est.",
                  icon: "üéØ",
                  sublabel: "lectores estimados (x3)"
                },
                {
                  value: @presenter.formatted_average_interactions,
                  label: "Promedio",
                  icon: "üìà",
                  sublabel: "interacciones por nota"
                }
              ],
              columns: 2,
              size: 'large' %>
        <% end %>
      <% end %>

      <!-- Temporal Evolution Section (Using Presenter) -->
      <%= render 'shared/pdf_section_wrapper', section_id: 'temporal-evolution', force_new_page: true do %>
        <%= render 'shared/pdf_slide',
              slide_number: 2,
              title: "Evoluci√≥n Temporal",
              subtitle: "Notas e Interacciones por D√≠a",
              report_type: :digital,
              topic_name: @topic.name do %>

        <%
          # Simple chart configuration (matching FB/TW PDF style)
          simple_chart_config = {
            height: '240px',
            library: {
              chart: { backgroundColor: 'transparent' },
              xAxis: { labels: { style: { fontSize: '9pt', fontWeight: '600' } } },
              yAxis: { labels: { style: { fontSize: '9pt', fontWeight: '600' } } }
            }
          }
        %>

        <%# Gr√°ficas apiladas verticalmente con configuraci√≥n optimizada %>
        <div style="display: flex; flex-direction: column; gap: 24pt;">
          <%# Notas por D√≠a %>
          <div>
            <h3 style="margin: 0 0 16pt 0; font-size: 14pt; font-weight: 700; color: #1f2937; padding-left: 12pt; border-left: 4pt solid #1e3a8a;">
              üìä Notas por D√≠a
            </h3>
            <div style="background: white; border: 2pt solid #e5e7eb; border-radius: 12pt; padding: 20pt; box-shadow: 0 2pt 8pt rgba(0, 0, 0, 0.06);">
              <%= column_chart @presenter.chart_entries_counts,
                    colors: ['#1e3a8a'],
                    **simple_chart_config %>
            </div>
            <p style="margin: 12pt 0 0 0; padding: 12pt 16pt; background: #eff6ff; border-left: 4pt solid #1e3a8a; border-radius: 6pt; font-size: 10pt; line-height: 1.6; color: #1e40af;">
              üí° Promedio de <strong><%= (@presenter.entries_count.to_f / @days_range).round(1) %></strong> notas por d√≠a durante el per√≠odo analizado.
            </p>
          </div>

          <%# Interacciones por D√≠a %>
          <div>
            <h3 style="margin: 0 0 16pt 0; font-size: 14pt; font-weight: 700; color: #1f2937; padding-left: 12pt; border-left: 4pt solid #10b981;">
              üëç Interacciones por D√≠a
            </h3>
            <div style="background: white; border: 2pt solid #e5e7eb; border-radius: 12pt; padding: 20pt; box-shadow: 0 2pt 8pt rgba(0, 0, 0, 0.06);">
              <%= column_chart @presenter.chart_entries_sums,
                    colors: ['#10b981'],
                    **simple_chart_config %>
            </div>
            <p style="margin: 12pt 0 0 0; padding: 12pt 16pt; background: #d1fae5; border-left: 4pt solid #10b981; border-radius: 6pt; font-size: 10pt; line-height: 1.6; color: #065f46;">
              üí° <%= @presenter.chart_entries_sums.values.max > @presenter.chart_entries_sums.values.min * 2 ? 'Alta variabilidad' : 'Consistencia' %> en las interacciones a lo largo del per√≠odo.
            </p>
          </div>
        </div>
      <% end %>
      <% end %>

      <!-- Summary Section (Using Presenter) -->
      <div class="pdf-section">
        <div class="pdf-summary">
          <p>
            El t√≥pico <strong><%= @topic.name %></strong> en medios digitales durante los √∫ltimos 
            <strong><%= @days_range %></strong> d√≠as cuenta con un total de 
            <strong><%= @presenter.formatted_entries_count %></strong> notas publicadas que generaron 
            <strong><%= @presenter.formatted_interactions_count %></strong> interacciones totales.
          </p>
          <p class="mt-md">
            El alcance estimado es de <strong><%= @presenter.formatted_estimated_reach %></strong> personas.
            <%= @presenter.reach_methodology %>
            El promedio de interacciones por nota es de 
            <strong><%= @presenter.formatted_average_interactions %></strong>.
          </p>
        </div>
      </div>

      <!-- Sentiment Analysis Section (Using Presenter) -->
      <% if @presenter.has_sentiment_data? %>
        <%= render 'shared/pdf_section_wrapper', section_id: 'sentiment-analysis' do %>
          <%= render 'shared/pdf_slide',
                slide_number: 'S1',
                title: "An√°lisis de Sentimiento",
                subtitle: "Percepci√≥n en Medios Digitales",
                report_type: :digital,
                topic_name: @topic.name do %>

            <%# KPIs de Sentimiento en grid 1x3 %>
            <%= render 'shared/pdf_kpi_slide',
                  kpis: [
                    {
                      value: pdf_format_number(@presenter.positive_sentiment[:count]),
                      label: "Notas Positivas",
                      icon: pdf_sentiment_emoji(1, system: :digital),
                      sublabel: "#{pdf_format_number(@presenter.positive_sentiment[:interactions])} interacciones"
                    },
                    {
                      value: pdf_format_number(@presenter.neutral_sentiment[:count]),
                      label: "Notas Neutrales",
                      icon: pdf_sentiment_emoji(0, system: :digital),
                      sublabel: "#{pdf_format_number(@presenter.neutral_sentiment[:interactions])} interacciones"
                    },
                    {
                      value: pdf_format_number(@presenter.negative_sentiment[:count]),
                      label: "Notas Negativas",
                      icon: pdf_sentiment_emoji(2, system: :digital),
                      sublabel: "#{pdf_format_number(@presenter.negative_sentiment[:interactions])} interacciones"
                    }
                  ],
                  columns: 3,
                  size: 'large' %>

            <%# Methodology Note %>
            <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 6pt solid #1e3a8a; border-radius: 12pt; padding: 16pt 20pt; margin-top: 20pt;">
              <h4 style="margin: 0 0 10pt 0; color: #1e40af; font-size: 12pt; display: flex; align-items: center; gap: 8pt;">
                <span style="font-size: 20pt;">üí°</span>
                ¬øC√≥mo medimos el sentimiento?
              </h4>
              <p style="margin: 0; font-size: 9pt; line-height: 1.6; color: #1e3a8a;">
                Analizamos autom√°ticamente el <strong>contenido de cada nota</strong> usando inteligencia artificial.
                El sistema clasifica cada art√≠culo como
                <span style="color: #10b981; font-weight: 700;">Positivo</span>,
                <span style="color: #6b7280; font-weight: 700;">Neutral</span> o
                <span style="color: #ef4444; font-weight: 700;">Negativo</span>
                seg√∫n el tono y las palabras utilizadas en el t√≠tulo y descripci√≥n.
              </p>
            </div>
          <% end %>
        <% end %>

        <%# SLIDE S2: Gr√°ficas de Sentimiento (una debajo de otra) %>
        <% if @presenter.chart_sentiment_counts.present? && @presenter.chart_sentiment_sums.present? %>
          <%= render 'shared/pdf_section_wrapper', section_id: 'sentiment-charts', force_new_page: true do %>
            <%= render 'shared/pdf_slide',
                  slide_number: 'S2',
                  title: "Evoluci√≥n de Sentimiento",
                  subtitle: "Tendencias en el Tiempo",
                  report_type: :digital,
                  topic_name: @topic.name do %>

              <%# Gr√°ficas apiladas verticalmente %>
              <div style="display: flex; flex-direction: column; gap: 24pt;">
                
                <%# Gr√°fica 1: Notas por Sentimiento %>
                <div style="background: white; border: 1pt solid #e5e7eb; border-radius: 8pt; padding: 16pt;">
                  <h3 style="margin: 0 0 12pt 0; font-size: 12pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #1e3a8a;">
                    üìä Notas por Sentimiento
                  </h3>
                  <%= line_chart @presenter.chart_sentiment_counts,
                        colors: ['#10b981', '#6b7280', '#ef4444'],
                        height: '180px',
                        library: {
                          chart: { backgroundColor: 'transparent' },
                          xAxis: { 
                            labels: { style: { fontSize: '9pt', fontWeight: '600' } },
                            title: { text: 'Fecha', style: { fontSize: '9pt', fontWeight: '700' } }
                          },
                          yAxis: { 
                            labels: { style: { fontSize: '9pt', fontWeight: '600' } },
                            title: { text: 'Cantidad de Notas', style: { fontSize: '9pt', fontWeight: '700' } }
                          },
                          legend: { 
                            itemStyle: { fontSize: '9pt', fontWeight: '600' }
                          }
                        } %>
                </div>

                <%# Gr√°fica 2: Interacciones por Sentimiento %>
                <div style="background: white; border: 1pt solid #e5e7eb; border-radius: 8pt; padding: 16pt;">
                  <h3 style="margin: 0 0 12pt 0; font-size: 12pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #10b981;">
                    üí¨ Interacciones por Sentimiento
                  </h3>
                  <%= line_chart @presenter.chart_sentiment_sums,
                        colors: ['#10b981', '#6b7280', '#ef4444'],
                        height: '180px',
                        library: {
                          chart: { backgroundColor: 'transparent' },
                          xAxis: { 
                            labels: { style: { fontSize: '9pt', fontWeight: '600' } },
                            title: { text: 'Fecha', style: { fontSize: '9pt', fontWeight: '700' } }
                          },
                          yAxis: { 
                            labels: { style: { fontSize: '9pt', fontWeight: '600' } },
                            title: { text: 'Total de Interacciones', style: { fontSize: '9pt', fontWeight: '700' } }
                          },
                          legend: { 
                            itemStyle: { fontSize: '9pt', fontWeight: '600' }
                          }
                        } %>
                </div>
              </div>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

      <%# SLIDE P1: Top Notas Positivas (P√°gina 1 - Notas 1-8) %>
      <% if @entries.present? %>
        <% 
          # Obtener notas positivas ordenadas por interacciones
          positive_entries = @entries.respond_to?(:relation) ? 
            @entries.relation.where(polarity: [1, 'positive']).order(total_count: :desc).limit(15) :
            @entries.select { |e| e.polarity == 1 || e.polarity == 'positive' }.sort_by { |e| -(e.total_count || 0) }.take(15)
        %>
        <% if positive_entries.any? %>
          <%= render 'shared/pdf_section_wrapper', section_id: 'positive-entries-1', force_new_page: true do %>
            <%= render 'shared/pdf_slide',
                  slide_number: 'P1',
                  title: "Notas M√°s Positivas",
                  subtitle: "Contenido con Mejor Recepci√≥n (1-8)",
                  report_type: :digital,
                  topic_name: @topic.name do %>

              <%# Lista vertical de notas (primeras 8 notas) %>
              <div style="display: flex; flex-direction: column;">
                <% positive_entries.take(8).each_with_index do |entry, index| %>
                  <div class="entry-card" style="background: white; border: 1pt solid #d1fae5; border-radius: 6pt;">
                    <%# Ranking badge %>
                    <div>
                      <span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 50%;">#<%= index + 1 %></span>
                    </div>

                    <%# Content area %>
                    <div class="entry-card-content">
                      <%# Header: Site name + Date + Sentiment %>
                      <div class="entry-card-header">
                        <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= entry.site&.name || 'Unknown' %></div>
                        <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                        <div style="font-size: 6.5pt; color: #9ca3af;"><%= entry.published_at&.strftime("%d/%m/%Y") %></div>
                        <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                        <div style="font-size: 7pt; color: #10b981; font-weight: 700;"><%= pdf_sentiment_emoji(entry.polarity, system: :digital) %> Positivo</div>
                      </div>

                      <%# Title - truncated single line %>
                      <% if entry.title.present? %>
                        <h4><%= entry.title %></h4>
                      <% end %>

                      <%# Description - truncated single line %>
                      <% if entry.description.present? %>
                        <p><%= entry.description %></p>
                      <% end %>

                      <%# Metrics as inline text %>
                      <div class="entry-card-metrics">
                        <span>‚ù§Ô∏è <strong><%= pdf_format_number(entry.reaction_count || 0) %></strong> reacciones</span>
                        <span>‚Ä¢</span>
                        <span>üí¨ <strong><%= pdf_format_number(entry.comment_count || 0) %></strong> comentarios</span>
                        <span>‚Ä¢</span>
                        <span>üîó <strong><%= pdf_format_number(entry.share_count || 0) %></strong> shares</span>
                        <span>‚Ä¢</span>
                        <span>üìä <strong><%= pdf_format_number(entry.total_count || 0) %></strong> total</span>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        <% end %>

        <%# SLIDE P2: Top Notas Positivas (P√°gina 2 - Notas 9-15) %>
        <% if positive_entries.to_a.size > 8 %>
          <%= render 'shared/pdf_section_wrapper', section_id: 'positive-entries-2', force_new_page: true do %>
            <%= render 'shared/pdf_slide',
                  slide_number: 'P2',
                  title: "Notas M√°s Positivas",
                  subtitle: "Contenido con Mejor Recepci√≥n (9-15)",
                  report_type: :digital,
                  topic_name: @topic.name do %>

              <%# Lista vertical de notas (notas 9-15) %>
              <div style="display: flex; flex-direction: column;">
                <% positive_entries.drop(8).take(7).each_with_index do |entry, index| %>
                  <div class="entry-card" style="background: white; border: 1pt solid #d1fae5; border-radius: 6pt;">
                    <%# Ranking badge %>
                    <div>
                      <span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 50%;">#<%= index + 9 %></span>
                    </div>

                    <%# Content area %>
                    <div class="entry-card-content">
                      <%# Header: Site name + Date + Sentiment %>
                      <div class="entry-card-header">
                        <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= entry.site&.name || 'Unknown' %></div>
                        <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                        <div style="font-size: 6.5pt; color: #9ca3af;"><%= entry.published_at&.strftime("%d/%m/%Y") %></div>
                        <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                        <div style="font-size: 7pt; color: #10b981; font-weight: 700;"><%= pdf_sentiment_emoji(entry.polarity, system: :digital) %> Positivo</div>
                      </div>

                      <%# Title - truncated single line %>
                      <% if entry.title.present? %>
                        <h4><%= entry.title %></h4>
                      <% end %>

                      <%# Description - truncated single line %>
                      <% if entry.description.present? %>
                        <p><%= entry.description %></p>
                      <% end %>

                      <%# Metrics as inline text %>
                      <div class="entry-card-metrics">
                        <span>‚ù§Ô∏è <strong><%= pdf_format_number(entry.reaction_count || 0) %></strong> reacciones</span>
                        <span>‚Ä¢</span>
                        <span>üí¨ <strong><%= pdf_format_number(entry.comment_count || 0) %></strong> comentarios</span>
                        <span>‚Ä¢</span>
                        <span>üîó <strong><%= pdf_format_number(entry.share_count || 0) %></strong> shares</span>
                        <span>‚Ä¢</span>
                        <span>üìä <strong><%= pdf_format_number(entry.total_count || 0) %></strong> total</span>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

      <%# SLIDE N1: Top Notas Negativas (P√°gina 1 - Notas 1-8) %>
      <% if @entries.present? %>
        <% 
          # Obtener notas negativas ordenadas por interacciones
          negative_entries = @entries.respond_to?(:relation) ? 
            @entries.relation.where(polarity: [2, 'negative']).order(total_count: :desc).limit(15) :
            @entries.select { |e| e.polarity == 2 || e.polarity == 'negative' }.sort_by { |e| -(e.total_count || 0) }.take(15)
        %>
        <% if negative_entries.any? %>
          <%= render 'shared/pdf_section_wrapper', section_id: 'negative-entries-1', force_new_page: true do %>
            <%= render 'shared/pdf_slide',
                  slide_number: 'N1',
                  title: "Notas M√°s Negativas",
                  subtitle: "Contenido con Mayor Cr√≠tica (1-8)",
                  report_type: :digital,
                  topic_name: @topic.name do %>

              <%# Lista vertical de notas (primeras 8 notas) %>
              <div style="display: flex; flex-direction: column;">
                <% negative_entries.take(8).each_with_index do |entry, index| %>
                  <div class="entry-card" style="background: white; border: 1pt solid #fee2e2; border-radius: 6pt;">
                    <%# Ranking badge %>
                    <div>
                      <span style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border-radius: 50%;">#<%= index + 1 %></span>
                    </div>

                    <%# Content area %>
                    <div class="entry-card-content">
                      <%# Header: Site name + Date + Sentiment %>
                      <div class="entry-card-header">
                        <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= entry.site&.name || 'Unknown' %></div>
                        <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                        <div style="font-size: 6.5pt; color: #9ca3af;"><%= entry.published_at&.strftime("%d/%m/%Y") %></div>
                        <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                        <div style="font-size: 7pt; color: #ef4444; font-weight: 700;"><%= pdf_sentiment_emoji(entry.polarity, system: :digital) %> Negativo</div>
                      </div>

                      <%# Title - truncated single line %>
                      <% if entry.title.present? %>
                        <h4><%= entry.title %></h4>
                      <% end %>

                      <%# Description - truncated single line %>
                      <% if entry.description.present? %>
                        <p><%= entry.description %></p>
                      <% end %>

                      <%# Metrics as inline text %>
                      <div class="entry-card-metrics">
                        <span>‚ù§Ô∏è <strong><%= pdf_format_number(entry.reaction_count || 0) %></strong> reacciones</span>
                        <span>‚Ä¢</span>
                        <span>üí¨ <strong><%= pdf_format_number(entry.comment_count || 0) %></strong> comentarios</span>
                        <span>‚Ä¢</span>
                        <span>üîó <strong><%= pdf_format_number(entry.share_count || 0) %></strong> shares</span>
                        <span>‚Ä¢</span>
                        <span>üìä <strong><%= pdf_format_number(entry.total_count || 0) %></strong> total</span>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        <% end %>

        <%# SLIDE N2: Top Notas Negativas (P√°gina 2 - Notas 9-15) %>
        <% if negative_entries.to_a.size > 8 %>
          <%= render 'shared/pdf_section_wrapper', section_id: 'negative-entries-2', force_new_page: true do %>
            <%= render 'shared/pdf_slide',
                  slide_number: 'N2',
                  title: "Notas M√°s Negativas",
                  subtitle: "Contenido con Mayor Cr√≠tica (9-15)",
                  report_type: :digital,
                  topic_name: @topic.name do %>

              <%# Lista vertical de notas (notas 9-15) %>
              <div style="display: flex; flex-direction: column;">
                <% negative_entries.drop(8).take(7).each_with_index do |entry, index| %>
                  <div class="entry-card" style="background: white; border: 1pt solid #fee2e2; border-radius: 6pt;">
                    <%# Ranking badge %>
                    <div>
                      <span style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border-radius: 50%;">#<%= index + 9 %></span>
                    </div>

                    <%# Content area %>
                    <div class="entry-card-content">
                      <%# Header: Site name + Date + Sentiment %>
                      <div class="entry-card-header">
                        <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= entry.site&.name || 'Unknown' %></div>
                        <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                        <div style="font-size: 6.5pt; color: #9ca3af;"><%= entry.published_at&.strftime("%d/%m/%Y") %></div>
                        <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                        <div style="font-size: 7pt; color: #ef4444; font-weight: 700;"><%= pdf_sentiment_emoji(entry.polarity, system: :digital) %> Negativo</div>
                      </div>

                      <%# Title - truncated single line %>
                      <% if entry.title.present? %>
                        <h4><%= entry.title %></h4>
                      <% end %>

                      <%# Description - truncated single line %>
                      <% if entry.description.present? %>
                        <p><%= entry.description %></p>
                      <% end %>

                      <%# Metrics as inline text %>
                      <div class="entry-card-metrics">
                        <span>‚ù§Ô∏è <strong><%= pdf_format_number(entry.reaction_count || 0) %></strong> reacciones</span>
                        <span>‚Ä¢</span>
                        <span>üí¨ <strong><%= pdf_format_number(entry.comment_count || 0) %></strong> comentarios</span>
                        <span>‚Ä¢</span>
                        <span>üîó <strong><%= pdf_format_number(entry.share_count || 0) %></strong> shares</span>
                        <span>‚Ä¢</span>
                        <span>üìä <strong><%= pdf_format_number(entry.total_count || 0) %></strong> total</span>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

      <!-- Sites Analysis Section (Using Presenter) -->
      <% if @presenter.has_site_data? %>
        <%= render 'shared/pdf_section_wrapper', section_id: 'sites-analysis' do %>
          <%= render 'shared/pdf_slide',
                slide_number: 'M1',
                title: "Medios Destacados",
                subtitle: "Distribuci√≥n de Notas e Interacciones por Medio",
                report_type: :digital,
                topic_name: @topic.name do %>

            <%# Lista de Medios con Rankings %>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20pt;">

              <%# Columna 1: Top Medios por Notas %>
              <div>
                <h3 style="margin: 0 0 16pt 0; font-size: 13pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #1e3a8a;">
                  üì∞ Top Medios por Notas
                </h3>

                <div style="display: flex; flex-direction: column; gap: 6pt;">
                  <% @presenter.site_counts.take(8).each_with_index do |(site_name, count), index| %>
                    <%
                      # Buscar el sitio para obtener el logo/image64
                      site = Site.find_by(name: site_name)
                    %>
                    <div class="fanpage-item" style="display: flex; align-items: center; gap: 8pt; padding: 6pt 10pt; background: white; border: 1pt solid #e5e7eb; border-radius: 6pt; min-height: 46pt; max-height: 46pt;">
                      <%# Ranking Badge %>
                      <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; width: 22pt; height: 22pt; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border-radius: 50%; font-size: 10pt; font-weight: 900;">
                        <%= index + 1 %>
                      </div>

                      <%# Logo/Avatar %>
                      <% if site&.image64.present? %>
                        <img src="<%= site.image64 %>"
                             style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; object-fit: cover; border: 2pt solid #e5e7eb;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); align-items: center; justify-content: center; font-size: 14pt; border: 2pt solid #93c5fd;">
                          üì∞
                        </div>
                      <% else %>
                        <div style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); display: flex; align-items: center; justify-content: center; font-size: 14pt; border: 2pt solid #93c5fd;">
                          üì∞
                        </div>
                      <% end %>

                      <%# Info %>
                      <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 700; font-size: 8pt; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin: 0;">
                          <%= site_name %>
                        </div>
                        <div style="font-size: 6.5pt; color: #6b7280; margin-top: 2pt; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                          Medio digital
                        </div>
                      </div>

                      <%# M√©trica %>
                      <div style="flex: 0 0 auto; text-align: center; padding: 5pt 8pt; background: #dbeafe; border-radius: 6pt; min-width: 55pt;">
                        <div style="font-size: 12pt; font-weight: 900; color: #1e3a8a; line-height: 1; margin: 0;">
                          <%= count %>
                        </div>
                        <div style="font-size: 6pt; color: #1e40af; text-transform: uppercase; font-weight: 600; margin-top: 2pt; line-height: 1;">
                          notas
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>

              <%# Columna 2: Top Medios por Interacciones %>
              <div>
                <h3 style="margin: 0 0 16pt 0; font-size: 13pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #10b981;">
                  üëç Top Medios por Interacciones
                </h3>

                <div style="display: flex; flex-direction: column; gap: 6pt;">
                  <% @presenter.site_sums.sort_by { |k, v| -v }.take(8).each_with_index do |(site_name, interactions), index| %>
                    <%
                      # Buscar el sitio para obtener el logo/image64
                      site = Site.find_by(name: site_name)
                    %>
                    <div class="fanpage-item" style="display: flex; align-items: center; gap: 8pt; padding: 6pt 10pt; background: white; border: 1pt solid #e5e7eb; border-radius: 6pt; min-height: 46pt; max-height: 46pt;">
                      <%# Ranking Badge %>
                      <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; width: 22pt; height: 22pt; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 50%; font-size: 10pt; font-weight: 900;">
                        <%= index + 1 %>
                      </div>

                      <%# Logo/Avatar %>
                      <% if site&.image64.present? %>
                        <img src="<%= site.image64 %>"
                             style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; object-fit: cover; border: 2pt solid #e5e7eb;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); align-items: center; justify-content: center; font-size: 14pt; border: 2pt solid #6ee7b7;">
                          üì∞
                        </div>
                      <% else %>
                        <div style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); display: flex; align-items: center; justify-content: center; font-size: 14pt; border: 2pt solid #6ee7b7;">
                          üì∞
                        </div>
                      <% end %>

                      <%# Info %>
                      <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 700; font-size: 8pt; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin: 0;">
                          <%= site_name %>
                        </div>
                        <div style="font-size: 6.5pt; color: #6b7280; margin-top: 2pt; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                          <%= @presenter.site_counts[site_name] || 0 %> notas
                        </div>
                      </div>

                      <%# M√©trica %>
                      <div style="flex: 0 0 auto; text-align: center; padding: 5pt 8pt; background: #d1fae5; border-radius: 6pt; min-width: 55pt;">
                        <div style="font-size: 12pt; font-weight: 900; color: #10b981; line-height: 1; margin: 0;">
                          <%= pdf_format_number(interactions) %>
                        </div>
                        <div style="font-size: 6pt; color: #059669; text-transform: uppercase; font-weight: 600; margin-top: 2pt; line-height: 1;">
                          interac.
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      <% end %>

      <!-- Tags Analysis Section (Using Presenter) -->
      <% if @presenter.has_tag_data? %>
        <%= render 'shared/pdf_section_wrapper', section_id: 'tags-analysis' do %>
          <%= render 'shared/pdf_slide',
                slide_number: 'T1',
                title: "An√°lisis por Etiquetas",
                subtitle: "Distribuci√≥n de Contenido por Tags",
                report_type: :digital,
                topic_name: @topic.name do %>

            <%# Lista de Etiquetas con Rankings %>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20pt;">

              <%# Columna 1: Top Etiquetas por Notas %>
              <div>
                <h3 style="margin: 0 0 16pt 0; font-size: 13pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #1e3a8a;">
                  üè∑Ô∏è Top Etiquetas por Notas
                </h3>

                <div style="display: flex; flex-direction: column; gap: 6pt;">
                  <% @presenter.tag_counts.take(8).each_with_index do |(tag_name, count), index| %>
                    <div class="tag-item" style="display: flex; align-items: center; gap: 8pt; padding: 6pt 10pt; background: white; border: 1pt solid #e5e7eb; border-radius: 6pt; min-height: 46pt; max-height: 46pt;">
                      <%# Ranking Badge %>
                      <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; width: 22pt; height: 22pt; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border-radius: 50%; font-size: 10pt; font-weight: 900;">
                        <%= index + 1 %>
                      </div>

                      <%# Tag Icon %>
                      <div style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); display: flex; align-items: center; justify-content: center; font-size: 14pt; border: 1.5pt solid #93c5fd; align-self: center; line-height: 1; padding: 0; margin: 0;">
                        üè∑Ô∏è
                      </div>

                      <%# Info %>
                      <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-weight: 700; font-size: 8pt; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin: 0;">
                          <%= tag_name %>
                        </div>
                        <div style="font-size: 6.5pt; color: #6b7280; margin-top: 2pt; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                          Etiqueta de contenido
                        </div>
                      </div>

                      <%# M√©trica %>
                      <div style="flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5pt 8pt; background: #dbeafe; border-radius: 6pt; min-width: 55pt;">
                        <div style="font-size: 12pt; font-weight: 900; color: #1e3a8a; line-height: 1; margin: 0;">
                          <%= count %>
                        </div>
                        <div style="font-size: 6pt; color: #1e40af; text-transform: uppercase; font-weight: 600; margin-top: 2pt; line-height: 1;">
                          notas
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>

              <%# Columna 2: Top Etiquetas por Interacciones %>
              <div>
                <h3 style="margin: 0 0 16pt 0; font-size: 13pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #10b981;">
                  üëç Top Etiquetas por Interacciones
                </h3>

                <div style="display: flex; flex-direction: column; gap: 6pt;">
                  <% @presenter.tag_interactions.sort_by { |k, v| -v }.take(8).each_with_index do |(tag_name, interactions), index| %>
                    <div class="tag-item" style="display: flex; align-items: center; gap: 8pt; padding: 6pt 10pt; background: white; border: 1pt solid #e5e7eb; border-radius: 6pt; min-height: 46pt; max-height: 46pt;">
                      <%# Ranking Badge %>
                      <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; width: 22pt; height: 22pt; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 50%; font-size: 10pt; font-weight: 900;">
                        <%= index + 1 %>
                      </div>

                      <%# Tag Icon %>
                      <div style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); display: flex; align-items: center; justify-content: center; font-size: 14pt; border: 1.5pt solid #6ee7b7; align-self: center; line-height: 1; padding: 0; margin: 0;">
                        üè∑Ô∏è
                      </div>

                      <%# Info %>
                      <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-weight: 700; font-size: 8pt; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin: 0;">
                          <%= tag_name %>
                        </div>
                        <div style="font-size: 6.5pt; color: #6b7280; margin-top: 2pt; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                          Etiqueta de contenido
                        </div>
                      </div>

                      <%# M√©trica %>
                      <div style="flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5pt 8pt; background: #d1fae5; border-radius: 6pt; min-width: 55pt;">
                        <div style="font-size: 12pt; font-weight: 900; color: #10b981; line-height: 1; margin: 0;">
                          <%= pdf_format_number(interactions) %>
                        </div>
                        <div style="font-size: 6pt; color: #059669; text-transform: uppercase; font-weight: 600; margin-top: 2pt; line-height: 1;">
                          interac.
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      <% end %>

      <!-- Words Analysis Section (Using Presenter) -->
      <% if @presenter.has_word_data? %>
        <%= render 'shared/pdf_section_wrapper', section_id: 'words-analysis' do %>
          <%= render 'shared/pdf_slide',
                slide_number: 'W1',
                title: "An√°lisis de Palabras",
                subtitle: "T√©rminos M√°s Frecuentes en Titulares",
                report_type: :digital,
                topic_name: @topic.name do %>

            <%# Lista de Palabras con Rankings %>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20pt;">

              <%# Columna 1: Top 8 Palabras Individuales %>
              <div>
                <h3 style="margin: 0 0 16pt 0; font-size: 13pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #1e3a8a;">
                  üí¨ Top Palabras
                </h3>

                <div style="display: flex; flex-direction: column; gap: 6pt;">
                  <% @presenter.word_occurrences.first(8).each_with_index do |word_data, index| %>
                    <% word, count = word_data %>
                    <div class="tag-item" style="display: flex; align-items: center; gap: 8pt; padding: 6pt 10pt; background: white; border: 1pt solid #e5e7eb; border-radius: 6pt; min-height: 46pt; max-height: 46pt;">
                      <%# Ranking Badge %>
                      <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; width: 22pt; height: 22pt; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border-radius: 50%; font-size: 10pt; font-weight: 900;">
                        <%= index + 1 %>
                      </div>

                      <%# Word Icon %>
                      <div style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); display: flex; align-items: center; justify-content: center; font-size: 14pt; border: 1.5pt solid #93c5fd; align-self: center; line-height: 1; padding: 0; margin: 0;">
                        üí¨
                      </div>

                      <%# Info %>
                      <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-weight: 700; font-size: 8pt; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin: 0;">
                          <%= word %>
                        </div>
                        <div style="font-size: 6.5pt; color: #6b7280; margin-top: 2pt; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                          Palabra clave
                        </div>
                      </div>

                      <%# M√©trica %>
                      <div style="flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5pt 8pt; background: #dbeafe; border-radius: 6pt; min-width: 55pt;">
                        <div style="font-size: 12pt; font-weight: 900; color: #1e3a8a; line-height: 1; margin: 0;">
                          <%= count %>
                        </div>
                        <div style="font-size: 6pt; color: #1e40af; text-transform: uppercase; font-weight: 600; margin-top: 2pt; line-height: 1;">
                          menciones
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>

              <%# Columna 2: Top 8 Bigramas (frases de 2 palabras) %>
              <% if @presenter.has_bigram_data? %>
                <div>
                  <h3 style="margin: 0 0 16pt 0; font-size: 13pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #10b981;">
                    üí¨üí¨ Top Frases
                  </h3>

                  <div style="display: flex; flex-direction: column; gap: 6pt;">
                    <% @presenter.bigram_occurrences.first(8).each_with_index do |bigram_data, index| %>
                      <% bigram, count = bigram_data %>
                      <div class="tag-item" style="display: flex; align-items: center; gap: 8pt; padding: 6pt 10pt; background: white; border: 1pt solid #e5e7eb; border-radius: 6pt; min-height: 46pt; max-height: 46pt;">
                        <%# Ranking Badge %>
                        <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; width: 22pt; height: 22pt; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 50%; font-size: 10pt; font-weight: 900;">
                          <%= index + 1 %>
                        </div>

                        <%# Bigram Icon %>
                        <div style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); display: flex; align-items: center; justify-content: center; font-size: 14pt; border: 1.5pt solid #6ee7b7; align-self: center; line-height: 1; padding: 0; margin: 0;">
                          üí¨
                        </div>

                        <%# Info %>
                        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center;">
                          <div style="font-weight: 700; font-size: 8pt; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin: 0;">
                            <%= bigram %>
                          </div>
                          <div style="font-size: 6.5pt; color: #6b7280; margin-top: 2pt; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            Frase com√∫n
                          </div>
                        </div>

                        <%# M√©trica %>
                        <div style="flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5pt 8pt; background: #d1fae5; border-radius: 6pt; min-width: 55pt;">
                          <div style="font-size: 12pt; font-weight: 900; color: #10b981; line-height: 1; margin: 0;">
                            <%= count %>
                          </div>
                          <div style="font-size: 6pt; color: #059669; text-transform: uppercase; font-weight: 600; margin-top: 2pt; line-height: 1;">
                            menciones
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      <% end %>

      <!-- Top Articles Section - P√°gina 1 (1-8 noticias) -->
      <% if @entries.present? %>
        <% top_entries = @presenter.top_entries(@entries, limit: 15) %>
        <% if top_entries.any? %>
          <%= render 'shared/pdf_section_wrapper', section_id: 'top-entries-1', force_new_page: true do %>
            <%= render 'shared/pdf_slide',
                  slide_number: 'E1',
                  title: "Top Notas con M√°s Interacciones",
                  subtitle: "Contenido de Mayor Impacto (1-8)",
                  report_type: :digital,
                  topic_name: @topic.name do %>

              <%# Lista vertical de noticias (primeras 8 noticias) %>
              <div style="display: flex; flex-direction: column;">
                <% top_entries.take(8).each_with_index do |entry, index| %>
                  <div class="entry-card" style="background: white; border: 1pt solid #e0e7ff; border-radius: 6pt;">
                    <%# Ranking badge %>
                    <div>
                      <span style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border-radius: 50%;">#<%= index + 1 %></span>
                    </div>

                    <%# Content area %>
                    <div class="entry-card-content">
                      <%# Header: Site name + Date %>
                      <div class="entry-card-header">
                        <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= entry.site&.name || 'Unknown' %></div>
                        <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                        <div style="font-size: 6.5pt; color: #9ca3af;"><%= entry.published_at&.strftime("%d/%m/%Y") %></div>
                        <% if entry.polarity %>
                          <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                          <div style="font-size: 7pt; font-weight: 700; color: <%= entry.polarity == 1 || entry.polarity == 'positive' ? '#10b981' : entry.polarity == 2 || entry.polarity == 'negative' ? '#ef4444' : '#6b7280' %>">
                            <%= pdf_sentiment_emoji(entry.polarity, system: :digital) %>
                          </div>
                        <% end %>
                      </div>

                      <%# Title - truncated single line %>
                      <% if entry.title.present? %>
                        <h4><%= entry.title %></h4>
                      <% end %>

                      <%# Description - truncated single line %>
                      <% if entry.description.present? %>
                        <p><%= entry.description %></p>
                      <% end %>

                      <%# Metrics as inline text %>
                      <div class="entry-card-metrics">
                        <span>‚ù§Ô∏è <strong><%= pdf_format_number(entry.reaction_count || 0) %></strong> reacciones</span>
                        <span>‚Ä¢</span>
                        <span>üí¨ <strong><%= pdf_format_number(entry.comment_count || 0) %></strong> comentarios</span>
                        <span>‚Ä¢</span>
                        <span>üîó <strong><%= pdf_format_number(entry.share_count || 0) %></strong> shares</span>
                        <span>‚Ä¢</span>
                        <span>üìä <strong><%= pdf_format_number(entry.total_count || 0) %></strong> total</span>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>

          <%# Top Articles Section - P√°gina 2 (9-15 noticias) - Solo si hay m√°s de 8 %>
          <% if top_entries.to_a.size > 8 %>
            <%= render 'shared/pdf_section_wrapper', section_id: 'top-entries-2', force_new_page: true do %>
              <%= render 'shared/pdf_slide',
                    slide_number: 'E2',
                    title: "Top Notas con M√°s Interacciones",
                    subtitle: "Contenido de Mayor Impacto (9-15)",
                    report_type: :digital,
                    topic_name: @topic.name do %>

                <%# Lista vertical de noticias (noticias 9-15) %>
                <div style="display: flex; flex-direction: column;">
                  <% top_entries.drop(8).take(7).each_with_index do |entry, index| %>
                    <div class="entry-card" style="background: white; border: 1pt solid #e0e7ff; border-radius: 6pt;">
                      <%# Ranking badge %>
                      <div>
                        <span style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border-radius: 50%;">#<%= index + 9 %></span>
                      </div>

                      <%# Content area %>
                      <div class="entry-card-content">
                        <%# Header: Site name + Date %>
                        <div class="entry-card-header">
                          <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= entry.site&.name || 'Unknown' %></div>
                          <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                          <div style="font-size: 6.5pt; color: #9ca3af;"><%= entry.published_at&.strftime("%d/%m/%Y") %></div>
                          <% if entry.polarity %>
                            <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                            <div style="font-size: 7pt; font-weight: 700; color: <%= entry.polarity == 1 || entry.polarity == 'positive' ? '#10b981' : entry.polarity == 2 || entry.polarity == 'negative' ? '#ef4444' : '#6b7280' %>">
                              <%= pdf_sentiment_emoji(entry.polarity, system: :digital) %>
                            </div>
                          <% end %>
                        </div>

                        <%# Title - truncated single line %>
                        <% if entry.title.present? %>
                          <h4><%= entry.title %></h4>
                        <% end %>

                        <%# Description - truncated single line %>
                        <% if entry.description.present? %>
                          <p><%= entry.description %></p>
                        <% end %>

                        <%# Metrics as inline text %>
                        <div class="entry-card-metrics">
                          <span>‚ù§Ô∏è <strong><%= pdf_format_number(entry.reaction_count || 0) %></strong> reacciones</span>
                          <span>‚Ä¢</span>
                          <span>üí¨ <strong><%= pdf_format_number(entry.comment_count || 0) %></strong> comentarios</span>
                          <span>‚Ä¢</span>
                          <span>üîó <strong><%= pdf_format_number(entry.share_count || 0) %></strong> shares</span>
                          <span>‚Ä¢</span>
                          <span>üìä <strong><%= pdf_format_number(entry.total_count || 0) %></strong> total</span>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

      <!-- Footer -->
      <div class="pdf-report-footer">
        <span>Generado por Morfeo Analytics</span>
        <span><%= Time.current.strftime("%d/%m/%Y %H:%M") %></span>
        <span>Confidencial</span>
      </div>
    </div>
  </body>
</html>
