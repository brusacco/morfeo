<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title><%= pdf_title(:general, @topic.name) %> - Morfeo Analytics</title>
    <!-- Chartkick for Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartkick@4.2.0/dist/chartkick.min.js"></script>
    
    <%= render 'shared/pdf_professional_styles' %>
    
    <style>
      /* General Dashboard Specific Styles */
      h1 {
        color: #8b5cf6; /* Purple for general dashboard */
      }
      
      .mt-lg {
        margin-top: 20pt;
      }
      
      .pdf-empty-state {
        border: 1pt dashed #d1d5db;
        border-radius: 4pt;
        background: #f9fafb;
      }
      
      .pdf-note {
        background: #eff6ff;
        border-left: 3pt solid #3b82f6;
        padding: 8pt 12pt;
        margin: 12pt 0;
        font-size: 9pt;
      }
      
      .pdf-badge {
        display: inline-block;
        padding: 2pt 6pt;
        border-radius: 3pt;
        font-size: 8pt;
        font-weight: 600;
      }
      
      .pdf-words {
        display: flex;
        flex-wrap: wrap;
        gap: 6pt;
        margin-top: 8pt;
      }
      
      .pdf-word {
        display: inline-block;
        padding: 4pt 8pt;
        background: #f3f4f6;
        border-radius: 3pt;
        font-size: 9pt;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="pdf-container">
      <%# Initialize General Dashboard Presenter %>
      <% @presenter ||= GeneralDashboardPresenter.new(
            data: @dashboard_data,
            topic: @topic,
            start_date: @start_date,
            end_date: @end_date
          ) %>

      <!-- Header -->
      <div class="pdf-header">
        <h1><%= pdf_title(:general, @topic.name) %></h1>
        <p style="font-size: 12pt; color: #6b7280; margin: 0;">
          <%= I18n.t('pdf.period.from_to', 
                from: @start_date.strftime('%d/%m/%Y'), 
                to: @end_date.strftime('%d/%m/%Y')) %>
        </p>
        <p style="font-size: 10pt; color: #9ca3af; margin: 4pt 0 0 0;">
          <%= I18n.t('pdf.footer.generated') %>: <%= Time.zone.now.strftime('%d/%m/%Y %H:%M') %>
        </p>
      </div>

      <!-- EXECUTIVE SUMMARY (Using Presenter) -->
      <div class="pdf-section">
        <h2><%= pdf_section_title(:executive_summary) %></h2>
        
        <%= render 'shared/pdf_kpis_grid', metrics: @presenter.kpi_metrics %>
        
        <!-- Executive Text Summary -->
        <div class="pdf-summary">
          <p>
            El t√≥pico <strong><%= @topic.name %></strong> registr√≥ un total de 
            <strong><%= @presenter.formatted_total_mentions %></strong> menciones
            con <strong><%= @presenter.formatted_total_interactions %></strong> interacciones,
            alcanzando un estimado de <strong><%= @presenter.formatted_total_reach %></strong> personas.
          </p>
          <p class="mt-md">
            El sentimiento general es <strong><%= @presenter.sentiment_text %></strong> 
            (<%= @presenter.formatted_average_sentiment %>), con una tendencia 
            <strong><%= @presenter.sentiment_trend_label %></strong>.
            El canal dominante es <strong><%= @presenter.dominant_channel_name %></strong>.
          </p>
        </div>
      </div>

      <!-- CHANNEL PERFORMANCE (Using Presenter) -->
      <div class="pdf-section">
        <h2>Rendimiento por Canal</h2>
        
        <table>
          <thead>
            <tr>
              <th>Canal</th>
              <th style="text-align: right;"><%= pdf_metric_label(:entries) %></th>
              <th style="text-align: right;"><%= pdf_metric_label(:interactions) %></th>
              <th style="text-align: right;"><%= pdf_metric_label(:reach) %></th>
            </tr>
          </thead>
          <tbody>
            <% @presenter.channel_performance_metrics.each do |channel| %>
              <tr>
                <td>
                  <span class="pdf-badge" style="background: <%= channel[:color] %>15; color: <%= channel[:color] %>;">
                    <%= channel[:channel] %>
                  </span>
                </td>
                <td style="text-align: right;"><%= pdf_format_number(channel[:mentions]) %></td>
                <td style="text-align: right;"><%= pdf_format_number(channel[:interactions]) %></td>
                <td style="text-align: right;"><%= pdf_format_number(channel[:reach]) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>

        <%= render 'shared/pdf_charts_row',
              charts: [
                build_pdf_chart_config(
                  title: "Menciones por Canal",
                  data: @presenter.channel_mentions_chart_data,
                  type: :pie_chart,
                  donut: true,
                  colors: [PdfConstants::DIGITAL_PRIMARY_COLOR, PdfConstants::FACEBOOK_PRIMARY_COLOR, PdfConstants::TWITTER_PRIMARY_COLOR]
                ),
                build_pdf_chart_config(
                  title: "Interacciones por Canal",
                  data: @presenter.channel_interactions_chart_data,
                  type: :pie_chart,
                  donut: true,
                  colors: [PdfConstants::DIGITAL_PRIMARY_COLOR, PdfConstants::FACEBOOK_PRIMARY_COLOR, PdfConstants::TWITTER_PRIMARY_COLOR]
                )
              ] %>
      </div>

      <!-- SENTIMENT ANALYSIS (Using Presenter) -->
      <div class="pdf-section break-before">
        <h2><%= pdf_section_title(:sentiment_analysis) %></h2>
        
        <div class="pdf-stats-grid">
          <div class="pdf-stats-card">
            <div class="pdf-stats-label">Sentimiento Promedio</div>
            <div class="pdf-stats-value" style="color: <%= @presenter.sentiment_color %>;">
              <%= @presenter.sentiment_emoji %> <%= @presenter.formatted_average_sentiment %>
            </div>
          </div>

          <div class="pdf-stats-card">
            <div class="pdf-stats-label">Menciones Positivas</div>
            <div class="pdf-stats-value" style="color: <%= PdfConstants::SENTIMENT_POSITIVE_COLOR %>;">
              <%= pdf_format_number(@presenter.positive_percentage) %>
            </div>
          </div>

          <div class="pdf-stats-card">
            <div class="pdf-stats-label">Menciones Neutrales</div>
            <div class="pdf-stats-value" style="color: <%= PdfConstants::SENTIMENT_NEUTRAL_COLOR %>;">
              <%= pdf_format_number(@presenter.neutral_percentage) %>
            </div>
          </div>

          <div class="pdf-stats-card">
            <div class="pdf-stats-label">Menciones Negativas</div>
            <div class="pdf-stats-value" style="color: <%= PdfConstants::SENTIMENT_NEGATIVE_COLOR %>;">
              <%= pdf_format_number(@presenter.negative_percentage) %>
            </div>
          </div>
        </div>

        <div class="pdf-chart-single" style="max-width: 50%; margin: 0 auto;">
          <%= pie_chart @presenter.sentiment_distribution_chart_data,
              donut: true,
              colors: PdfConstants::SENTIMENT_COLORS,
              library: { 
                chart: { height: 250 },
                plotOptions: { series: { dataLabels: { enabled: true } } }
              } %>
        </div>
      </div>

      <!-- REACH ANALYSIS (Using Presenter) -->
      <% if @presenter.reach_analysis.present? %>
        <div class="pdf-section">
          <h2>An√°lisis de Alcance</h2>
          
          <div class="pdf-stats-grid">
            <% @presenter.reach_breakdown.each do |item| %>
              <div class="pdf-stats-card">
                <div class="pdf-stats-label"><%= item[:channel] %></div>
                <div class="pdf-stats-value" style="color: <%= item[:color] %>;">
                  <%= pdf_format_number(item[:reach]) %>
                </div>
              </div>
            <% end %>
          </div>
          
          <div class="pdf-note">
            <p>
              <strong>Nota sobre alcance:</strong> Los datos de alcance de Facebook y Twitter provienen de APIs oficiales 
              (vistas reales). El alcance de medios digitales es una estimaci√≥n conservadora (3x las interacciones).
            </p>
          </div>
        </div>
      <% end %>

      <!-- TEMPORAL INTELLIGENCE (Using Presenter) -->
      <% if @presenter.temporal_intelligence.present? %>
        <div class="pdf-section">
          <h2>Inteligencia Temporal</h2>
          
          <div class="pdf-summary">
            <p><strong><%= @presenter.peak_hour_text %></strong></p>
            <p><strong><%= @presenter.peak_day_text %></strong></p>
          </div>
        </div>
      <% end %>

      <!-- COMPETITIVE ANALYSIS (Using Presenter) -->
      <% if @presenter.share_of_voice > 0 %>
        <div class="pdf-section">
          <h2>An√°lisis Competitivo</h2>
          
          <div class="pdf-stats-card" style="max-width: 300pt; margin: 0 auto;">
            <div class="pdf-stats-label">Share of Voice</div>
            <div class="pdf-stats-value" style="color: <%= @presenter.share_of_voice_status[:color] %>;">
              <%= @presenter.formatted_share_of_voice %>
            </div>
            <div class="pdf-stats-label" style="margin-top: 4pt;">
              <span class="pdf-badge" style="background: <%= @presenter.share_of_voice_status[:color] %>15; color: <%= @presenter.share_of_voice_status[:color] %>;">
                <%= @presenter.share_of_voice_status[:label] %>
              </span>
            </div>
          </div>
          
          <div class="pdf-chart-single" style="max-width: 50%; margin: 16pt auto 0;">
            <%= pie_chart @presenter.share_of_voice_chart_data,
                donut: true,
                colors: [PdfConstants::DIGITAL_PRIMARY_COLOR, '#e5e7eb'],
                library: { 
                  chart: { height: 200 },
                  plotOptions: { series: { dataLabels: { enabled: true } } }
                } %>
          </div>
        </div>
      <% end %>

      <!-- TOP CONTENT (Simplified for stability) -->
      <div class="pdf-section break-before">
        <h2>Contenido Destacado</h2>
        
        <!-- Top Digital Entries -->
        <% if @top_content && @top_content[:top_entries]&.any? %>
          <h3>Medios Digitales - Top <%= [@top_content[:top_entries].size, 10].min %></h3>
          <table>
            <thead>
              <tr>
                <th>T√≠tulo</th>
                <th>Fuente</th>
                <th style="text-align: right;">Interacciones</th>
              </tr>
            </thead>
            <tbody>
              <% @top_content[:top_entries].first(10).each do |entry| %>
                <tr>
                  <td><%= truncate(entry.title, length: 80) %></td>
                  <td><%= entry.site&.name || 'N/A' %></td>
                  <td style="text-align: right;"><%= pdf_format_number(entry.total_count || 0) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
        
        <!-- Top Facebook Posts -->
        <% if @top_content && @top_content[:top_facebook_posts]&.any? %>
          <h3 class="mt-lg">Facebook - Top <%= [@top_content[:top_facebook_posts].size, 10].min %></h3>
          <table>
            <thead>
              <tr>
                <th>Mensaje</th>
                <th>P√°gina</th>
                <th style="text-align: right;">Interacciones</th>
              </tr>
            </thead>
            <tbody>
              <% @top_content[:top_facebook_posts].first(10).each do |post| %>
                <tr>
                  <td><%= truncate(post.message.presence || 'Sin mensaje', length: 80) %></td>
                  <td><%= post.page&.name || 'N/A' %></td>
                  <td style="text-align: right;"><%= pdf_format_number(post.total_interactions || 0) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
        
        <!-- Top Twitter Posts -->
        <% if @top_content && @top_content[:top_tweets]&.any? %>
          <h3 class="mt-lg">Twitter - Top <%= [@top_content[:top_tweets].size, 10].min %></h3>
          <table>
            <thead>
              <tr>
                <th>Tweet</th>
                <th>Cuenta</th>
                <th style="text-align: right;">Interacciones</th>
              </tr>
            </thead>
            <tbody>
              <% @top_content[:top_tweets].first(10).each do |tweet| %>
                <tr>
                  <td><%= truncate(tweet.text, length: 80) %></td>
                  <td>@<%= tweet.twitter_profile&.username || 'N/A' %></td>
                  <td style="text-align: right;"><%= pdf_format_number(tweet.total_interactions || 0) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
        
        <!-- No Content Message -->
        <% unless (@top_content && (@top_content[:top_entries]&.any? || @top_content[:top_facebook_posts]&.any? || @top_content[:top_tweets]&.any?)) %>
          <div class="pdf-empty-state">
            <p style="text-align: center; color: #6b7280; padding: 40px;">
              üìä No hay contenido destacado disponible para este per√≠odo.
            </p>
          </div>
        <% end %>
      </div>

      <!-- WORD ANALYSIS (Using Presenter) -->
      <% if @presenter.has_word_analysis? %>
        <div class="pdf-section">
          <h2><%= pdf_section_title(:words_analysis) %></h2>
          
          <% if @presenter.top_words.any? %>
            <h3>Palabras M√°s Frecuentes</h3>
            <div class="pdf-words">
              <% @presenter.top_words.each do |word, count| %>
                <span class="pdf-word"><%= word %> (<%= count %>)</span>
              <% end %>
            </div>
          <% end %>
          
          <% if @presenter.top_bigrams.any? %>
            <h3>Bigramas M√°s Frecuentes</h3>
            <div class="pdf-words">
              <% @presenter.top_bigrams.each do |bigram, count| %>
                <span class="pdf-word"><%= bigram %> (<%= count %>)</span>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- RECOMMENDATIONS (Using Presenter) -->
      <% if @presenter.has_recommendations? %>
        <div class="pdf-section">
          <h2>Recomendaciones Estrat√©gicas</h2>
          
          <ul style="list-style-type: none; padding-left: 0;">
            <% @presenter.actionable_recommendations.each do |rec| %>
              <li style="margin-bottom: 8pt; padding-left: 16pt; position: relative;">
                <span style="position: absolute; left: 0; color: #f59e0b;">‚ö°</span>
                <strong><%= rec[:title] %>:</strong> <%= rec[:description] %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Footer -->
      <div class="pdf-footer">
        <p>
          <strong><%= I18n.t('pdf.footer.morfeo_analytics') %></strong> | Dashboard General Ejecutivo<br>
          <%= I18n.t('pdf.footer.generated') %> <%= Time.zone.now.strftime('%d de %B de %Y a las %H:%M') %><br>
          Confidencial - Solo para uso interno
        </p>
      </div>

    </div>

    <script>
      // Wait for charts to load before printing
      window.addEventListener('load', function() {
        setTimeout(function() {
          window.print();
        }, 2000);
      });
    </script>
  </body>
</html>
