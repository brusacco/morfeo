<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Reporte Facebook: <%= @topic.name %> - Morfeo Analytics</title>
    <!-- Chartkick for Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartkick@4.2.0/dist/chartkick.min.js"></script>
    
    <%# Auto-print on page load %>
    <script>
      window.onload = function() {
        window.print();
      };
    </script>
    
    <%# Include professional PDF styles %>
    <%= render 'shared/pdf_professional_styles' %>
    
    <style>
      /* Facebook-specific PDF color overrides */
      h1, .pdf-page-title {
        color: #1877f2; /* Facebook blue */
      }
      
      /* Enhanced Header Styles */
      .pdf-header-enhanced {
        background: linear-gradient(135deg, #1877f2 0%, #0c63d4 100%);
        color: white;
        padding: 24pt 32pt;
        margin: -20pt -20pt 24pt -20pt; /* Extend to edges */
        border-radius: 0;
        box-shadow: 0 4pt 12pt rgba(24, 119, 242, 0.2);
      }
      
      .pdf-header-title {
        margin: 0 0 12pt 0;
        font-size: 26pt;
        font-weight: 800;
        color: white !important;
        letter-spacing: -0.5pt;
        line-height: 1.2;
      }
      
      .pdf-header-meta {
        margin: 0;
        font-size: 11pt;
        font-weight: 500;
        opacity: 0.95;
        display: flex;
        align-items: center;
        gap: 8pt;
      }
      
      .pdf-header-meta-item {
        display: inline-flex;
        align-items: center;
        gap: 4pt;
      }
      
      .pdf-header-meta-separator {
        opacity: 0.6;
        font-weight: 300;
      }
      
      /* Enhanced KPI Cards */
      .pdf-metric-card {
        border: 2pt solid #e5e7eb !important;
        box-shadow: 0 2pt 8pt rgba(0, 0, 0, 0.08) !important;
        padding: 20pt !important;
        transition: all 0.3s ease;
      }
      
      .pdf-metric-icon {
        font-size: 32pt !important;
        line-height: 1 !important;
        margin-bottom: 12pt !important;
        display: block;
      }
      
      .pdf-metric-value {
        font-size: 32pt !important;
        font-weight: 900 !important;
        letter-spacing: -1pt !important;
        line-height: 1 !important;
        margin: 8pt 0 !important;
      }
      
      .pdf-metric-label {
        font-size: 9pt !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5pt !important;
        color: #6b7280 !important;
      }
    </style>
  </head>
  <body>
    <div class="pdf-container">
      <%# Professional Cover Page %>
      <%= render 'shared/pdf_cover_page',
            title: "Reporte Facebook",
            topic_name: @topic.name,
            period: pdf_date_range(days_range: @days_range),
            report_type: :facebook,
            subtitle: "An√°lisis de Reacciones y Sentimiento" %>
      
      <!-- Enhanced Header -->
      <div class="pdf-header-enhanced">
        <h1 class="pdf-header-title">Reporte Facebook: <%= @topic.name %></h1>
        <p class="pdf-header-meta">
          <span class="pdf-header-meta-item">üìÖ <%= pdf_date_range(days_range: @days_range) %></span>
          <span class="pdf-header-meta-separator">|</span>
          <span class="pdf-header-meta-item">üïê Generado: <%= Time.current.strftime("%d/%m/%Y %H:%M") %></span>
        </p>
      </div>

      <!-- KPI Section (Refactored) -->
      <div class="pdf-section">
        <h2>M√©tricas Principales</h2>
        <%= render 'shared/pdf_kpis_grid', 
              metrics: [
                { label: "Posts", value: pdf_format_number(@total_posts), icon: "üìù" },
                { label: "Interacciones", value: pdf_format_number(@total_interactions), icon: "üìä" },
                { label: "Vistas", value: pdf_format_number(@total_views), icon: "üëÅÔ∏è" },
                { label: "Promedio", value: pdf_format_number(@average_interactions), icon: "üìà" }
              ] %>
      </div>

      <!-- Main Charts Section (Enhanced) -->
      <div class="pdf-section">
        <h2>An√°lisis Temporal de Publicaciones</h2>
        <%= render 'shared/pdf_charts_row', 
              charts: [
                build_pdf_chart_config_enhanced(
                  title: "Posts por D√≠a",
                  data: @chart_posts,
                  type: :column_chart,
                  xtitle: "Fecha",
                  ytitle: "Posts",
                  colors: ['#1877f2']
                ),
                build_pdf_chart_config_enhanced(
                  title: "Interacciones por D√≠a",
                  data: @chart_interactions,
                  type: :column_chart,
                  xtitle: "Fecha",
                  ytitle: "Interacciones",
                  colors: ['#10b981']
                )
              ] %>
      </div>

      <!-- Summary Section -->
      <div class="pdf-section">
        <div class="pdf-summary">
          <p>
            El t√≥pico <strong><%= @topic.name %></strong> en Facebook durante los √∫ltimos 
            <strong><%= @days_range %> d√≠as</strong> cuenta con un total de 
            <strong><%= pdf_format_number(@total_posts) %></strong> publicaciones y gener√≥ un total de 
            <strong><%= pdf_format_number(@total_interactions) %></strong> interacciones, 
            lo que nos da un promedio de 
            <strong><%= pdf_format_number(@average_interactions) %></strong> interacciones por post.
          </p>
          <% if @total_views && @total_views > 0 %>
            <p class="mt-md">
              Las publicaciones alcanzaron un total de <strong><%= pdf_format_number(@total_views) %></strong> vistas
              (dato oficial de Meta API).
            </p>
          <% end %>
        </div>
      </div>

      <!-- Sentiment Analysis Section (Complete) -->
      <% if @sentiment_summary.present? %>
        <div class="pdf-section break-before">
          <h2>An√°lisis de Sentimiento (Basado en Reacciones)</h2>
          
          <% 
            presenter = FacebookSentimentPresenter.new(
              sentiment_summary: @sentiment_summary,
              sentiment_distribution: @sentiment_distribution,
              sentiment_over_time: @sentiment_over_time,
              reaction_breakdown: @reaction_breakdown,
              top_positive_posts: @top_positive_posts,
              top_negative_posts: @top_negative_posts,
              controversial_posts: @controversial_posts,
              emotional_trends: @emotional_trends
            ) 
          %>
          
          <% if presenter.has_data? %>
            <!-- Sentiment Overview -->
            <div class="pdf-stats-grid">
              <div class="pdf-stats-card">
                <div class="pdf-stats-label">Sentimiento Promedio</div>
                <div class="pdf-stats-value" style="color: <%= presenter.average_sentiment > 0 ? '#10b981' : presenter.average_sentiment < 0 ? '#ef4444' : '#6b7280' %>">
                  <%= pdf_sentiment_emoji(presenter.average_sentiment, system: :facebook) %>
                  <%= number_with_precision(presenter.average_sentiment, precision: 2) %>
                </div>
                <div class="pdf-stats-sublabel">
                  <%= presenter.average_sentiment > 0.5 ? 'Sentimiento Positivo' : presenter.average_sentiment < -0.5 ? 'Sentimiento Negativo' : 'Sentimiento Neutral' %>
                </div>
              </div>
              <% if presenter.has_validity_data? %>
                <div class="pdf-stats-card">
                  <div class="pdf-stats-label">Confianza Estad√≠stica</div>
                  <div class="pdf-stats-value">
                    <%= (presenter.overall_confidence * 100).round %>%
                  </div>
                  <div class="pdf-stats-sublabel">
                    <%= presenter.total_reactions %> reacciones analizadas
                  </div>
                </div>
              <% end %>
              <% if @controversial_posts.present? && @controversial_posts.any? %>
                <div class="pdf-stats-card">
                  <div class="pdf-stats-label">Posts Controvertidos</div>
                  <div class="pdf-stats-value" style="color: #f59e0b">
                    ‚ö†Ô∏è <%= @controversial_posts.size %>
                  </div>
                  <div class="pdf-stats-sublabel">
                    Alta polarizaci√≥n detectada
                  </div>
                </div>
              <% end %>
            </div>
            
            <!-- Sentiment Charts -->
            <% if presenter.has_time_series? %>
              <h3>Evoluci√≥n del Sentimiento</h3>
              <%= render 'shared/pdf_charts_row',
                    charts: [
                      build_pdf_chart_config(
                        title: "Score de Sentimiento (-2.0 a +2.0)",
                        data: @sentiment_over_time,
                        type: :line_chart,
                        xtitle: "Fecha",
                        ytitle: "Score",
                        colors: ['#8b5cf6'],
                        min: -2,
                        max: 2
                      )
                    ] %>
            <% end %>
            
            <!-- Sentiment Distribution -->
            <% if @sentiment_distribution.present? %>
              <h3>Distribuci√≥n de Sentimientos</h3>
              <%= render 'shared/pdf_charts_row',
                    charts: [
                      build_pdf_chart_config(
                        title: "Posts por Tipo de Sentimiento",
                        data: presenter.sentiment_distribution_data,
                        type: :pie_chart,
                        donut: true,
                        colors: ['#10b981', '#22c55e', '#6b7280', '#f59e0b', '#ef4444']
                      ),
                      build_pdf_chart_config(
                        title: "Desglose de Reacciones",
                        data: presenter.reaction_breakdown_data,
                        type: :column_chart,
                        colors: ['#1877f2', '#f43f5e', '#f59e0b', '#a855f7', '#3b82f6', '#10b981', '#ec4899']
                      )
                    ] %>
            <% end %>
            
            <!-- Summary Text -->
            <div class="pdf-summary">
              <p>
                <strong>Resumen del An√°lisis de Sentimiento:</strong>
                El sentimiento promedio es <%= presenter.average_sentiment > 0.5 ? 'positivo' : presenter.average_sentiment < -0.5 ? 'negativo' : 'neutral' %>. 
                El an√°lisis se basa en <strong><%= pdf_format_number(presenter.total_reactions) %></strong> reacciones 
                con una confianza estad√≠stica del <strong><%= (presenter.overall_confidence * 100).round %>%</strong>.
              </p>
              <% if @sentiment_distribution.present? %>
                <p class="mt-md">
                  La distribuci√≥n de posts muestra: 
                  <strong style="color: #10b981"><%= presenter.positive_percentage %>%</strong> positivos,
                  <strong style="color: #6b7280"><%= presenter.neutral_percentage %>%</strong> neutrales, y
                  <strong style="color: #ef4444"><%= presenter.negative_percentage %>%</strong> negativos.
                </p>
              <% end %>
            </div>
            
            <!-- Simplified Methodology Explanation -->
            <div class="pdf-note" style="background: #eff6ff; border-left: 4pt solid #3b82f6; padding: 12pt 16pt; margin: 16pt 0; border-radius: 6pt;">
              <h4 style="margin: 0 0 8pt 0; color: #1e40af; font-size: 11pt;">üí° ¬øC√≥mo medimos el sentimiento en Facebook?</h4>
              <p style="margin-bottom: 8pt; font-size: 9pt; line-height: 1.6;">
                Analizamos autom√°ticamente las <strong>reacciones</strong> que recibe cada post. 
                Cada tipo de reacci√≥n tiene un peso emocional:
              </p>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8pt; margin-bottom: 8pt;">
                <div style="padding: 6pt; background: #d1fae5; border-radius: 4pt;">
                  <strong style="color: #065f46;">üëç Like:</strong> <span style="font-size: 8pt;">+0.5 puntos</span>
                </div>
                <div style="padding: 6pt; background: #fce7f3; border-radius: 4pt;">
                  <strong style="color: #9f1239;">‚ù§Ô∏è Love:</strong> <span style="font-size: 8pt;">+2.0 puntos</span>
                </div>
                <div style="padding: 6pt; background: #fef3c7; border-radius: 4pt;">
                  <strong style="color: #92400e;">üòÑ Haha:</strong> <span style="font-size: 8pt;">+1.5 puntos</span>
                </div>
                <div style="padding: 6pt; background: #e0e7ff; border-radius: 4pt;">
                  <strong style="color: #3730a3;">üòÆ Wow:</strong> <span style="font-size: 8pt;">+1.0 punto</span>
                </div>
                <div style="padding: 6pt; background: #fed7aa; border-radius: 4pt;">
                  <strong style="color: #9a3412;">üò¢ Sad:</strong> <span style="font-size: 8pt;">-1.5 puntos</span>
                </div>
                <div style="padding: 6pt; background: #fee2e2; border-radius: 4pt;">
                  <strong style="color: #991b1b;">üò† Angry:</strong> <span style="font-size: 8pt;">-2.0 puntos</span>
                </div>
              </div>
              <p style="margin: 0; font-size: 9pt; line-height: 1.5;">
                <strong>Resultado:</strong> Un score entre <span style="color: #ef4444; font-weight: 600;">-2.0 (muy negativo)</span> y 
                <span style="color: #10b981; font-weight: 600;">+2.0 (muy positivo)</span>. 
                Un score cercano a <strong>0</strong> indica sentimiento neutral.
              </p>
            </div>
            
            <!-- Top Positive Posts -->
            <% if @top_positive_posts.present? && @top_positive_posts.any? %>
              <h3>Top 5 Posts M√°s Positivos</h3>
              <% @top_positive_posts.take(5).each_with_index do |post, index| %>
                <div class="pdf-post-item">
                  <div class="pdf-post-header">
                    <span class="pdf-post-rank">#<%= index + 1 %></span>
                    <span class="pdf-post-page"><%= post.page&.name || 'Unknown' %></span>
                    <span class="pdf-post-date"><%= post.posted_at&.strftime("%d/%m/%Y") %></span>
                    <span class="pdf-post-interactions" style="color: #10b981">
                      <%= pdf_sentiment_emoji(post.sentiment_score, system: :facebook) %>
                      Score: <%= number_with_precision(post.sentiment_score, precision: 2) %>
                    </span>
                  </div>
                  
                  <% if post.message.present? %>
                    <p class="pdf-post-message"><%= truncate(post.message, length: 200) %></p>
                  <% end %>
                  
                  <div class="pdf-post-metrics">
                    <span class="pdf-metric">‚ù§Ô∏è <%= pdf_format_number(post.reactions_total_count) %></span>
                    <span class="pdf-metric">üí¨ <%= pdf_format_number(post.comments_count) %></span>
                    <span class="pdf-metric">üîó <%= pdf_format_number(post.share_count) %></span>
                    <% if post.views_count && post.views_count > 0 %>
                      <span class="pdf-metric">üëÅÔ∏è <%= pdf_format_number(post.views_count) %></span>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
            
            <!-- Top Negative Posts -->
            <% if @top_negative_posts.present? && @top_negative_posts.any? %>
              <h3>Top 5 Posts M√°s Negativos</h3>
              <% @top_negative_posts.take(5).each_with_index do |post, index| %>
                <div class="pdf-post-item">
                  <div class="pdf-post-header">
                    <span class="pdf-post-rank">#<%= index + 1 %></span>
                    <span class="pdf-post-page"><%= post.page&.name || 'Unknown' %></span>
                    <span class="pdf-post-date"><%= post.posted_at&.strftime("%d/%m/%Y") %></span>
                    <span class="pdf-post-interactions" style="color: #ef4444">
                      <%= pdf_sentiment_emoji(post.sentiment_score, system: :facebook) %>
                      Score: <%= number_with_precision(post.sentiment_score, precision: 2) %>
                    </span>
                  </div>
                  
                  <% if post.message.present? %>
                    <p class="pdf-post-message"><%= truncate(post.message, length: 200) %></p>
                  <% end %>
                  
                  <div class="pdf-post-metrics">
                    <span class="pdf-metric">‚ù§Ô∏è <%= pdf_format_number(post.reactions_total_count) %></span>
                    <span class="pdf-metric">üí¨ <%= pdf_format_number(post.comments_count) %></span>
                    <span class="pdf-metric">üîó <%= pdf_format_number(post.share_count) %></span>
                    <% if post.views_count && post.views_count > 0 %>
                      <span class="pdf-metric">üëÅÔ∏è <%= pdf_format_number(post.views_count) %></span>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
            
            <!-- Controversial Posts -->
            <% if @controversial_posts.present? && @controversial_posts.any? %>
              <h3>Posts M√°s Controvertidos (Alta Polarizaci√≥n)</h3>
              <% @controversial_posts.take(3).each_with_index do |post, index| %>
                <div class="pdf-post-item" style="border-left: 3pt solid #f59e0b;">
                  <div class="pdf-post-header">
                    <span class="pdf-post-rank">‚ö†Ô∏è #<%= index + 1 %></span>
                    <span class="pdf-post-page"><%= post.page&.name || 'Unknown' %></span>
                    <span class="pdf-post-date"><%= post.posted_at&.strftime("%d/%m/%Y") %></span>
                    <span class="pdf-post-interactions" style="color: #f59e0b">
                      Controversia: <%= number_with_precision(post.controversy_index * 100, precision: 0) %>%
                    </span>
                  </div>
                  
                  <% if post.message.present? %>
                    <p class="pdf-post-message"><%= truncate(post.message, length: 200) %></p>
                  <% end %>
                  
                  <div class="pdf-post-metrics">
                    <span class="pdf-metric">‚ù§Ô∏è <%= pdf_format_number(post.reactions_total_count) %></span>
                    <span class="pdf-metric">üí¨ <%= pdf_format_number(post.comments_count) %></span>
                    <span class="pdf-metric">üîó <%= pdf_format_number(post.share_count) %></span>
                    <span class="pdf-metric" style="color: #f59e0b">
                      üî• <%= number_with_precision(post.emotional_intensity * 100, precision: 0) %>% emoci√≥n
                    </span>
                  </div>
                </div>
              <% end %>
            <% end %>
            
            <!-- Metodolog√≠a -->
            <div class="pdf-summary" style="background: #eff6ff; border-left: 3pt solid #3b82f6; padding: 8pt; margin-top: 12pt;">
              <p style="margin: 0; font-size: 9pt; color: #1e40af;">
                <strong>Nota sobre el an√°lisis de sentimiento:</strong>
                El sentimiento en Facebook se calcula usando un algoritmo ponderado basado en las reacciones:
                Love y Thankful (+2.0), Haha (+1.5), Like (+0.5), Wow (neutral), Sad (-1.5), Angry (-2.0).
                La confianza estad√≠stica aumenta con el n√∫mero de reacciones analizadas.
              </p>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Pages Analysis Section -->
      <% if @pages_count.present? && @pages_count.any? %>
        <div class="pdf-section">
          <h2>An√°lisis de Fanpages</h2>
          
          <%= render 'shared/pdf_charts_row',
                charts: [
                  build_pdf_chart_config(
                    title: "Posts por Fanpage",
                    data: @pages_count,
                    type: :pie_chart,
                    donut: true,
                    colors: ['#1877f2', '#F97316', '#10B981', '#F59E0B', '#EC4899']
                  ),
                  build_pdf_chart_config(
                    title: "Interacciones por Fanpage",
                    data: @pages_interactions,
                    type: :pie_chart,
                    donut: true,
                    colors: ['#0284c7', '#6366F1', '#22C55E', '#D97706', '#EF4444']
                  )
                ] %>
          
          <!-- Top Pages List -->
          <h3>Fanpages Destacadas</h3>
          <div class="pdf-media-list">
            <% @pages_count.take(12).each do |page_name, count| %>
              <div class="pdf-media-item">
                <div class="pdf-media-name"><%= page_name %></div>
                <div class="pdf-media-count">
                  <%= count %> posts ¬∑ 
                  <%= pdf_format_number(@pages_interactions[page_name] || 0) %> interacciones
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Tags Analysis Section -->
      <% if @tag_counts.present? && @tag_counts.any? %>
        <div class="pdf-section">
          <h2>An√°lisis de Etiquetas</h2>
          <%= render 'shared/pdf_charts_row',
                charts: [
                  build_pdf_chart_config(
                    title: "Posts por Etiqueta",
                    data: @tag_counts.map { |tag| [tag.name, tag.count] }.to_h,
                    type: :pie_chart,
                    donut: true,
                    colors: ['#1877f2', '#8B5CF6', '#EC4899', '#14B8A6', '#F59E0B']
                  ),
                  build_pdf_chart_config(
                    title: "Interacciones por Etiqueta",
                    data: @tag_interactions,
                    type: :pie_chart,
                    donut: true,
                    colors: ['#0284c7', '#7C3AED', '#D97706', '#0EA5E9', '#EF4444']
                  )
                ] %>
        </div>
      <% end %>

      <!-- Words Analysis Section -->
      <% if @word_occurrences.present? && @word_occurrences.any? %>
        <div class="pdf-section">
          <h2>An√°lisis de Palabras</h2>
          
          <h3>Palabras M√°s Frecuentes en Posts</h3>
          <div class="pdf-words">
            <% @word_occurrences.take(50).each do |word, count| %>
              <span class="pdf-word"><%= word %> (<%= count %>)</span>
            <% end %>
          </div>
          
          <% if @bigram_occurrences.present? && @bigram_occurrences.any? %>
            <h3>Bigramas M√°s Frecuentes</h3>
            <div class="pdf-words">
              <% @bigram_occurrences.take(30).each do |bigram, count| %>
                <span class="pdf-word"><%= bigram %> (<%= count %>)</span>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Top Posts Section -->
      <% if @top_posts.present? && @top_posts.any? %>
        <div class="pdf-section break-before">
          <h2>Top Posts con M√°s Interacciones</h2>
          <% @top_posts.take(10).each_with_index do |post, index| %>
            <div class="pdf-post-item">
              <div class="pdf-post-header">
                <span class="pdf-post-rank">#<%= index + 1 %></span>
                <span class="pdf-post-page"><%= post.page&.name || 'Unknown' %></span>
                <span class="pdf-post-date"><%= post.posted_at&.strftime("%d/%m/%Y") %></span>
                <span class="pdf-post-interactions">
                  <%= pdf_format_number(post.total_interactions) %> interacciones
                </span>
              </div>
              
              <% if post.message.present? %>
                <p class="pdf-post-message"><%= truncate(post.message, length: 300) %></p>
              <% end %>
              
              <div class="pdf-post-metrics">
                <span class="pdf-metric">‚ù§Ô∏è <strong><%= pdf_format_number(post.reactions_total_count) %></strong> Reacciones</span>
                <span class="pdf-metric">üí¨ <strong><%= pdf_format_number(post.comments_count) %></strong> Comentarios</span>
                <span class="pdf-metric">üîó <strong><%= pdf_format_number(post.share_count) %></strong> Compartidos</span>
                <% if post.views_count && post.views_count > 0 %>
                  <span class="pdf-metric">üëÅÔ∏è <strong><%= pdf_format_number(post.views_count) %></strong> Vistas</span>
                <% end %>
              </div>
              
              <% if post.sentiment_score %>
                <div class="pdf-post-metrics" style="border-top: 1pt solid #e5e7eb; margin-top: 8pt; padding-top: 8pt;">
                  <span class="pdf-metric">
                    Sentimiento: 
                    <strong style="color: <%= post.sentiment_score > 0 ? '#10b981' : post.sentiment_score < 0 ? '#ef4444' : '#6b7280' %>">
                      <%= pdf_sentiment_emoji(post.sentiment_score, system: :facebook) %>
                      <%= number_with_precision(post.sentiment_score, precision: 1) %>
                    </strong>
                  </span>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Footer -->
      <div class="pdf-report-footer">
        <span>Generado por Morfeo Analytics</span>
        <span><%= Time.current.strftime("%d/%m/%Y %H:%M") %></span>
        <span>Confidencial</span>
      </div>
    </div>
  </body>
</html>
