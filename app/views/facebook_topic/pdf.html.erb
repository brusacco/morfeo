<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Reporte Facebook: <%= @topic.name %> - Morfeo Analytics</title>
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartkick@4.2.0/dist/chartkick.min.js"></script>

    <%# Auto-print on page load with 500ms delay for chart rendering %>
    <script>
      window.addEventListener('load', function() {
        setTimeout(function() {
          window.print();
        }, 500);
      });
    </script>

    <%# Include professional PDF styles %>
    <%= render 'shared/pdf_professional_styles' %>

    <style>
      /* ======================================
         Facebook PDF - Exact A4 Page Fitting
         ======================================= */

      /* A4 Portrait: 210mm √ó 297mm
         Margins: 2cm top/bottom, 1.5cm left/right
         Content area: 18cm √ó 25.7cm (510pt √ó 729pt) */

      @page {
        size: A4 portrait;
        margin: 2cm 1.5cm 2cm 1.5cm;
      }

      /* Facebook-specific color variables */
      :root {
        --fb-primary: #1877f2;
        --fb-secondary: #0c63d4;
        --a4-content-height: 729pt; /* 25.7cm available height */
        --a4-content-width: 510pt;  /* 18cm available width */
      }

      /* Global container - strict A4 enforcement */
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        max-width: 21cm;
        overflow-x: hidden;
        box-sizing: border-box;
      }

      * {
        box-sizing: border-box;
      }

      /* ===== SLIDE HEIGHT CONTROL ===== */
      /* Each slide must fit in exactly 729pt (25.7cm) */

      .pdf-slide {
        max-height: 729pt !important;
        height: auto;
        padding: 24pt 20pt !important; /* Reduced from 48pt 16pt */
        overflow: hidden;
      }

      .pdf-slide-header {
        margin-bottom: 16pt !important; /* Reduced from 32pt */
      }

      .pdf-slide-title {
        font-size: 20pt !important; /* Reduced from 24pt */
        margin: 6pt 0 !important;
        line-height: 1.1 !important;
      }

      .pdf-slide-subtitle {
        font-size: 10pt !important; /* Reduced from 11pt */
        margin: 4pt 0 0 calc(12pt + 6pt) !important;
      }

      .pdf-slide-number-badge {
        width: 28pt !important; /* Reduced from 32pt */
        height: 28pt !important;
        line-height: 28pt !important;
        font-size: 12pt !important;
        margin-bottom: 8pt !important;
      }

      /* ===== KPI CARDS - Compact for 1 page ===== */

      .pdf-kpi-slide-grid {
        gap: 12pt !important; /* Reduced from 16pt */
        margin: 16pt 0 !important;
      }

      .pdf-kpi-slide-card {
        padding: 16pt !important; /* Reduced from 24pt */
        border: 1.5pt solid var(--color-gray-200) !important;
      }

      .pdf-kpi-slide-icon {
        font-size: 28pt !important; /* Reduced from 32pt */
        margin-bottom: 8pt !important;
      }

      .pdf-kpi-large .pdf-kpi-slide-value {
        font-size: 32pt !important; /* Reduced from 48pt */
        margin-bottom: 6pt !important;
      }

      .pdf-kpi-large .pdf-kpi-slide-label {
        font-size: 11pt !important;
        margin-bottom: 4pt !important;
      }

      .pdf-kpi-slide-sublabel {
        font-size: 7.5pt !important; /* Reduced from 8pt */
      }

      /* ===== CHARTS - Optimized heights ===== */

      .fb-chart-temporal-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 10pt 0 !important; /* Reduced from 16pt */
        width: 100%;
      }

      .fb-chart-temporal-wrapper {
        width: 100%;
        max-width: 680px;
        margin: 0 auto;
        padding: 14pt !important; /* Reduced from 20pt */
        border: 1.5pt solid #e5e7eb !important;
      }

      /* Chart headers - compact */
      .fb-chart-temporal-wrapper h3,
      h3.chart-title {
        margin: 0 0 10pt 0 !important; /* Reduced from 16pt */
        font-size: 12pt !important; /* Reduced from 14pt */
        padding-left: 10pt !important;
        border-left: 3pt solid !important;
      }

      /* Chart insight boxes - compact */
      .fb-chart-temporal-wrapper + p,
      p.chart-insight {
        margin: 8pt 0 0 0 !important; /* Reduced from 12pt */
        padding: 8pt 12pt !important; /* Reduced from 12pt 16pt */
        font-size: 9pt !important; /* Reduced from 10pt */
        line-height: 1.4 !important;
      }

      /* ===== SENTIMENT & REACTION CARDS - 2x2 Grid Compact ===== */

      .sentiment-card,
      .reaction-card {
        padding: 10pt 12pt !important; /* Reduced from 14pt 16pt */
        border: 1.5pt solid #e5e7eb !important;
        border-radius: 8pt !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }

      /* Card emoji icons */
      .sentiment-card > div > div:first-child > div:first-child,
      .reaction-card > div > div:first-child > div:first-child {
        width: 32pt !important; /* Reduced from 40pt */
        height: 32pt !important;
        font-size: 20pt !important; /* Reduced from 24pt */
      }

      /* Card titles */
      .sentiment-card div[style*="font-size: 12pt"],
      .reaction-card div[style*="font-size: 12pt"] {
        font-size: 11pt !important;
      }

      /* Card metrics */
      .sentiment-card div[style*="font-size: 24pt"],
      .reaction-card div[style*="font-size: 24pt"] {
        font-size: 20pt !important; /* Reduced from 24pt */
      }

      .sentiment-card div[style*="font-size: 16pt"],
      .reaction-card div[style*="font-size: 16pt"] {
        font-size: 14pt !important; /* Reduced from 16pt */
      }

      /* Card descriptions */
      .sentiment-card div[style*="font-size: 7pt"],
      .reaction-card div[style*="font-size: 7pt"] {
        font-size: 6.5pt !important;
      }

      /* ===== POST CARDS - Vertical List Layout (8-10 posts per page) ===== */

      .post-card {
        padding: 8pt 12pt !important;
        border: 1pt solid !important;
        border-radius: 6pt !important;
        margin-bottom: 8pt !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        display: flex !important;
        align-items: center !important;
        gap: 12pt !important;
      }

      /* Post card ranking badge - smaller */
      .post-card > div:first-child {
        flex: 0 0 auto !important;
      }

      .post-card > div:first-child > span {
        width: 24pt !important;
        height: 24pt !important;
        font-size: 11pt !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      /* Post card content area */
      .post-card-content {
        flex: 1 !important;
        min-width: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 4pt !important;
      }

      /* Post card header */
      .post-card-header {
        display: flex !important;
        align-items: center !important;
        gap: 8pt !important;
      }

      /* Post message - single line truncated */
      .post-card p {
        margin: 0 !important;
        font-size: 7pt !important;
        line-height: 1.4 !important;
        color: #6b7280 !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        max-width: 100% !important;
      }

      /* Post metrics as inline text */
      .post-card-metrics {
        display: flex !important;
        gap: 10pt !important;
        font-size: 6.5pt !important;
        color: #6b7280 !important;
        flex-wrap: wrap !important;
      }

      .post-card-metrics span {
        display: inline-flex !important;
        align-items: center !important;
        gap: 3pt !important;
      }

      .post-card-metrics strong {
        color: #1f2937 !important;
        font-weight: 700 !important;
      }

      /* ===== FANPAGE & TAG ITEMS - Fixed Height for Consistency ===== */

      .fanpage-item,
      .tag-item {
        padding: 6pt 10pt !important; /* Reducido de 8pt 12pt */
        gap: 8pt !important;
        margin-bottom: 6pt !important; /* Reducido de 8pt */
        border: 1pt solid #e5e7eb !important;
        border-radius: 6pt !important; /* Reducido de 8pt */
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        /* CRITICAL: Fixed height for all items */
        height: 46pt !important; /* Forzar altura exacta */
        min-height: 46pt !important; /* Reducido de 52pt */
        max-height: 46pt !important;
        display: flex !important;
        align-items: center !important;
        box-sizing: border-box !important; /* CR√çTICO: Incluir padding/border en altura */
        overflow: hidden !important; /* Evitar expansi√≥n */
      }

      /* Ranking badges - exact size */
      .fanpage-item > div:first-child,
      .tag-item > div:first-child {
        width: 22pt !important; /* Reducido de 24pt */
        height: 22pt !important;
        font-size: 10pt !important; /* Reducido de 11pt */
        flex-shrink: 0 !important;
        flex-grow: 0 !important; /* No crecer */
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      /* Avatar/Icon - exact size */
      .fanpage-item > div:nth-child(2),
      .tag-item > div:nth-child(2) {
        width: 28pt !important; /* Reducido de 32pt */
        height: 28pt !important;
        font-size: 14pt !important; /* Reducido de 16pt */
        flex-shrink: 0 !important;
        flex-grow: 0 !important; /* No crecer */
        /* CR√çTICO: Centrado perfecto con flexbox puro */
        display: flex !important;
        align-items: center !important; /* Centrar verticalmente */
        justify-content: center !important; /* Centrar horizontalmente */
        /* Resetear propiedades que pueden interferir */
        line-height: 1 !important; /* L√≠nea de altura m√≠nima */
        padding: 0 !important;
        margin: 0 !important;
        align-self: center !important; /* Centrar el c√≠rculo dentro del card */
      }

      .fanpage-item img {
        width: 28pt !important; /* Reducido de 32pt */
        height: 28pt !important;
      }

      /* Text content - controlled height */
      .fanpage-item div[style*="flex: 1"],
      .tag-item div[style*="flex: 1"] {
        flex: 1 !important;
        min-width: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        overflow: hidden !important;
      }

      .fanpage-item div[style*="font-size: 10pt"],
      .tag-item div[style*="font-size: 10pt"] {
        font-size: 8pt !important; /* Reducido de 9pt */
        line-height: 1.2 !important;
        margin: 0 !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }

      .fanpage-item div[style*="font-size: 8pt"],
      .tag-item div[style*="font-size: 8pt"] {
        font-size: 6.5pt !important; /* Reducido de 7pt */
        line-height: 1.2 !important;
        margin-top: 2pt !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }

      /* Metrics - exact size */
      .fanpage-item div[style*="font-size: 16pt"],
      .tag-item div[style*="font-size: 16pt"] {
        font-size: 12pt !important; /* Reducido de 14pt */
        line-height: 1 !important;
        margin: 0 !important;
      }

      .fanpage-item > div:last-child,
      .tag-item > div:last-child {
        padding: 5pt 8pt !important; /* Reducido de 6pt 10pt */
        flex-shrink: 0 !important;
        flex-grow: 0 !important; /* No crecer */
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        min-width: 55pt !important; /* Reducido de 60pt */
      }

      .fanpage-item > div:last-child > div:last-child,
      .tag-item > div:last-child > div:last-child {
        font-size: 6pt !important; /* Reducido de 6.5pt */
        line-height: 1 !important;
        margin-top: 2pt !important;
      }

      /* CRITICAL: Print-specific rules for PDF */
      @media print {
        .fanpage-item,
        .tag-item {
          height: 46pt !important;
          min-height: 46pt !important;
          max-height: 46pt !important;
          box-sizing: border-box !important;
          overflow: hidden !important;
        }

        /* Forzar centrado perfecto del c√≠rculo y emoji en print */
        .fanpage-item > div:nth-child(2),
        .tag-item > div:nth-child(2) {
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          align-self: center !important;
          line-height: 1 !important;
          padding: 0 !important;
          margin: 0 !important;
        }
      }

      /* ===== METHODOLOGY BOX - Compact ===== */

      div[style*="linear-gradient(135deg, #eff6ff"] {
        padding: 14pt 18pt !important; /* Reduced from 20pt 24pt */
        margin-top: 16pt !important;
      }

      div[style*="linear-gradient(135deg, #eff6ff"] h4 {
        font-size: 11pt !important; /* Reduced from 13pt */
        margin-bottom: 8pt !important;
      }

      div[style*="linear-gradient(135deg, #eff6ff"] p {
        font-size: 9pt !important; /* Reduced from 10pt */
        line-height: 1.5 !important;
        margin-bottom: 8pt !important;
      }

      div[style*="linear-gradient(135deg, #eff6ff"] > div[style*="display: grid"] {
        gap: 6pt !important; /* Reduced from 8pt */
      }

      div[style*="linear-gradient(135deg, #eff6ff"] > div[style*="display: grid"] > div {
        padding: 6pt !important; /* Reduced from 8pt */
      }

      /* ===== INSIGHT BARS - Compact ===== */

      div[style*="linear-gradient(135deg, #d1fae5"],
      div[style*="linear-gradient(135deg, #eff6ff 0%, #dbeafe"] {
        padding: 8pt 12pt !important; /* Reduced from 12pt 16pt */
        margin-top: 12pt !important;
        gap: 8pt !important;
      }

      div[style*="linear-gradient(135deg, #d1fae5"] span[style*="font-size: 24pt"],
      div[style*="linear-gradient(135deg, #eff6ff 0%, #dbeafe"] span[style*="font-size: 24pt"] {
        font-size: 20pt !important;
      }

      div[style*="linear-gradient(135deg, #d1fae5"] p,
      div[style*="linear-gradient(135deg, #eff6ff 0%, #dbeafe"] p {
        font-size: 8.5pt !important; /* Reduced from 9pt */
        line-height: 1.3 !important;
      }

      /* ===== GRID SPACING - 2x2 and 2 columns ===== */

      div[style*="display: grid; grid-template-columns: 1fr 1fr"] {
        gap: 12pt !important; /* Reduced from 16pt or 20pt */
      }

      div[style*="display: grid; grid-template-columns: 1fr 1fr; gap: 32pt"] {
        gap: 16pt !important; /* Reduced from 32pt */
      }

      /* ===== SECTION TITLES (H3) ===== */

      h3[style*="margin: 0 0 20pt 0"] {
        margin: 0 0 12pt 0 !important; /* Reduced from 20pt */
        font-size: 12pt !important; /* Reduced from 14pt */
        padding-left: 10pt !important;
        border-left: 3pt solid !important;
      }

      /* ===== PAGE BREAK CONTROL ===== */

      .pdf-section-wrapper {
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }

      .pdf-section-wrapper.force-new-page {
        page-break-before: always !important;
        break-before: page !important;
      }

      /* Ensure content fits */
      .pdf-slide-content {
        max-height: 650pt; /* Leave room for header/footer */
        overflow: hidden;
      }

      /* ===== SOURCE NOTES ===== */

      p[style*="font-size: 7pt"][style*="text-align: center"] {
        margin: 8pt 0 0 0 !important;
        font-size: 6.5pt !important;
      }

      /* ===== PRINT OPTIMIZATIONS ===== */

      @media print {
        body {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }

        .pdf-section-wrapper {
          page-break-inside: avoid !important;
        }

        .pdf-section-wrapper.force-new-page {
          page-break-before: always !important;
        }

        /* Ensure each slide is exactly 1 page */
        .pdf-slide {
          max-height: 729pt !important;
          page-break-after: always;
        }
      }
    </style>
  </head>
  <body>
    <%# SLIDE 0: Professional Cover Page %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'cover-page' do %>
      <%= render 'shared/pdf_cover_page',
            title: "Reporte Facebook",
            topic_name: @topic.name,
            period: pdf_date_range(days_range: @days_range),
            report_type: :facebook,
            subtitle: "An√°lisis de Reacciones y Sentimiento" %>
    <% end %>

    <%# SLIDE 1: M√©tricas Principales %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'section-1', force_new_page: true do %>
      <%= render 'shared/pdf_slide',
            slide_number: 1,
            title: "M√©tricas Principales",
            subtitle: "Rendimiento General del Per√≠odo",
            report_type: :facebook,
            topic_name: @topic.name do %>

        <%# KPIs en grid 2x2 para mejor visibilidad %>
        <%= render 'shared/pdf_kpi_slide',
            kpis: [
              {
                value: pdf_format_number(@total_posts),
                label: "Posts",
                icon: heroicon_svg(:document_text, size: '32pt', color: '#1877f2'),
                sublabel: "publicaciones totales"
              },
              {
                value: pdf_format_number(@total_interactions),
                label: "Interacciones",
                icon: heroicon_svg(:chart_bar, size: '32pt', color: '#10b981'),
                sublabel: "likes, comentarios, shares"
              },
              {
                value: pdf_format_number(@total_views),
                label: "Vistas",
                icon: heroicon_svg(:eye, size: '32pt', color: '#6366f1'),
                sublabel: "alcance oficial Meta API"
              },
              {
                value: pdf_format_number(@average_interactions),
                label: "Promedio",
                icon: heroicon_svg(:arrow_trending_up, size: '32pt', color: '#f59e0b'),
                sublabel: "interacciones por post"
              }
            ],
            columns: 2,
            size: 'large' %>
      <% end %>
    <% end %>

    <%# SLIDE 2: Evoluci√≥n Temporal %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'section-2', force_new_page: true do %>
      <%= render 'shared/pdf_slide',
          slide_number: 2,
          title: "Evoluci√≥n Temporal",
          subtitle: "Posts e Interacciones por D√≠a",
          report_type: :facebook,
          topic_name: @topic.name do %>

      <%
        # Simple chart configuration (matching Twitter PDF style)
        simple_chart_config = {
          height: '240px',
          library: {
            chart: { backgroundColor: 'transparent' },
            xAxis: { labels: { style: { fontSize: '9pt', fontWeight: '600' } } },
            yAxis: { labels: { style: { fontSize: '9pt', fontWeight: '600' } } }
          }
        }
      %>

      <%# Gr√°ficas apiladas verticalmente con configuraci√≥n optimizada %>
      <div style="display: flex; flex-direction: column; gap: 24pt;">
        <%# Posts por D√≠a %>
        <div>
          <h3 style="margin: 0 0 16pt 0; font-size: 14pt; font-weight: 700; color: #1f2937; padding-left: 12pt; border-left: 4pt solid #1877f2;">
            <%= heroicon_svg(:chart_bar, size: '20pt', color: '#1877f2') %> Posts por D√≠a
          </h3>
          <div class="fb-chart-temporal-container">
            <div class="fb-chart-temporal-wrapper" style="background: white; border: 2pt solid #e5e7eb; border-radius: 12pt; padding: 20pt; box-shadow: 0 2pt 8pt rgba(0, 0, 0, 0.06);">
              <%= column_chart @chart_posts,
                    colors: ['#1877f2'],
                    **simple_chart_config %>
            </div>
          </div>
          <p style="margin: 12pt 0 0 0; padding: 12pt 16pt; background: #eff6ff; border-left: 4pt solid #3b82f6; border-radius: 6pt; font-size: 10pt; line-height: 1.6; color: #1e40af;">
            <%= heroicon_svg(:light_bulb, size: '16pt', color: '#1e40af') %> Promedio de <strong><%= (@total_posts.to_f / @days_range).round(1) %></strong> posts por d√≠a durante el per√≠odo analizado.
          </p>
        </div>

        <%# Interacciones por D√≠a %>
        <div>
          <h3 style="margin: 0 0 16pt 0; font-size: 14pt; font-weight: 700; color: #1f2937; padding-left: 12pt; border-left: 4pt solid #10b981;">
            <%= heroicon_svg(:users, size: '20pt', color: '#10b981') %> Interacciones por D√≠a
          </h3>
          <div class="fb-chart-temporal-container">
            <div class="fb-chart-temporal-wrapper" style="background: white; border: 2pt solid #e5e7eb; border-radius: 12pt; padding: 20pt; box-shadow: 0 2pt 8pt rgba(0, 0, 0, 0.06);">
              <%= column_chart @chart_interactions,
                    colors: ['#10b981'],
                    **simple_chart_config %>
            </div>
          </div>
          <p style="margin: 12pt 0 0 0; padding: 12pt 16pt; background: #d1fae5; border-left: 4pt solid #10b981; border-radius: 6pt; font-size: 10pt; line-height: 1.6; color: #065f46;">
            <%= heroicon_svg(:light_bulb, size: '16pt', color: '#065f46') %> <%= @chart_interactions.values.max > @chart_interactions.values.min * 2 ? 'Alta variabilidad' : 'Consistencia' %> en las interacciones a lo largo del per√≠odo.
          </p>
        </div>
      </div>
    <% end %>
    <% end %>

    <%# SLIDE 3: An√°lisis de Sentimiento (Overview) %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'section-3', force_new_page: true do %>
    <% if @sentiment_summary.present? %>
      <%
        presenter = FacebookSentimentPresenter.new(
          sentiment_summary: @sentiment_summary,
          sentiment_distribution: @sentiment_distribution,
          sentiment_over_time: @sentiment_over_time,
          reaction_breakdown: @reaction_breakdown,
          top_positive_posts: @top_positive_posts,
          top_negative_posts: @top_negative_posts,
          controversial_posts: @controversial_posts,
          emotional_trends: @emotional_trends
        )
      %>

      <% if presenter.has_data? %>
      <%= render 'shared/pdf_slide',
            slide_number: 3,
            title: "An√°lisis de Sentimiento",
              subtitle: "Basado en Reacciones de Facebook",
              report_type: :facebook,
              topic_name: @topic.name do %>

          <%# KPIs de Sentimiento en grid 2x2 para mejor visibilidad %>
          <%= render 'shared/pdf_kpi_slide',
                kpis: [
                  {
                    value: number_with_precision(presenter.average_sentiment, precision: 2),
                    label: "Score Promedio",
                    icon: pdf_sentiment_emoji(presenter.average_sentiment, system: :facebook),
                    sublabel: presenter.average_sentiment > 0.5 ? 'Positivo' : presenter.average_sentiment < -0.5 ? 'Negativo' : 'Neutral'
                  },
                  {
                    value: "#{(presenter.overall_confidence * 100).round}%",
                    label: "Confianza",
                    icon: "üìä",
                    sublabel: "#{pdf_format_number(presenter.total_reactions)} reacciones"
                  },
                  {
                    value: "#{presenter.positive_percentage}%",
                    label: "Posts Positivos",
                    icon: "üòä",
                    sublabel: "sentimiento positivo"
                  },
                  {
                    value: @controversial_posts&.size || 0,
                    label: "Controvertidos",
                    icon: "‚ö†Ô∏è",
                    sublabel: "alta polarizaci√≥n"
                  }
                ],
                columns: 2,
                size: 'large' %>

          <%# Methodology Note %>
          <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 6pt solid #3b82f6; border-radius: 12pt; padding: 20pt 24pt; margin-top: 24pt;">
            <h4 style="margin: 0 0 12pt 0; color: #1e40af; font-size: 13pt; display: flex; align-items: center; gap: 8pt;">
              <span style="font-size: 24pt;">üí°</span>
              ¬øC√≥mo medimos el sentimiento?
            </h4>
            <p style="margin: 0 0 12pt 0; font-size: 10pt; line-height: 1.7; color: #1e3a8a;">
              Analizamos autom√°ticamente las <strong>reacciones</strong> que recibe cada post.
              Cada tipo de reacci√≥n tiene un peso emocional que nos permite calcular un score entre
              <span style="color: #ef4444; font-weight: 700;">-2.0 (muy negativo)</span> y
              <span style="color: #10b981; font-weight: 700;">+2.0 (muy positivo)</span>.
            </p>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8pt;">
              <div style="padding: 8pt; background: #d1fae5; border-radius: 6pt; text-align: center;">
                <div style="font-size: 20pt; margin-bottom: 4pt;">‚ù§Ô∏è</div>
                <div style="font-weight: 700; color: #065f46; font-size: 9pt;">Love: +2.0</div>
              </div>
              <div style="padding: 8pt; background: #fef3c7; border-radius: 6pt; text-align: center;">
                <div style="font-size: 20pt; margin-bottom: 4pt;">üòÑ</div>
                <div style="font-weight: 700; color: #92400e; font-size: 9pt;">Haha: +1.5</div>
              </div>
              <div style="padding: 8pt; background: #d1fae5; border-radius: 6pt; text-align: center;">
                <div style="font-size: 20pt; margin-bottom: 4pt;">üëç</div>
                <div style="font-weight: 700; color: #065f46; font-size: 9pt;">Like: +0.5</div>
              </div>
              <div style="padding: 8pt; background: #e0e7ff; border-radius: 6pt; text-align: center;">
                <div style="font-size: 20pt; margin-bottom: 4pt;">üòÆ</div>
                <div style="font-weight: 700; color: #3730a3; font-size: 9pt;">Wow: +1.0</div>
              </div>
              <div style="padding: 8pt; background: #fed7aa; border-radius: 6pt; text-align: center;">
                <div style="font-size: 20pt; margin-bottom: 4pt;">üò¢</div>
                <div style="font-weight: 700; color: #9a3412; font-size: 9pt;">Sad: -1.5</div>
              </div>
              <div style="padding: 8pt; background: #fee2e2; border-radius: 6pt; text-align: center;">
                <div style="font-size: 20pt; margin-bottom: 4pt;">üò†</div>
                <div style="font-weight: 700; color: #991b1b; font-size: 9pt;">Angry: -2.0</div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>
    <% end %>

    <%# SLIDE 4: Distribuci√≥n de Sentimiento %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'section-4', force_new_page: true do %>
    <% if @sentiment_summary.present? && @sentiment_distribution.present? %>
      <%
        presenter = FacebookSentimentPresenter.new(
          sentiment_summary: @sentiment_summary,
          sentiment_distribution: @sentiment_distribution,
          sentiment_over_time: @sentiment_over_time,
          reaction_breakdown: @reaction_breakdown,
          top_positive_posts: @top_positive_posts,
          top_negative_posts: @top_negative_posts,
          controversial_posts: @controversial_posts,
          emotional_trends: @emotional_trends
        )
      %>
      <%= render 'shared/pdf_slide',
            slide_number: 4,
            title: "Distribuci√≥n de Sentimiento",
            subtitle: "Posts por Tipo de Sentimiento",
            report_type: :facebook,
            topic_name: @topic.name do %>

        <%
          # Configuraci√≥n de emojis y colores por tipo de sentimiento
          sentiment_config = {
            'Muy Positivo' => { emoji: 'üòÑ', color: '#10b981', bg: '#d1fae5', range: '+1.5 a +2.0', desc: 'Contenido muy bien recibido' },
            'Positivo' => { emoji: 'üôÇ', color: '#22c55e', bg: '#dcfce7', range: '+0.5 a +1.5', desc: 'Contenido bien valorado' },
            'Neutral' => { emoji: 'üòê', color: '#6b7280', bg: '#f3f4f6', range: '-0.5 a +0.5', desc: 'Sin sesgo emocional claro' },
            'Negativo' => { emoji: '‚òπÔ∏è', color: '#f59e0b', bg: '#fef3c7', range: '-1.5 a -0.5', desc: 'Contenido con rechazo' },
            'Muy Negativo' => { emoji: 'üò†', color: '#ef4444', bg: '#fee2e2', range: '-2.0 a -1.5', desc: 'Contenido muy mal recibido' }
          }

          # Obtener distribuci√≥n de sentimientos y convertir a hash si es array
          sentiment_data = presenter.sentiment_distribution_data
          sentiment_dist = sentiment_data.is_a?(Hash) ? sentiment_data : sentiment_data.to_h
          total_posts = sentiment_dist.values.sum
        %>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16pt;">
            <% sentiment_dist.sort_by { |k, v| -v }.each_with_index do |(sentiment_name, count), index| %>
              <% config = sentiment_config[sentiment_name] || { emoji: 'üòê', color: '#6b7280', bg: '#f3f4f6', range: 'N/A', desc: sentiment_name } %>
              <% percentage = total_posts > 0 ? (count.to_f / total_posts * 100).round(1) : 0 %>

              <div class="sentiment-card" style="background: white; border: 2pt solid #e5e7eb; border-radius: 10pt; padding: 14pt 16pt; box-shadow: 0 2pt 6pt rgba(0, 0, 0, 0.06); position: relative; overflow: hidden;">
                <%# Background bar (porcentaje visual) %>
                <div style="position: absolute; top: 0; left: 0; height: 100%; width: <%= percentage %>%; background: <%= config[:bg] %>; opacity: 0.5; z-index: 0;"></div>

                <%# Content %>
                <div style="position: relative; z-index: 1;">
                  <%# Header con emoji y nombre %>
                  <div style="display: flex; align-items: center; gap: 10pt; margin-bottom: 10pt;">
                    <div style="flex: 0 0 auto; width: 40pt; height: 40pt; border-radius: 50%; background: <%= config[:bg] %>; display: flex; align-items: center; justify-content: center; font-size: 24pt; border: 2pt solid <%= config[:color] %>;">
                      <%= config[:emoji] %>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                      <div style="font-size: 12pt; font-weight: 800; color: <%= config[:color] %>; line-height: 1;">
                        <%= sentiment_name %>
                      </div>
                      <div style="font-size: 7pt; color: #6b7280; margin-top: 2pt;">
                        <%= config[:desc] %>
                      </div>
                    </div>
                  </div>

                  <%# M√©tricas %>
                  <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div>
                      <div style="font-size: 24pt; font-weight: 900; color: <%= config[:color] %>; line-height: 1; font-feature-settings: 'tnum' 1;">
                        <%= count %>
                      </div>
                      <div style="font-size: 7pt; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-top: 3pt;">
                        posts
                      </div>
                    </div>

                    <div style="text-align: right;">
                      <div style="font-size: 16pt; font-weight: 800; color: <%= config[:color] %>; line-height: 1;">
                        <%= percentage %>%
                      </div>
                      <div style="font-size: 7pt; color: #6b7280; margin-top: 3pt;">
                        del total
                      </div>
                    </div>
                  </div>

                  <%# Sentiment range badge %>
                  <div style="margin-top: 8pt; display: inline-block; padding: 3pt 8pt; background: <%= config[:bg] %>; border-radius: 10pt;">
                    <span style="font-size: 7pt; font-weight: 700; color: <%= config[:color] %>;">
                      üìä Rango: <%= config[:range] %>
                    </span>
                  </div>
                </div>
              </div>
          <% end %>
        </div>

        <%# Insight Bar - M√°s compacto %>
        <div style="display: flex; align-items: center; gap: 10pt; padding: 12pt 16pt; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4pt solid #10b981; border-radius: 8pt; margin-top: 16pt;">
          <span style="font-size: 24pt; line-height: 1;">üí°</span>
          <p style="margin: 0; font-size: 9pt; font-weight: 600; line-height: 1.4; color: #064e3b;">
            <%= presenter.positive_percentage %>% positivos,
            <%= presenter.neutral_percentage %>% neutrales,
            <%= presenter.negative_percentage %>% negativos.
            Confianza: <%= (presenter.overall_confidence * 100).round %>%.
          </p>
        </div>

        <%# Source note %>
        <p style="margin: 12pt 0 0 0; font-size: 7pt; color: #9ca3af; text-align: center; font-style: italic;">
          An√°lisis: <%= total_posts %> posts | Score: -2.0 a +2.0
        </p>
      <% end %>
    <% end %>
    <% end %>

    <%# SLIDE 5: Desglose de Reacciones %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'section-5', force_new_page: true do %>
    <% if @sentiment_summary.present? && @reaction_breakdown.present? %>
      <%
        presenter = FacebookSentimentPresenter.new(
          sentiment_summary: @sentiment_summary,
          sentiment_distribution: @sentiment_distribution,
          sentiment_over_time: @sentiment_over_time,
          reaction_breakdown: @reaction_breakdown,
          top_positive_posts: @top_positive_posts,
          top_negative_posts: @top_negative_posts,
          controversial_posts: @controversial_posts,
          emotional_trends: @emotional_trends
        )
      %>
      <% if presenter.reaction_breakdown_data.present? %>
      <%= render 'shared/pdf_slide',
                slide_number: 5,
                title: "Desglose de Reacciones",
                subtitle: "Tipos de Reacciones Recibidas",
                report_type: :facebook,
                topic_name: @topic.name do %>

        <%#
          Mapeo de emojis y colores por tipo de reacci√≥n
          Emojis oficiales de Facebook
          Soporta nombres en ingl√©s y espa√±ol
          Basado en los pesos de sentimiento de FacebookEntry
        %>
        <%
          reaction_config = {
                # Ingl√©s
                'Like' => { emoji: 'üëç', color: '#3b82f6', bg: '#dbeafe', sentiment: '+0.5', desc: 'Me gusta b√°sico' },
                'Love' => { emoji: '‚ù§Ô∏è', color: '#f43f5e', bg: '#fecdd3', sentiment: '+2.0', desc: 'Amor / Encanta' },
                'Haha' => { emoji: 'üòÜ', color: '#f59e0b', bg: '#fef3c7', sentiment: '+1.5', desc: 'Risa / Divertido' },
                'Wow' => { emoji: 'üòÆ', color: '#a855f7', bg: '#f3e8ff', sentiment: '+1.0', desc: 'Sorpresa / Asombro' },
                'Sad' => { emoji: 'üò¢', color: '#0ea5e9', bg: '#e0f2fe', sentiment: '-1.5', desc: 'Tristeza / Empat√≠a' },
                'Angry' => { emoji: 'üò°', color: '#dc2626', bg: '#fee2e2', sentiment: '-2.0', desc: 'Enojo / Indignaci√≥n' },
                'Care' => { emoji: 'ü§ó', color: '#10b981', bg: '#d1fae5', sentiment: '+2.0', desc: 'Cuidado / Apoyo' },
                'Thankful' => { emoji: 'üôè', color: '#ec4899', bg: '#fce7f3', sentiment: '+2.0', desc: 'Agradecimiento' },
                # Espa√±ol
                'Me Gusta' => { emoji: 'üëç', color: '#3b82f6', bg: '#dbeafe', sentiment: '+0.5', desc: 'Me gusta b√°sico' },
                'Me Encanta' => { emoji: '‚ù§Ô∏è', color: '#f43f5e', bg: '#fecdd3', sentiment: '+2.0', desc: 'Amor / Encanta' },
                'Me Divierte' => { emoji: 'üòÜ', color: '#f59e0b', bg: '#fef3c7', sentiment: '+1.5', desc: 'Risa / Divertido' },
                'Me Asombra' => { emoji: 'üòÆ', color: '#a855f7', bg: '#f3e8ff', sentiment: '+1.0', desc: 'Sorpresa / Asombro' },
                'Me Entristece' => { emoji: 'üò¢', color: '#0ea5e9', bg: '#e0f2fe', sentiment: '-1.5', desc: 'Tristeza / Empat√≠a' },
                'Me Enoja' => { emoji: 'üò°', color: '#dc2626', bg: '#fee2e2', sentiment: '-2.0', desc: 'Enojo / Indignaci√≥n' },
                'Me Importa' => { emoji: 'ü§ó', color: '#10b981', bg: '#d1fae5', sentiment: '+2.0', desc: 'Cuidado / Apoyo' }
              }

              # Ordenar reacciones por cantidad (mayor a menor)
              sorted_reactions = presenter.reaction_breakdown_data.sort_by { |k, v| -v }
              total_reactions = presenter.reaction_breakdown_data.values.sum
            %>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16pt;">
              <% sorted_reactions.take(6).each_with_index do |(reaction_name, count), index| %>
              <% config = reaction_config[reaction_name] || { emoji: 'üëç', color: '#6b7280', bg: '#f3f4f6', sentiment: '0', desc: reaction_name } %>
                <% percentage = total_reactions > 0 ? (count.to_f / total_reactions * 100).round(1) : 0 %>

                <div class="reaction-card" style="background: white; border: 2pt solid #e5e7eb; border-radius: 10pt; padding: 14pt 16pt; box-shadow: 0 2pt 6pt rgba(0, 0, 0, 0.06); position: relative; overflow: hidden;">
                  <%# Background bar (porcentaje visual) %>
                  <div style="position: absolute; top: 0; left: 0; height: 100%; width: <%= percentage %>%; background: <%= config[:bg] %>; opacity: 0.5; z-index: 0;"></div>

                  <%# Content %>
                  <div style="position: relative; z-index: 1;">
                    <%# Header con emoji y nombre %>
                    <div style="display: flex; align-items: center; gap: 10pt; margin-bottom: 10pt;">
                      <div style="flex: 0 0 auto; width: 40pt; height: 40pt; border-radius: 50%; background: <%= config[:bg] %>; display: flex; align-items: center; justify-content: center; font-size: 24pt; border: 2pt solid <%= config[:color] %>;">
                        <%= config[:emoji] %>
                      </div>
                      <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 12pt; font-weight: 800; color: <%= config[:color] %>; line-height: 1;">
                          <%= reaction_name %>
                        </div>
                        <div style="font-size: 7pt; color: #6b7280; margin-top: 2pt;">
                          <%= config[:desc] %>
                        </div>
                      </div>
                    </div>

                    <%# M√©tricas %>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                      <div>
                        <div style="font-size: 24pt; font-weight: 900; color: <%= config[:color] %>; line-height: 1; font-feature-settings: 'tnum' 1;">
                          <%= pdf_format_number(count) %>
                        </div>
                        <div style="font-size: 7pt; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-top: 3pt;">
                          reacciones
                        </div>
                      </div>

                      <div style="text-align: right;">
                        <div style="font-size: 16pt; font-weight: 800; color: <%= config[:color] %>; line-height: 1;">
                          <%= percentage %>%
                        </div>
                        <div style="font-size: 7pt; color: #6b7280; margin-top: 3pt;">
                          del total
                        </div>
                      </div>
                    </div>

                    <%# Sentiment badge %>
                    <div style="margin-top: 8pt; display: inline-block; padding: 3pt 8pt; background: <%= config[:sentiment].start_with?('-') ? '#fee2e2' : '#d1fae5' %>; border-radius: 10pt;">
                      <span style="font-size: 7pt; font-weight: 700; color: <%= config[:sentiment].start_with?('-') ? '#dc2626' : '#10b981' %>;">
                        <%= config[:sentiment].start_with?('-') ? '‚ñº' : '‚ñ≤' %> Peso: <%= config[:sentiment] %>
                      </span>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>

            <%# Insight Bar - M√°s compacto %>
            <div style="display: flex; align-items: center; gap: 10pt; padding: 12pt 16pt; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4pt solid #3b82f6; border-radius: 8pt; margin-top: 16pt;">
              <span style="font-size: 24pt; line-height: 1;">üí°</span>
              <p style="margin: 0; font-size: 9pt; font-weight: 600; line-height: 1.4; color: #1e40af;">
                <%
                  top_reaction_name = sorted_reactions.first[0]
                  top_reaction_count = sorted_reactions.first[1]
                  top_reaction_config = reaction_config[top_reaction_name]
                %>
                <strong><%= top_reaction_name %></strong> predomina con
                <strong><%= pdf_format_number(top_reaction_count) %></strong>
                (<strong><%= (top_reaction_count.to_f / total_reactions * 100).round(1) %>%</strong>),
                generando principalmente
                <strong><%= top_reaction_config ? top_reaction_config[:desc].downcase : 'engagement' %></strong>.
              </p>
            </div>

        <%# Source note %>
        <p style="margin: 12pt 0 0 0; font-size: 7pt; color: #9ca3af; text-align: center; font-style: italic;">
          Fuente: Meta API | Total: <%= pdf_format_number(total_reactions) %> reacciones
        </p>
      <% end %>
      <% end %>
    <% end %>
    <% end %>

    <%# SLIDE 6: Top Posts Positivos (P√°gina 1 - Posts 1-8) %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'section-6', force_new_page: true do %>
    <% if @top_positive_posts.present? && @top_positive_posts.any? %>
      <%= render 'shared/pdf_slide',
                slide_number: 6,
                title: "Posts M√°s Positivos",
                subtitle: "Contenido con Mejor Recepci√≥n (1-8)",
                report_type: :facebook,
                topic_name: @topic.name do %>

        <%# Lista vertical de posts (primeros 8 posts) %>
        <div style="display: flex; flex-direction: column;">
          <% @top_positive_posts.take(8).each_with_index do |post, index| %>
            <div class="post-card" style="background: white; border: 1pt solid #d1fae5; border-radius: 6pt;">
              <%# Ranking badge %>
              <div>
                <span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 50%;">#<%= index + 1 %></span>
              </div>

              <%# Content area %>
              <div class="post-card-content">
                <%# Header: Page name + Date + Sentiment %>
                <div class="post-card-header">
                  <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= post.page&.name || 'Unknown' %></div>
                  <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                  <div style="font-size: 6.5pt; color: #9ca3af;"><%= post.posted_at&.strftime("%d/%m/%Y") %></div>
                  <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                  <div style="font-size: 7pt; color: #10b981; font-weight: 700;"><%= pdf_sentiment_emoji(post.sentiment_score, system: :facebook) %> <%= number_with_precision(post.sentiment_score, precision: 2) %></div>
                </div>

                <%# Message - truncated single line %>
                <% if post.message.present? %>
                  <p><%= post.message %></p>
                <% end %>

                <%# Metrics as inline text %>
                <div class="post-card-metrics">
                  <span><%= heroicon_svg(:heart, size: '12pt', color: '#ef4444') %> <strong><%= pdf_format_number(post.reactions_total_count) %></strong> reacciones</span>
                  <span>‚Ä¢</span>
                  <span><%= heroicon_svg(:chat_bubble_oval_left, size: '12pt', color: '#3b82f6') %> <strong><%= pdf_format_number(post.comments_count) %></strong> comentarios</span>
                  <span>‚Ä¢</span>
                  <span><%= heroicon_svg(:share, size: '12pt', color: '#10b981') %> <strong><%= pdf_format_number(post.share_count) %></strong> shares</span>
                  <% if post.views_count && post.views_count > 0 %>
                    <span>‚Ä¢</span>
                    <span><%= heroicon_svg(:eye, size: '12pt', color: '#6b7280') %> <strong><%= pdf_format_number(post.views_count) %></strong> vistas</span>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
    <% end %>

    <%# SLIDE 6B: Top Posts Positivos (P√°gina 2 - Posts 9-15) %>
    <% if @top_positive_posts.present? && @top_positive_posts.to_a.size > 8 %>
      <%= render 'shared/pdf_section_wrapper', section_id: 'section-6b', force_new_page: true do %>
        <%= render 'shared/pdf_slide',
                  slide_number: '6B',
                  title: "Posts M√°s Positivos",
                  subtitle: "Contenido con Mejor Recepci√≥n (9-15)",
                  report_type: :facebook,
                  topic_name: @topic.name do %>

          <%# Lista vertical de posts (posts 9-15) %>
          <div style="display: flex; flex-direction: column;">
            <% @top_positive_posts.drop(8).take(7).each_with_index do |post, index| %>
              <div class="post-card" style="background: white; border: 1pt solid #d1fae5; border-radius: 6pt;">
                <%# Ranking badge %>
                <div>
                  <span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 50%;">#<%= index + 9 %></span>
                </div>

                <%# Content area %>
                <div class="post-card-content">
                  <%# Header: Page name + Date + Sentiment %>
                  <div class="post-card-header">
                    <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= post.page&.name || 'Unknown' %></div>
                    <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                    <div style="font-size: 6.5pt; color: #9ca3af;"><%= post.posted_at&.strftime("%d/%m/%Y") %></div>
                    <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                    <div style="font-size: 7pt; color: #10b981; font-weight: 700;"><%= pdf_sentiment_emoji(post.sentiment_score, system: :facebook) %> <%= number_with_precision(post.sentiment_score, precision: 2) %></div>
                  </div>

                  <%# Message - truncated single line %>
                  <% if post.message.present? %>
                    <p><%= post.message %></p>
                  <% end %>

                  <%# Metrics as inline text %>
                  <div class="post-card-metrics">
                    <span><%= heroicon_svg(:heart, size: '12pt', color: '#ef4444') %> <strong><%= pdf_format_number(post.reactions_total_count) %></strong> reacciones</span>
                    <span>‚Ä¢</span>
                    <span><%= heroicon_svg(:chat_bubble_oval_left, size: '12pt', color: '#3b82f6') %> <strong><%= pdf_format_number(post.comments_count) %></strong> comentarios</span>
                    <span>‚Ä¢</span>
                    <span><%= heroicon_svg(:share, size: '12pt', color: '#10b981') %> <strong><%= pdf_format_number(post.share_count) %></strong> shares</span>
                    <% if post.views_count && post.views_count > 0 %>
                      <span>‚Ä¢</span>
                      <span><%= heroicon_svg(:eye, size: '12pt', color: '#6b7280') %> <strong><%= pdf_format_number(post.views_count) %></strong> vistas</span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    <% end %>

    <%# SLIDE 7: Top Posts Negativos (P√°gina 1 - Posts 1-8) %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'section-7', force_new_page: true do %>
    <% if @top_negative_posts.present? && @top_negative_posts.any? %>
      <%= render 'shared/pdf_slide',
                slide_number: 7,
                title: "Posts M√°s Negativos",
                subtitle: "Contenido que Requiere Atenci√≥n (1-8)",
                report_type: :facebook,
                topic_name: @topic.name do %>

        <%# Lista vertical de posts (primeros 8 posts) %>
        <div style="display: flex; flex-direction: column;">
          <% @top_negative_posts.take(8).each_with_index do |post, index| %>
            <div class="post-card" style="background: white; border: 1pt solid #fee2e2; border-radius: 6pt;">
              <%# Ranking badge %>
              <div>
                <span style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border-radius: 50%;">#<%= index + 1 %></span>
              </div>

              <%# Content area %>
              <div class="post-card-content">
                <%# Header: Page name + Date + Sentiment %>
                <div class="post-card-header">
                  <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= post.page&.name || 'Unknown' %></div>
                  <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                  <div style="font-size: 6.5pt; color: #9ca3af;"><%= post.posted_at&.strftime("%d/%m/%Y") %></div>
                  <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                  <div style="font-size: 7pt; color: #ef4444; font-weight: 700;"><%= pdf_sentiment_emoji(post.sentiment_score, system: :facebook) %> <%= number_with_precision(post.sentiment_score, precision: 2) %></div>
                </div>

                <%# Message - truncated single line %>
                <% if post.message.present? %>
                  <p><%= post.message %></p>
                <% end %>

                <%# Metrics as inline text %>
                <div class="post-card-metrics">
                  <span><%= heroicon_svg(:heart, size: '12pt', color: '#ef4444') %> <strong><%= pdf_format_number(post.reactions_total_count) %></strong> reacciones</span>
                  <span>‚Ä¢</span>
                  <span><%= heroicon_svg(:chat_bubble_oval_left, size: '12pt', color: '#3b82f6') %> <strong><%= pdf_format_number(post.comments_count) %></strong> comentarios</span>
                  <span>‚Ä¢</span>
                  <span><%= heroicon_svg(:share, size: '12pt', color: '#10b981') %> <strong><%= pdf_format_number(post.share_count) %></strong> shares</span>
                  <% if post.views_count && post.views_count > 0 %>
                    <span>‚Ä¢</span>
                    <span><%= heroicon_svg(:eye, size: '12pt', color: '#6b7280') %> <strong><%= pdf_format_number(post.views_count) %></strong> vistas</span>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
    <% end %>

    <%# SLIDE 7B: Top Posts Negativos (P√°gina 2 - Posts 9-15) %>
    <% if @top_negative_posts.present? && @top_negative_posts.to_a.size > 8 %>
      <%= render 'shared/pdf_section_wrapper', section_id: 'section-7b', force_new_page: true do %>
        <%= render 'shared/pdf_slide',
                  slide_number: '7B',
                  title: "Posts M√°s Negativos",
                  subtitle: "Contenido que Requiere Atenci√≥n (9-15)",
                  report_type: :facebook,
                  topic_name: @topic.name do %>

          <%# Lista vertical de posts (posts 9-15) %>
          <div style="display: flex; flex-direction: column;">
            <% @top_negative_posts.drop(8).take(7).each_with_index do |post, index| %>
              <div class="post-card" style="background: white; border: 1pt solid #fee2e2; border-radius: 6pt;">
                <%# Ranking badge %>
                <div>
                  <span style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border-radius: 50%;">#<%= index + 9 %></span>
                </div>

                <%# Content area %>
                <div class="post-card-content">
                  <%# Header: Page name + Date + Sentiment %>
                  <div class="post-card-header">
                    <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= post.page&.name || 'Unknown' %></div>
                    <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                    <div style="font-size: 6.5pt; color: #9ca3af;"><%= post.posted_at&.strftime("%d/%m/%Y") %></div>
                    <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                    <div style="font-size: 7pt; color: #ef4444; font-weight: 700;"><%= pdf_sentiment_emoji(post.sentiment_score, system: :facebook) %> <%= number_with_precision(post.sentiment_score, precision: 2) %></div>
                  </div>

                  <%# Message - truncated single line %>
                  <% if post.message.present? %>
                    <p><%= post.message %></p>
                  <% end %>

                  <%# Metrics as inline text %>
                  <div class="post-card-metrics">
                    <span><%= heroicon_svg(:heart, size: '12pt', color: '#ef4444') %> <strong><%= pdf_format_number(post.reactions_total_count) %></strong> reacciones</span>
                    <span>‚Ä¢</span>
                    <span><%= heroicon_svg(:chat_bubble_oval_left, size: '12pt', color: '#3b82f6') %> <strong><%= pdf_format_number(post.comments_count) %></strong> comentarios</span>
                    <span>‚Ä¢</span>
                    <span><%= heroicon_svg(:share, size: '12pt', color: '#10b981') %> <strong><%= pdf_format_number(post.share_count) %></strong> shares</span>
                    <% if post.views_count && post.views_count > 0 %>
                      <span>‚Ä¢</span>
                      <span><%= heroicon_svg(:eye, size: '12pt', color: '#6b7280') %> <strong><%= pdf_format_number(post.views_count) %></strong> vistas</span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    <% end %>
    <%# SLIDE 8: An√°lisis por Fanpage %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'section-8', force_new_page: true do %>
    <% if @pages_count.present? && @pages_count.any? %>
      <%= render 'shared/pdf_slide',
            slide_number: 8,
            title: "An√°lisis por Fanpage",
            subtitle: "Distribuci√≥n de Posts e Interacciones",
            report_type: :facebook,
            topic_name: @topic.name do %>

        <%# Lista de Fanpages con Rankings %>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20pt;">

          <%# Columna 1: Top Fanpages por Posts %>
          <div>
            <h3 style="margin: 0 0 16pt 0; font-size: 13pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #1877f2;">
              <%= heroicon_svg(:users, size: '18pt', color: '#1877f2') %> Top Fanpages por Posts
            </h3>

            <div style="display: flex; flex-direction: column; gap: 6pt;">
              <% @pages_count.sort_by { |k, v| -v }.take(8).each_with_index do |(page_name, count), index| %>
                <%
                  # Buscar la p√°gina para obtener el avatar
                  page = Page.find_by(name: page_name)
                %>
                <div class="fanpage-item" style="display: flex; align-items: center; gap: 8pt; padding: 6pt 10pt; background: white; border: 1pt solid #e5e7eb; border-radius: 6pt; box-shadow: 0 1pt 4pt rgba(0, 0, 0, 0.06); min-height: 46pt; max-height: 46pt;">
                  <%# Ranking Badge %>
                  <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; width: 22pt; height: 22pt; background: linear-gradient(135deg, #1877f2 0%, #0c63d4 100%); color: white; border-radius: 50%; font-size: 10pt; font-weight: 900; box-shadow: 0 2pt 4pt rgba(24, 119, 242, 0.3);">
                    <%= index + 1 %>
                  </div>

                  <%# Avatar %>
                  <% if page&.picture.present? %>
                    <img src="<%= page.picture %>"
                         style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; object-fit: cover; border: 2pt solid #e5e7eb;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="display: none; flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); align-items: center; justify-content: center; font-size: 14pt; border: 2pt solid #93c5fd;">
                      üë§
                    </div>
                  <% else %>
                    <div style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); display: flex; align-items: center; justify-content: center; font-size: 14pt; border: 2pt solid #93c5fd;">
                      üë§
                    </div>
                  <% end %>

                  <%# Info %>
                  <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 700; font-size: 8pt; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin: 0;">
                      <%= page_name %>
                    </div>
                    <div style="font-size: 6.5pt; color: #6b7280; margin-top: 2pt; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                      Fanpage oficial
                    </div>
                  </div>

                  <%# M√©trica %>
                  <div style="flex: 0 0 auto; text-align: center; padding: 5pt 8pt; background: #eff6ff; border-radius: 6pt; min-width: 55pt;">
                    <div style="font-size: 12pt; font-weight: 900; color: #1877f2; line-height: 1; margin: 0;">
                      <%= count %>
                    </div>
                    <div style="font-size: 6pt; color: #0c63d4; text-transform: uppercase; font-weight: 600; margin-top: 2pt; line-height: 1;">
                      posts
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <%# Columna 2: Top Fanpages por Interacciones %>
          <div>
            <h3 style="margin: 0 0 16pt 0; font-size: 13pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #10b981;">
              <%= heroicon_svg(:chart_bar, size: '18pt', color: '#10b981') %> Top Fanpages por Interacciones
            </h3>

            <div style="display: flex; flex-direction: column; gap: 6pt;">
              <% @pages_interactions.sort_by { |k, v| -v }.take(8).each_with_index do |(page_name, interactions), index| %>
                <%
                  # Buscar la p√°gina para obtener el avatar
                  page = Page.find_by(name: page_name)
                %>
                <div class="fanpage-item" style="display: flex; align-items: center; gap: 8pt; padding: 6pt 10pt; background: white; border: 1pt solid #e5e7eb; border-radius: 6pt; box-shadow: 0 1pt 4pt rgba(0, 0, 0, 0.06); min-height: 46pt; max-height: 46pt;">
                  <%# Ranking Badge %>
                  <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; width: 22pt; height: 22pt; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 50%; font-size: 10pt; font-weight: 900; box-shadow: 0 2pt 4pt rgba(16, 185, 129, 0.3);">
                    <%= index + 1 %>
                  </div>

                  <%# Avatar %>
                  <% if page&.picture.present? %>
                    <img src="<%= page.picture %>"
                         style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; object-fit: cover; border: 2pt solid #e5e7eb;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="display: none; flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); align-items: center; justify-content: center; font-size: 14pt; border: 2pt solid #6ee7b7;">
                      üë§
                    </div>
                  <% else %>
                    <div style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); display: flex; align-items: center; justify-content: center; font-size: 14pt; border: 2pt solid #6ee7b7;">
                      üë§
                    </div>
                  <% end %>

                  <%# Info %>
                  <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 700; font-size: 8pt; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin: 0;">
                      <%= page_name %>
                    </div>
                    <div style="font-size: 6.5pt; color: #6b7280; margin-top: 2pt; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                      <%= @pages_count[page_name] || 0 %> posts
                    </div>
                  </div>

                  <%# M√©trica %>
                  <div style="flex: 0 0 auto; text-align: center; padding: 5pt 8pt; background: #d1fae5; border-radius: 6pt; min-width: 55pt;">
                    <div style="font-size: 12pt; font-weight: 900; color: #10b981; line-height: 1; margin: 0;">
                      <%= pdf_format_number(interactions) %>
                    </div>
                    <div style="font-size: 6pt; color: #059669; text-transform: uppercase; font-weight: 600; margin-top: 2pt; line-height: 1;">
                      interac.
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

        </div>
      <% end %>
    <% end %>
    <% end %>

    <%# SLIDE 9: An√°lisis por Etiquetas %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'section-9', force_new_page: true do %>
    <% if @tag_counts.present? && @tag_counts.any? %>
      <%= render 'shared/pdf_slide',
            slide_number: 9,
            title: "An√°lisis por Etiquetas",
            subtitle: "Distribuci√≥n de Contenido por Tags",
            report_type: :facebook,
            topic_name: @topic.name do %>

        <%# Lista de Etiquetas con Rankings %>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20pt;">

          <%# Columna 1: Top Etiquetas por Posts %>
          <div>
            <h3 style="margin: 0 0 16pt 0; font-size: 13pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #8b5cf6;">
              <%= heroicon_svg(:hashtag, size: '18pt', color: '#8b5cf6') %> Top Etiquetas por Posts
            </h3>

            <div style="display: flex; flex-direction: column; gap: 6pt;">
              <% @tag_counts.take(8).each_with_index do |tag, index| %>
                <div class="tag-item" style="display: flex; align-items: center; gap: 8pt; padding: 6pt 10pt; background: white; border: 1pt solid #e5e7eb; border-radius: 6pt; min-height: 46pt; max-height: 46pt;">
                  <%# Ranking Badge %>
                  <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; width: 22pt; height: 22pt; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border-radius: 50%; font-size: 10pt; font-weight: 900;">
                    <%= index + 1 %>
                  </div>

                  <%# Tag Icon %>
                  <div style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); display: flex; align-items: center; justify-content: center; font-size: 14pt; border: 1.5pt solid #c4b5fd;">
                    üè∑Ô∏è
                  </div>

                  <%# Info %>
                  <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center;">
                    <div style="font-weight: 700; font-size: 8pt; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin: 0;">
                      <%= tag.name %>
                    </div>
                    <div style="font-size: 6.5pt; color: #6b7280; margin-top: 2pt; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                      Etiqueta de contenido
                    </div>
                  </div>

                  <%# M√©trica %>
                  <div style="flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5pt 8pt; background: #f5f3ff; border-radius: 6pt; min-width: 55pt;">
                    <div style="font-size: 12pt; font-weight: 900; color: #8b5cf6; line-height: 1; margin: 0;">
                      <%= tag.count %>
                    </div>
                    <div style="font-size: 6pt; color: #7c3aed; text-transform: uppercase; font-weight: 600; margin-top: 2pt; line-height: 1;">
                      posts
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <%# Columna 2: Top Etiquetas por Interacciones %>
          <div>
            <h3 style="margin: 0 0 16pt 0; font-size: 13pt; font-weight: 700; color: #1f2937; padding-left: 10pt; border-left: 3pt solid #10b981;">
              <%= heroicon_svg(:chart_bar, size: '18pt', color: '#10b981') %> Top Etiquetas por Interacciones
            </h3>

            <div style="display: flex; flex-direction: column; gap: 6pt;">
              <% @tag_interactions.sort_by { |k, v| -v }.take(8).each_with_index do |(tag_name, interactions), index| %>
                <div class="tag-item" style="display: flex; align-items: center; gap: 8pt; padding: 6pt 10pt; background: white; border: 1pt solid #e5e7eb; border-radius: 6pt; min-height: 46pt; max-height: 46pt;">
                  <%# Ranking Badge %>
                  <div style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; width: 22pt; height: 22pt; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 50%; font-size: 10pt; font-weight: 900;">
                    <%= index + 1 %>
                  </div>

                  <%# Tag Icon %>
                  <div style="flex: 0 0 auto; width: 28pt; height: 28pt; border-radius: 50%; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); display: flex; align-items: center; justify-content: center; font-size: 14pt; border: 1.5pt solid #6ee7b7;">
                    üè∑Ô∏è
                  </div>

                  <%# Info %>
                  <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center;">
                    <div style="font-weight: 700; font-size: 8pt; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; margin: 0;">
                      <%= tag_name %>
                    </div>
                    <div style="font-size: 6.5pt; color: #6b7280; margin-top: 2pt; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                      Etiqueta de contenido
                    </div>
                  </div>

                  <%# M√©trica %>
                  <div style="flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5pt 8pt; background: #d1fae5; border-radius: 6pt; min-width: 55pt;">
                    <div style="font-size: 12pt; font-weight: 900; color: #10b981; line-height: 1; margin: 0;">
                      <%= pdf_format_number(interactions) %>
                    </div>
                    <div style="font-size: 6pt; color: #059669; text-transform: uppercase; font-weight: 600; margin-top: 2pt; line-height: 1;">
                      interac.
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

        </div>
      <% end %>
    <% end %>
    <% end %>

    <%# SLIDE 10: Top Posts Generales (P√°gina 1 - Posts 1-8) %>
    <%= render 'shared/pdf_section_wrapper', section_id: 'section-10', force_new_page: true do %>
    <% if @top_posts.present? && @top_posts.any? %>
      <%= render 'shared/pdf_slide',
            slide_number: 10,
            title: "Posts con M√°s Interacciones",
            subtitle: "Contenido de Mayor Impacto (1-8)",
            report_type: :facebook,
            topic_name: @topic.name do %>

        <%# Lista vertical de posts (primeros 8 posts) %>
        <div style="display: flex; flex-direction: column;">
          <% @top_posts.take(8).each_with_index do |post, index| %>
            <div class="post-card" style="background: white; border: 1pt solid #e5e7eb; border-radius: 6pt;">
              <%# Ranking badge %>
              <div>
                <span style="background: linear-gradient(135deg, #1877f2 0%, #0c63d4 100%); color: white; border-radius: 50%;">#<%= index + 1 %></span>
              </div>

              <%# Content area %>
              <div class="post-card-content">
                <%# Header: Page name + Date %>
                <div class="post-card-header">
                  <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= post.page&.name || 'Unknown' %></div>
                  <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                  <div style="font-size: 6.5pt; color: #9ca3af;"><%= post.posted_at&.strftime("%d/%m/%Y") %></div>
                </div>

                <%# Message - truncated single line %>
                <% if post.message.present? %>
                  <p><%= post.message %></p>
                <% end %>

                <%# Metrics as inline text %>
                <div class="post-card-metrics">
                  <span><%= heroicon_svg(:heart, size: '12pt', color: '#ef4444') %> <strong><%= pdf_format_number(post.reactions_total_count) %></strong> reacciones</span>
                  <span>‚Ä¢</span>
                  <span><%= heroicon_svg(:chat_bubble_oval_left, size: '12pt', color: '#3b82f6') %> <strong><%= pdf_format_number(post.comments_count) %></strong> comentarios</span>
                  <span>‚Ä¢</span>
                  <span><%= heroicon_svg(:share, size: '12pt', color: '#10b981') %> <strong><%= pdf_format_number(post.share_count) %></strong> shares</span>
                  <% if post.views_count && post.views_count > 0 %>
                    <span>‚Ä¢</span>
                    <span><%= heroicon_svg(:eye, size: '12pt', color: '#6b7280') %> <strong><%= pdf_format_number(post.views_count) %></strong> vistas</span>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
    <% end %>

    <%# SLIDE 11: Top Posts Generales (P√°gina 2 - Posts 9-15) %>
    <% if @top_posts.present? && @top_posts.to_a.size > 8 %>
      <%= render 'shared/pdf_section_wrapper', section_id: 'section-11', force_new_page: true do %>
        <%= render 'shared/pdf_slide',
              slide_number: 11,
              title: "Posts con M√°s Interacciones",
              subtitle: "Contenido de Mayor Impacto (9-15)",
              report_type: :facebook,
              topic_name: @topic.name do %>

          <%# Lista vertical de posts (posts 9-15) %>
          <div style="display: flex; flex-direction: column;">
            <% @top_posts.drop(8).take(7).each_with_index do |post, index| %>
              <div class="post-card" style="background: white; border: 1pt solid #e5e7eb; border-radius: 6pt;">
                <%# Ranking badge %>
                <div>
                  <span style="background: linear-gradient(135deg, #1877f2 0%, #0c63d4 100%); color: white; border-radius: 50%;">#<%= index + 9 %></span>
                </div>

                <%# Content area %>
                <div class="post-card-content">
                  <%# Header: Page name + Date %>
                  <div class="post-card-header">
                    <div style="font-weight: 700; color: #1f2937; font-size: 8pt;"><%= post.page&.name || 'Unknown' %></div>
                    <div style="font-size: 6.5pt; color: #9ca3af;">‚Ä¢</div>
                    <div style="font-size: 6.5pt; color: #9ca3af;"><%= post.posted_at&.strftime("%d/%m/%Y") %></div>
                  </div>

                  <%# Message - truncated single line %>
                  <% if post.message.present? %>
                    <p><%= post.message %></p>
                  <% end %>

                  <%# Metrics as inline text %>
                  <div class="post-card-metrics">
                    <span><%= heroicon_svg(:heart, size: '12pt', color: '#ef4444') %> <strong><%= pdf_format_number(post.reactions_total_count) %></strong> reacciones</span>
                    <span>‚Ä¢</span>
                    <span><%= heroicon_svg(:chat_bubble_oval_left, size: '12pt', color: '#3b82f6') %> <strong><%= pdf_format_number(post.comments_count) %></strong> comentarios</span>
                    <span>‚Ä¢</span>
                    <span><%= heroicon_svg(:share, size: '12pt', color: '#10b981') %> <strong><%= pdf_format_number(post.share_count) %></strong> shares</span>
                    <% if post.views_count && post.views_count > 0 %>
                      <span>‚Ä¢</span>
                      <span><%= heroicon_svg(:eye, size: '12pt', color: '#6b7280') %> <strong><%= pdf_format_number(post.views_count) %></strong> vistas</span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    <% end %>

  </body>
</html>
