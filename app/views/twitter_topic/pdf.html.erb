<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Reporte Twitter: <%= @topic.name %> - Morfeo Analytics</title>
    <!-- Chartkick for Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartkick@4.2.0/dist/chartkick.min.js"></script>
    
    <%# Include professional PDF styles %>
    <%= render 'shared/pdf_professional_styles' %>
    
    <style>
      /* Twitter-specific PDF color overrides */
      h1, .pdf-page-title {
        color: #0ea5e9; /* Twitter blue */
      }
    </style>
  </head>
  <body>
    <div class="pdf-container">
      <% # Initialize Twitter Dashboard Presenter %>
      <% @presenter = TwitterDashboardPresenter.new(
            topic: @topic,
            total_posts: @total_posts,
            total_interactions: @total_interactions,
            total_views: @total_views,
            average_interactions: @average_interactions,
            chart_posts: @chart_posts,
            chart_interactions: @chart_interactions,
            tag_counts: @tag_counts,
            tag_interactions: @tag_interactions,
            profiles_count: @profiles_count,
            profiles_interactions: @profiles_interactions,
            top_posts: @top_posts,
            posts: @posts,
            word_occurrences: @word_occurrences,
            bigram_occurrences: @bigram_occurrences
          ) %>

      <!-- Header -->
      <div class="pdf-header">
        <h1>Reporte Twitter: <%= @topic.name %></h1>
        <p>Per√≠odo: <%= pdf_date_range(days_range: @days_range) %> | Generado: <%= Time.current.strftime("%d/%m/%Y %H:%M") %></p>
      </div>

      <!-- KPI Section (Refactored) -->
      <div class="pdf-section">
        <h2>M√©tricas Principales</h2>
        <%= render 'shared/pdf_kpis_grid', 
              metrics: build_pdf_kpi_metrics(@presenter, :twitter) %>
      </div>

      <!-- Main Charts Section (Refactored) -->
      <div class="pdf-section">
        <h2>An√°lisis Temporal de Tweets</h2>
        <%= render 'shared/pdf_charts_row', 
              charts: [
                build_pdf_chart_config(
                  title: I18n.t('twitter.charts.tweets_per_day'),
                  data: @chart_posts,
                  type: :column_chart,
                  xtitle: I18n.t('twitter.charts.date'),
                  ytitle: I18n.t('twitter.charts.tweets'),
                  colors: ['#0ea5e9']
                ),
                build_pdf_chart_config(
                  title: I18n.t('twitter.charts.interactions_per_day'),
                  data: @chart_interactions,
                  type: :column_chart,
                  xtitle: I18n.t('twitter.charts.date'),
                  ytitle: I18n.t('twitter.charts.interactions'),
                  colors: ['#10b981']
                )
              ] %>
      </div>

      <!-- Summary Section -->
      <div class="pdf-section">
        <div class="pdf-summary">
          <p>
            El t√≥pico <strong><%= @topic.name %></strong> en Twitter durante los √∫ltimos 
            <strong><%= @days_range %> d√≠as</strong> cuenta con un total de 
            <strong><%= @presenter.formatted_total_posts %></strong> tweets y gener√≥ un total de 
            <strong><%= @presenter.formatted_total_interactions %></strong> interacciones, 
            lo que nos da un promedio de 
            <strong><%= @presenter.formatted_average_interactions %></strong> interacciones por tweet.
          </p>
          <% if @presenter.has_views_data? %>
            <p class="mt-md">
              Los tweets alcanzaron un total de <strong><%= @presenter.formatted_total_views %></strong> visualizaciones,
              con una tasa de engagement del <strong><%= number_with_precision(@presenter.engagement_rate, precision: 2) %>%</strong>.
            </p>
          <% end %>
        </div>
      </div>

      <!-- Tags Analysis Section (Refactored) -->
      <% if @presenter.has_tag_data? %>
        <div class="pdf-section">
          <h2><%= I18n.t('twitter.tags.title') %></h2>
          <%= render 'shared/pdf_charts_row',
                charts: [
                  build_pdf_chart_config(
                    title: I18n.t('twitter.tags.tweets_by_tag'),
                    data: @presenter.tag_counts_chart_data,
                    type: :pie_chart,
                    donut: true,
                    colors: @presenter.chart_colors(:tag_counts)
                  ),
                  build_pdf_chart_config(
                    title: I18n.t('twitter.tags.interactions_by_tag'),
                    data: @tag_interactions,
                    type: :pie_chart,
                    donut: true,
                    colors: @presenter.chart_colors(:tag_interactions)
                  )
                ] %>
        </div>
      <% end %>

      <!-- Profiles Analysis Section (Refactored) -->
      <% if @presenter.has_profile_data? %>
        <div class="pdf-section break-before">
          <h2><%= I18n.t('twitter.profiles.title') %></h2>
          
          <!-- Profile Charts -->
          <%= render 'shared/pdf_charts_row',
                charts: [
                  build_pdf_chart_config(
                    title: I18n.t('twitter.profiles.tweets_by_profile'),
                    data: @profiles_count,
                    type: :pie_chart,
                    donut: true,
                    colors: @presenter.chart_colors(:profile_counts)
                  ),
                  build_pdf_chart_config(
                    title: I18n.t('twitter.profiles.interactions_by_profile'),
                    data: @profiles_interactions,
                    type: :pie_chart,
                    donut: true,
                    colors: @presenter.chart_colors(:profile_interactions)
                  )
                ] %>
          
          <!-- Top Profiles List -->
          <h3>Perfiles Destacados</h3>
          <div class="pdf-media-list">
            <% @profiles_count.take(12).each do |profile_name, count| %>
              <div class="pdf-media-item">
                <div class="pdf-media-name"><%= profile_name %></div>
                <div class="pdf-media-count">
                  <%= count %> tweets ¬∑ 
                  <%= pdf_format_number(@profiles_interactions[profile_name] || 0) %> interacciones
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Words Analysis Section -->
      <% if @presenter.has_word_cloud? || @presenter.has_bigram_data? %>
        <div class="pdf-section">
          <h2>An√°lisis de Palabras</h2>
          
          <% if @presenter.has_word_cloud? %>
            <h3>Palabras M√°s Frecuentes en Tweets</h3>
            <div class="pdf-words">
              <% @word_occurrences.take(50).each do |word, count| %>
                <span class="pdf-word"><%= word %> (<%= count %>)</span>
              <% end %>
            </div>
          <% end %>
          
          <% if @presenter.has_bigram_data? %>
            <h3>Bigramas M√°s Frecuentes</h3>
            <div class="pdf-words">
              <% @bigram_occurrences.take(30).each do |bigram, count| %>
                <span class="pdf-word"><%= bigram %> (<%= count %>)</span>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Top Posts Section -->
      <% if @presenter.has_top_posts? %>
        <div class="pdf-section break-before">
          <h2>Top Tweets con M√°s Interacciones</h2>
          <% @top_posts.take(10).each_with_index do |post, index| %>
            <div class="pdf-post-item">
              <div class="pdf-post-header">
                <span class="pdf-post-rank">#<%= index + 1 %></span>
                <span class="pdf-post-profile">@<%= post.twitter_profile&.username || 'unknown' %></span>
                <span class="pdf-post-date"><%= post.posted_at&.strftime("%d/%m/%Y") %></span>
                <span class="pdf-post-interactions">
                  <%= pdf_format_number(post.total_interactions) %> interacciones
                </span>
              </div>
              
              <% if post.text.present? %>
                <p class="pdf-post-text"><%= truncate(post.text, length: 300) %></p>
              <% end %>
              
              <div class="pdf-post-metrics">
                <span class="pdf-metric">‚ù§Ô∏è <strong><%= pdf_format_number(post.favorite_count) %></strong> Me gusta</span>
                <span class="pdf-metric">üîÑ <strong><%= pdf_format_number(post.retweet_count) %></strong> Retweets</span>
                <span class="pdf-metric">üí¨ <strong><%= pdf_format_number(post.reply_count) %></strong> Respuestas</span>
                <% if post.views_count && post.views_count > 0 %>
                  <span class="pdf-metric">üëÅÔ∏è <strong><%= pdf_format_number(post.views_count) %></strong> Vistas</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Footer -->
      <div class="pdf-report-footer">
        <span>Generado por Morfeo Analytics</span>
        <span><%= Time.current.strftime("%d/%m/%Y %H:%M") %></span>
        <span>Confidencial</span>
      </div>
    </div>
  </body>
</html>
