<header class="bg-white shadow-sm border-b border-gray-200">
  <div class="mx-auto px-4 py-6 sm:px-6 lg:px-8">
    <div class="md:flex md:items-center md:justify-between">
      <div class="flex-1 min-w-0">
        <h1 class="text-3xl font-bold text-gray-900 tracking-tight"><%=@tag.name%></h1>
        <p class="mt-1 text-sm text-gray-600">Análisis completo de la etiqueta - Últimos <%=DAYS_RANGE%> días</p>
      </div>
    </div>
  </div>
</header>
<main class="bg-gray-50 min-h-screen">
  <div class="mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- Análisis Temporal Section -->
    <section class="mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Análisis Temporal</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
        <!-- Chart Card 1: Entry Quantities -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow w-full">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">Notas por Día</h3>
            <div class="flex items-center text-sm text-gray-500">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              Últimos <%=DAYS_RANGE%> días
            </div>
          </div>
          <div class='w-full overflow-hidden'>
            <%= column_chart @entries.group_by_day(:published_at).count, xtitle: "Fecha", ytitle: "Cant. Notas", label: "Notas", colors: ['#3B82F6'], curve: false %>
          </div>
        </div>
        <!-- Chart Card 2: Interactions -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow w-full">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">Interacciones por Día</h3>
            <div class="flex items-center text-sm text-gray-500">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />
              </svg>
              Total de interacciones
            </div>
          </div>
          <div class='w-full overflow-hidden'>
            <%= column_chart @entries.group_by_day(:published_at).sum(:total_count), xtitle: "Fecha", ytitle: "Interacciones", label: "Interacciones", colors: ['#10B981'], curve: false %>
          </div>
        </div>
      </div>
    </section>
    <%if @tag.belongs_to_any_topic?%>
      <!-- Sentiment Analysis Section -->
      <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Análisis de Sentimiento</h2>
        <div>
          <dl class="mt-5 grid grid-cols-1 gap-5 sm:grid-cols-4">
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
              <dt class="truncate text-sm font-medium text-gray-500">Total Noticias</dt>
              <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900"><%=@entries.size%></dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
              <dt class="truncate text-sm font-medium text-gray-500">Total Positivas</dt>
              <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900"><%=@percentage_positives%>%</dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
              <dt class="truncate text-sm font-medium text-gray-500">Total Negativas</dt>
              <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900"><%=@percentage_negatives%>%</dd>
            </div>
            <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
              <dt class="truncate text-sm font-medium text-gray-500">Total Neutras</dt>
              <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900"><%=@percentage_neutrals%>%</dd>
            </div>
          </dl>
        </div>
      </section>
      <!-- Sentiment Trends Section -->
      <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Tendencias de Sentimiento</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow w-full">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Cantidad de Notas por Sentimiento</h3>
            <div class='w-full overflow-hidden'>
              <%= line_chart @entries.where.not(polarity: nil).group(:polarity).group_by_day(:published_at).count('*').sort_by { |key, _value| key }.to_h, xtitle: "Fecha", ytitle: "Cant. Notas", label: "Notas", stacked: false, curve: false, colors: ["#EF4444", "#9CA3AF", '#10B981'] %>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow w-full">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Cantidad de Interacciones por Sentimiento</h3>
            <div class='w-full overflow-hidden'>
              <%= line_chart @entries.where.not(polarity: nil).group(:polarity).group_by_day(:published_at).sum('total_count').sort_by { |key, _value| key }.to_h, xtitle: "Fecha", ytitle: "Cant. Interacciones", label: "Interacciones", stacked: false, curve: false, colors: ["#EF4444", "#9CA3AF", '#10B981'] %>
            </div>
          </div>
        </div>
      </section>
      <!-- Sentiment Distribution Section -->
      <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Distribución de Sentimiento</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow w-full">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Cantidad de Notas por Sentimiento</h3>
            <div class='w-full overflow-hidden'>
              <% polarities_counts = @entries.where.not(polarity: nil).group(:polarity).count('*').sort_by { |key, _value| key }.to_h %>
              <% total_count = polarities_counts.values.sum.to_f %>
              <% polarities_percentages = polarities_counts.transform_values { |count| (count / total_count * 100).round(0) } %>
              <%= pie_chart polarities_percentages, colors: ["#EF4444", "#9CA3AF", '#10B981'], donut: true, suffix: "%" %>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow w-full">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Cantidad de Interacciones por Sentimiento</h3>
            <div class='w-full overflow-hidden'>
              <% polarities_counts = @entries.where.not(polarity: nil).group(:polarity).sum('total_count').sort_by { |key, _value| key }.to_h %>
              <% total_count = polarities_counts.values.sum.to_f %>
              <% polarities_percentages = polarities_counts.transform_values { |count| (count / total_count * 100).round(0) } %>
              <%= pie_chart polarities_percentages, colors: ["#EF4444", "#9CA3AF", '#10B981'], donut: true, suffix: "%" %>
            </div>
          </div>
        </div>
      </section>
    <%end%>
    <!-- Media Impact Section -->
    <section class="mb-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Impacto de la Etiqueta</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
          <div class="hover:shadow-md transition-shadow w-full">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Cantidad de Notas por Medio</h3>
            <div class='w-full overflow-hidden'>
              <%= pie_chart @entries.group("sites.name").count, donut: true %>
            </div>
          </div>
          <div class="hover:shadow-md transition-shadow w-full">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Cantidad de Interacciones por Medio</h3>
            <div class='w-full overflow-hidden'>
              <%= pie_chart @entries.group("sites.name").sum(:total_count), donut: true %>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Summary Section -->
    <section class="mb-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Resumen Ejecutivo</h2>
        <div class="prose prose-gray max-w-none">
          <p>La etiqueta <b><%=@tag.name%></b> en los ultimos <b><%=DAYS_RANGE%> días</b> cuenta con un total de <b><%=number_with_delimiter(@total_entries, delimiter: ".")%></b> notas y genero un total de <b><%=number_with_delimiter(@total_interactions, delimiter: '.')%></b> interacciones, lo que nos da un promedio de <b><%=number_with_delimiter(@promedio, delimiter: '.')%></b> interacciones por nota.</p>
          <p>En contexto las <%=@top_entries.count%> notas con más interacciones en general, en el mismo periodo tuvieron <b><%=@top_entries.pluck(:total_count).join(', ')%></b> interacciones y las notas de la etiqueta <b><%=@most_interactions.take(5).pluck(:total_count).join(', ')%></b> interaciones </p>
        </div>
      </div>
    </section>
    <!-- Related Tags Analysis Section -->
    <section class="mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Análisis de Tags Relacionados</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow w-full">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Cantidad de Notas por Tag Relacionados</h3>
          <div class='w-full overflow-hidden'>
            <%= pie_chart @tags_count, donut: true %>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow w-full">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Cantidad de Interacciones por Tag Relacionados</h3>
          <div class='w-full overflow-hidden'>
            <%= pie_chart @tags_interactions, donut: true %>
          </div>
        </div>
      </div>
    </section>
    <!-- Media Sites Section -->
    <section class="mb-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Distribución por Medios</h2>
        <%= render partial: 'site/sites', locals: { sites: @entries.group("sites.id").count('*').sort_by { |site, count| -count }.take(10), title: 'Los medios que más han mencionado' } %>
      </div>
    </section>
    <!-- Latest News Section -->
    <section class="mb-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <%= render partial: 'entry/entries_table', locals: { entries: @entries, title: "Últimas Noticias sobre #{@tag.name}" } %>
      </div>
    </section>
    <!-- Word Cloud Section -->
    <section class="mb-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Nube de palabras de notas</h2>
        <div class="mt-6 mb-6 px-4 py-6">
          <%min_max = find_max_and_min_occurrences(@word_occurrences)%>
          <ul class="cloud">
            <%@word_occurrences.shuffle { |a, b| a[1] <=> b[1] }.each do |word, value|%>
              <li style='color: <%=word_color(@positive_words, @negative_words, word)%>' data-weight="<%=normalize_to_scale(value, min_max[:max], min_max[:min])%>"><%=word%></li>
            <%end%>
          </ul>
        </div>
      </div>
    </section>
    <%if @tag.belongs_to_any_topic? && @comments.any? %>
      <!-- Comments Word Cloud Section -->
      <section class="mb-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Nube de palabras de comentarios</h2>
          <div class="mt-6 mb-6 px-4 py-6">
            <%min_max = find_max_and_min_occurrences(@comments_word_occurrences)%>
            <ul class="cloud">
              <%@comments_word_occurrences.shuffle { |a, b| a[1] <=> b[1] }.each do |word, value|%>
                <li style='color: <%=word_color(@positive_words, @negative_words, word)%>' data-weight="<%=normalize_to_scale(value, min_max[:max], min_max[:min])%>"><%=word%></li>
              <%end%>
            </ul>
          </div>
        </div>
      </section>
    <%end%>
    <!-- Word Analysis Section -->
    <section class="mb-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Análisis de Palabras en Notas</h2>
        <%= render partial: "tag/tag_pill_array", collection: @word_occurrences %>
        <p><small class="text-gray-500 mt-4 block">*Cantidad de veces que aparecen las palabras en las notas</small></p>
      </div>
    </section>
    <!-- Bigram Analysis Section -->
    <section class="mb-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Análisis de Bigramas en Notas</h2>
        <%= render partial: "tag/tag_pill_array", collection: @bigram_occurrences %>
        <p><small class="text-gray-500 mt-4 block">*Cantidad de veces que aparecen bigramas en las notas</small></p>
      </div>
    </section>
    <%if @tag.belongs_to_any_topic? && @comments.any? %>
      <!-- Comments Analysis Section -->
      <section class="mb-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Análisis de Palabras en Comentarios</h2>
          <%= render partial: "tag/tag_pill_array", collection: @comments_word_occurrences %>
          <p><small class="text-gray-500 mt-4 block">*Cantidad de veces que aparecen las palabras en los comentarios</small></p>
          <div class="mt-4">
            <%=link_to 'Ver comentarios', tag_comments_path(@tag), class: 'rounded bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50' %>
          </div>
        </div>
      </section>
    <%end%>
    <!-- Top Interactions Section -->
    <section class="mb-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <%= render partial: 'entry/entries', locals: { last_entries: @most_interactions, title: 'Top Interacciones de la Etiqueta' } %>
      </div>
    </section>
    <% if @tags.any? %>
      <!-- Tag Appearances Section -->
      <section class="mb-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Aparición de Etiquetas</h2>
          <%= render partial: "tag/tag_pill", collection: @tags %>
          <p><small class="text-gray-500 mt-4 block">*Cantidad de veces que aparecen las etiquetas en las notas</small></p>
        </div>
      </section>
      <!-- Tag Interactions Section -->
      <section class="mb-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Interacciones de Etiquetas</h2>
          <%= render partial: "tag/tag_pill_interactions", collection: @tags.to_a.sort_by(&:interactions).reverse %>
          <p><small class="text-gray-500 mt-4 block">*Interacciones en las notas</small></p>
        </div>
      </section>
    <%end%>
  </div>
</main>
<script>
  function click_manager(object, event){
    console.log(event);
    if (event.point) {
      // You can access the clicked point's information here
      var seriesName = event.point.series.name;
      var category = event.point.category;
      var value = event.point.y;

      // Perform actions based on the clicked point's information
      console.log("Clicked on:", seriesName, "Category:", category, "Value:", value);
    }
  };

  function set_click_manager(){
    console.log('manager loaded...--');
    var chart = Chartkick.charts['chart-1'].getChartObject(); // Replace 'bar-chart-id' with the actual ID of your chart element
    chart.series[0].update({events:{click: function(event) { click_manager(this, event) } }});
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log('loaded...--');
    setTimeout(set_click_manager, 2000); // 5000 milliseconds = 5 seconds
  });
</script>
