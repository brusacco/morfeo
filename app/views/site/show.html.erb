<% content_for :extra_stylesheets do %>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    /* Hide scrollbar for Chrome, Safari and Opera */
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    /* Hide scrollbar for IE, Edge and Firefox */
    .scrollbar-hide {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    /* Ensure proper overflow for sticky to work */
    html, body {
      overflow-x: hidden;
      overflow-y: auto;
      height: 100%;
    }
    /* Smooth scroll behavior */
    html {
      scroll-behavior: smooth;
      scroll-padding-top: 4rem;
    }
    /* Ensure sticky navigation stays above all content */
    #site-nav {
      position: sticky;
      position: -webkit-sticky;
      top: 0;
      z-index: 9999;
      background: white;
      width: 100%;
    }
    /* Lower z-index for chart containers and all Highcharts elements */
    .chart-container, 
    .highcharts-container,
    .highcharts-container *,
    .highcharts-root,
    svg[class*="highcharts"],
    div[class*="w-full"][class*="overflow-hidden"] {
      z-index: 1 !important;
    }
    
    /* Ensure chart parent cards don't interfere */
    section .bg-white {
      isolation: auto;
    }
  </style>
<% end %>
<% content_for :extra_javascripts do %>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <%= javascript_include_tag 'datatables_config', 'data-turbo-track': 'reload' %>
<% end %>

<!-- Modern Header with Gradient -->
<header class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 text-white shadow-2xl">
  <div class="mx-auto px-4 py-10 sm:px-6 lg:px-8">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
      <div class="mb-4 lg:mb-0">
        <div class="flex items-center space-x-3 mb-2">
          <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-lg flex items-center justify-center">
            <i class="fa-solid fa-globe text-2xl"></i>
          </div>
          <div>
            <p class="text-sm text-indigo-100 mb-1">Análisis de Sitio Web</p>
            <h1 class="text-4xl font-bold tracking-tight"><%= @site.name %></h1>
          </div>
        </div>
        <% if @site.url.present? %>
          <a href="<%= @site.url %>" target="_blank" class="inline-flex items-center text-sm text-indigo-100 hover:text-white transition-colors">
            <i class="fa-solid fa-external-link-alt mr-2"></i>
            <%= @site.url %>
          </a>
        <% end %>
      </div>
      
      <!-- Stats Cards -->
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
          <p class="text-xs text-indigo-100 mb-1">Total Notas</p>
          <p class="text-3xl font-bold"><%= @entries.count %></p>
        </div>
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
          <p class="text-xs text-indigo-100 mb-1">Interacciones</p>
          <p class="text-3xl font-bold"><%= number_with_delimiter(@entries.sum(:total_count)) %></p>
        </div>
      </div>
    </div>
    
    <!-- Period Badge -->
    <div class="inline-flex items-center px-4 py-2 bg-white/20 backdrop-blur-sm rounded-lg border border-white/30">
      <i class="fa-solid fa-calendar-days mr-2"></i>
      <span class="font-medium">Últimos <%= DAYS_RANGE %> días</span>
    </div>
  </div>
</header>

<!-- Sticky Navigation -->
<nav id="site-nav" class="border-b border-gray-200 shadow-md bg-white">
  <div class="mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-12">
      <div class="flex space-x-1 overflow-x-auto scrollbar-hide">
        <a href="#charts" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors whitespace-nowrap">
          <i class="fa-solid fa-chart-line mr-2"></i>
          Tendencias
        </a>
        <a href="#entries" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-orange-600 hover:bg-orange-50 rounded-md transition-colors whitespace-nowrap">
          <i class="fa-solid fa-newspaper mr-2"></i>
          Noticias
        </a>
        <a href="#top-content" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-amber-600 hover:bg-amber-50 rounded-md transition-colors whitespace-nowrap">
          <i class="fa-solid fa-trophy mr-2"></i>
          Top
        </a>
        <a href="#palabras" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors whitespace-nowrap">
          <i class="fa-solid fa-spell-check mr-2"></i>
          Palabras
        </a>
        <a href="#bigramas" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors whitespace-nowrap">
          <i class="fa-solid fa-comments mr-2"></i>
          Bigramas
        </a>
      </div>
      <a href="#" id="backToTop" class="ml-4 inline-flex items-center px-3 py-2 text-sm font-medium text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-md transition-colors cursor-pointer whitespace-nowrap">
        <i class="fa-solid fa-arrow-up mr-2"></i>
        Arriba
      </a>
    </div>
  </div>
</nav>

<main class="bg-gray-50">
  <div class="mx-auto py-8 px-4 sm:px-6 lg:px-8">
    
    <!-- Charts Section -->
    <section id="charts" class="mb-8 scroll-mt-16">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">
        <i class="fa-solid fa-chart-line text-indigo-600 mr-2"></i>
        Análisis Temporal
      </h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Notes Chart -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-lg hover:border-indigo-200 transition-all duration-200">
          <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fa-solid fa-file-lines text-blue-600 mr-2"></i>
            Cantidad de Notas por Día
          </h3>
          <%= column_chart @entries_stats.count, 
              xtitle: "Fecha", 
              ytitle: "Cantidad", 
              colors: ['#3B82F6'],
              library: {
                chart: { height: 300 },
                plotOptions: {
                  column: { dataLabels: { enabled: false } }
                }
              } %>
        </div>
        
        <!-- Interactions Chart -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-lg hover:border-green-200 transition-all duration-200">
          <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fa-solid fa-heart text-green-600 mr-2"></i>
            Interacciones por Día
          </h3>
          <%= column_chart @entries_stats.sum(:total_count), 
              xtitle: "Fecha", 
              ytitle: "Interacciones", 
              colors: ['#10B981'],
              library: {
                chart: { height: 300 },
                plotOptions: {
                  column: { dataLabels: { enabled: false } }
                }
              } %>
        </div>
      </div>
    </section>

    <!-- Entries Table Section -->
    <section id="entries" class="scroll-mt-16">
      <%= render partial: 'entry/entries_table', locals: { entries: @entries, title: "Todas las publicaciones de #{@site.name}" } %>
    </section>

    <!-- Top Performing Content Section -->
    <section id="top-content" class="mb-8 scroll-mt-16">
      <%= render partial: 'entry/entries', locals: { last_entries: @entries.order(total_count: :desc).limit(20).includes(:tags, :site), title: 'Publicaciones con más interacciones' } %>
    </section>

    <!-- Word Analysis Section -->
    <section id="palabras" class="mb-8 scroll-mt-16">
      <%= render partial: "tag/word_cloud_modern", 
                 locals: { 
                   title: "Análisis de Palabras",
                   icon: "fa-spell-check",
                   icon_color: "text-green-600",
                   word_data: @word_occurrences,
                   description: "Análisis de frecuencia de palabras clave que aparecen en los títulos y contenido de las noticias"
                 } %>
    </section>

    <!-- Bigrams Analysis Section -->
    <section id="bigramas" class="mb-8 scroll-mt-16">
      <%= render partial: "tag/word_cloud_modern", 
                 locals: { 
                   title: "Análisis de Bigramas",
                   icon: "fa-comments",
                   icon_color: "text-blue-600",
                   word_data: @bigram_occurrences,
                   description: "Análisis de pares de palabras consecutivas (bigramas) más frecuentes en el contenido"
                 } %>
    </section>

  </div>
</main>

<script>
  // Back to Top functionality
  function initBackToTop() {
    const backToTopBtn = document.getElementById('backToTop');
    if (!backToTopBtn) return;
    
    if (backToTopBtn.dataset.initialized === 'true') return;
    backToTopBtn.dataset.initialized = 'true';
    
    backToTopBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBackToTop);
  } else {
    initBackToTop();
  }
  
  document.addEventListener('turbo:load', initBackToTop);
</script>
